
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - ZNHS West</title>
    {% load static %}
    <!-- Use static tag for CSS -->
    <link rel="stylesheet" href="{% static 'admin_functionalities/css/admin.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body>
    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <img src="{% static 'admin_functionalities/assets/westLogo.png' %}" alt="ZNHS West Logo" class="sidebar-logo" />
                    <span class="sidebar-title">ZNHS WEST</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-item active">
                        <a href="{% url 'admin_functionalities:admin-dashboard' %}" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'admin_functionalities:sections' %}" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span>Sections</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'admin_functionalities:teachers' %}" class="nav-link">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Teachers</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'admin_functionalities:enrollment' %}" class="nav-link">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Enrollment</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'admin_functionalities:settings' %}" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <!-- Logout link -->
                <a href="{% url 'enrollmentprocess:logout' %}" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="dashboard-header">
                <div class="header-left">
                    <h1>Admin Dashboard</h1>
                    <p id="dashboardDate"></p>
                </div>
                <div class="header-right">
                    <div class="header-filter-container">
                        <label for="gradeLevelFilter">Grade Level:</label>
                        <select id="gradeLevelFilter">
                            <option value="all">All</option>
                            <option value="grade7">Grade 7</option>
                            <option value="grade8">Grade 8</option>
                            <option value="grade9">Grade 9</option>
                            <option value="grade10">Grade 10</option>
                        </select>
                    </div>
                    <div class="header-filter-container">
                        <label for="schoolYearFilter">School Year:</label>
                        <select id="schoolYearFilter">
                            <option value="2025-2026">2025-2026</option>
                            <option value="2024-2025">2024-2025</option>
                        </select>
                    </div>

                    <!-- admin profile section  -->
                    <div class="admin-profile">
                        <div class="profile-info">
                            <span class="admin-name">Samson, Marwina D.</span>
                            <span class="admin-role">Admin</span>
                        </div>
                        <div class="profile-avatar">
                            <img src="{% static 'admin_functionalities/assets/spongebob.jpg' %}" alt="Admin" class="avatar-img" />
                        </div>
                    </div>
                </div>
            </header>

            <section class="dashboard-content">
                <section class="enrollment-requests">
    <div class="enrollment-header">
        <i class="fas fa-bell enrollment-bell"></i>
        <h2>New Enrollment Submissions</h2>
        {% if total_unread > 0 %}
            <span class="notification-badge">{{ total_unread }}</span>
        {% endif %}
    </div>

    <div class="enrollment-cards">
        {% for notification in notifications %}
<div class="enrollment-card student-notification"
             data-ids="{{ notification.notification_ids|join:',' }}"
             data-program-slug="{{ notification.program_slug }}"
             title="{{ notification.sample_message }}"
             onclick="openNotification(this)">
            <i class="{{ notification.icon }} enrollment-icon"></i>
            <span class="enrollment-text">{{ notification.message }}</span>
        </div>
        {% empty %}
            <div class="enrollment-card no-notifications">
                <i class="fas fa-check-circle enrollment-icon"></i>
                <span class="enrollment-text">No new confirmed submissions.</span>
            </div>
        {% endfor %}
    </div>
</section>


                <!-- Quick Statistics Section -->
                <section class="card quick-statistics">
                    <div class="card-header">
                        <h2>Quick Statistics</h2>
                    </div>
                    <div class="statistics-grid">
                        <div class="stat-item">
                            <div class="stat-icon"><i class="fas fa-chalkboard-teacher"></i></div>
                            <div class="stat-text">
                                <h3>{{ total_teachers }}</h3>
                                <p>Total Teachers</p>
                            </div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-icon"><i class="fas fa-user-graduate"></i></div>
                            <div class="stat-text">
                                <h3>{{ total_students }}</h3>
                                <p>Total Students</p>
                            </div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
                            <div class="stat-text">
                                <h3>{{ total_programs }}</h3>
                                <p>Total Programs</p>
                            </div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-icon"><i class="fas fa-school"></i></div>
                            <div class="stat-text">
                                <h3>{{ total_sections }}</h3>
                                <p>Total Sections</p>
                            </div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-icon"><i class="fas fa-book"></i></div>
                            <div class="stat-text">
                                <h3>{{ grade7_students }}</h3>
                                <p>Grade 7 Students</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Programs Section -->
                <section class="card programs-overview">
                    <div class="card-header">
                        <h2>Programs Overview</h2>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Program</th>
                                <th>Total applicants</th>
                                <th>Approved</th>
                                <th>Pending</th>
                                <th>Rejected</th>
                                <th>Number of Section</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prog in program_data %}
                            <tr class="program-row" data-program="{{ prog.program }}">
                                <td class="program-name">
                                    <span class="program-indicator {{ prog.program|lower }}"></span>
                                    {{ prog.program }}
                                </td>
                                <td>{{ prog.total_applicants }}</td>
                                <td>{{ prog.approved }}</td>
                                <td>{{ prog.pending }}</td>
                                <td>{{ prog.rejected }}</td>
                                <td>{{ prog.num_sections }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" style="text-align:center;">No data available</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    
                </section>
            </section>
                </section>
            </section>
        </main>
    </div>
{% comment %} <script>
    // Django URLs (server-rendered)
    const MARK_READ_URL = "{% url 'admin_functionalities:mark_notification_read' %}";
    const ENROLLMENT_URL = "{% url 'admin_functionalities:enrollment' %}";

    // getCookie for CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // openNotification function (with debug logs)
    function openNotification(element) {
        console.log('=== CLICK DEBUG START ===');
        console.log('Program slug:', element.dataset.programSlug);  // Should log 'ste', etc.
        console.log('Raw IDs:', element.dataset.ids);  // Should log '1,2,3,...'
        
        const ids = element.dataset.ids.split(',').filter(id => id.trim());
        const programSlug = element.dataset.programSlug;
        if (!ids.length) {
            console.error('No valid IDs found');
            alert('No notifications to mark – refresh page');
            return;
        }
        
        console.log('Sending POST to:', MARK_READ_URL);
        console.log('With IDs:', ids);
        
        fetch(MARK_READ_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ ids: ids })
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                // Hide card
                element.style.opacity = '0';
                setTimeout(() => {
                    element.remove();
                    console.log('Card hidden and removed');
                }, 300);
                
                // Redirect (filtered if program_slug present)
                const redirectTo = programSlug ? `${ENROLLMENT_URL}?program=${programSlug}` : ENROLLMENT_URL;
                console.log('Redirecting to:', redirectTo);
                window.location.href = redirectTo;
                
                // Update badge
                const badge = document.querySelector('.notification-badge');
                if (badge) {
                    let count = parseInt(badge.textContent) - (data.marked || ids.length);
                    if (count <= 0) {
                        badge.style.display = 'none';  // Or badge.remove()
                    } else {
                        badge.textContent = count;
                    }
                    console.log('Badge updated to:', count);
                }
            } else {
                console.error('API failed:', data.error);
                alert('Error marking as read: ' + (data.error || 'Unknown'));
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('Request failed: ' + error.message + '\nCheck browser console.');
        });
        console.log('=== CLICK DEBUG END ===');
    }
</script> {% endcomment %}
{% comment %} <script>
    // Django URLs (server-rendered)
    const MARK_READ_URL = "{% url 'admin_functionalities:mark_notification_read' %}";
    const ENROLLMENT_URL = "{% url 'admin_functionalities:enrollment' %}";
    const SECTIONS_URL = "{% url 'admin_functionalities:sections' %}";  // ✅ Correct dynamic path

    // getCookie for CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // openNotification function (kept untouched)
    function openNotification(element) {
        const ids = element.dataset.ids.split(',').filter(id => id.trim());
        const programSlug = element.dataset.programSlug;
        if (!ids.length) {
            alert('No notifications to mark – refresh page');
            return;
        }
        
        fetch(MARK_READ_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ ids: ids })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                element.remove();
                const redirectTo = programSlug ? `${ENROLLMENT_URL}?program=${programSlug}` : ENROLLMENT_URL;
                window.location.href = redirectTo;
            } else {
                alert('Error marking as read: ' + (data.error || 'Unknown'));
            }
        })
        .catch(error => alert('Request failed: ' + error.message));
    }

    // ✅ New: Clickable program rows redirect correctly to sections page
    document.querySelectorAll(".program-row").forEach(row => {
        row.addEventListener("click", () => {
            const program = row.dataset.program;
            if (program) {
                window.location.href = `${SECTIONS_URL}?program=${program}`;  // ✅ Correct dynamic Django-safe path
            }
        });
    });
</script>

<script>
// Pass Django URL to JS (global variable for admin.js)
window.logoutUrl = "{% url 'enrollmentprocess:logout' %}";  // '/logout/'
</script>
<script>
    // ✅ Define Django-safe base URL for Sections page
    const SECTIONS_URL = "{% url 'admin_functionalities:sections' %}";
</script>
<script>
document.querySelectorAll(".program-row").forEach(row => {
    row.addEventListener("click", () => {
        const program = row.dataset.program;
        if (program) {
            // ✅ Use Django-safe dynamic URL for redirection
            window.location.href = `${SECTIONS_URL}?program=${program}`;
        }
    });
});
</script> {% endcomment %}
<script>
    // === Django URLs (server-rendered) ===
    const MARK_READ_URL = "{% url 'admin_functionalities:mark_notification_read' %}";
    const ENROLLMENT_URL = "{% url 'admin_functionalities:enrollment' %}";
    const SECTIONS_URL = "{% url 'admin_functionalities:sections' %}";
    window.logoutUrl = "{% url 'enrollmentprocess:logout' %}";  // Global for admin.js

    // === getCookie for CSRF ===
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // === openNotification (untouched logic) ===
    function openNotification(element) {
        const ids = element.dataset.ids.split(',').filter(id => id.trim());
        const programSlug = element.dataset.programSlug;
        if (!ids.length) {
            alert('No notifications to mark – refresh page');
            return;
        }

        fetch(MARK_READ_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ ids: ids })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                element.remove();
                const redirectTo = programSlug ? `${ENROLLMENT_URL}?program=${programSlug}` : ENROLLMENT_URL;
                window.location.href = redirectTo;
            } else {
                alert('Error marking as read: ' + (data.error || 'Unknown'));
            }
        })
        .catch(error => alert('Request failed: ' + error.message));
    }

    // ✅ Proper redirection to sections page (Django-safe)
    document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll(".program-row").forEach(row => {
        row.addEventListener("click", () => {
            const program = row.dataset.program;
            if (program) {
                // ✅ Use Django URL resolver (absolute path)
                window.location.href = `${SECTIONS_URL}?program=${encodeURIComponent(program)}`;
            }
        });
    });
});
</script>

<script src="{% static 'admin_functionalities/js/admin.js' %}"></script>
</body>

</html>
