<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile Settings â€” Teacher</title>
  {% load static %}
  <!-- Tailwind + FontAwesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --sidebar-w: 240px;
      --accent: #a23131;
      --accent-dark: #872626;
      --muted: #6b7280;
      --card-bg: #ffffff;
      --radius: 10px;
      --shadow: 0 6px 18px rgba(16,24,40,0.06);
      --section-pink: #efc9c9;
      --section-border: #f3e8e8;
    }

    * { box-sizing: border-box }
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: #f4f6f8;
      color: #0f172a;
      -webkit-font-smoothing: antialiased;
    }

    /* Sidebar placeholder (unchanged) */
    #sidebar-root { position: fixed; left: 0; top: 0; z-index: 60; }

    main {
      margin-left: var(--sidebar-w);
      padding: 28px;
      transition: margin-left 180ms ease;
    }
    @media (max-width:860px) { main { margin-left: 72px; padding: 18px } }

    .container { max-width: 1100px; margin: 0 auto; }

    /* Page Header */
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
    .page-title { font-size:1.6rem; font-weight:800; letter-spacing: -0.4px; }
    .greeting { color:var(--muted); font-size:0.95rem; }

    /* Cards */
    .card { background:var(--card-bg); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid rgba(15,23,42,0.04); overflow:hidden; }
    .section-header {
      background: var(--section-pink);
      padding:12px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--section-border);
    }
    .section-title { font-weight:800; color:#3a1b1b; font-size:1.05rem; }
    .section-body { padding:18px; }

    .small-update {
      background: #ff9f9f;
      color: #6b0b0b;
      border-radius:8px;
      padding:6px 10px;
      font-weight:700;
      font-size:0.78rem;
      border: 1px solid rgba(0,0,0,0.04);
      cursor: pointer;
    }

    /* Teacher Layout */
    .teacher-layout { display:flex; gap:24px; flex-wrap:wrap; align-items:flex-start; }
    /* ENLARGED PHOTO */
    .photo-box {
      width:220px; height:240px; border-radius:8px; background:#fff; border:2px solid #eee; padding:6px; text-align:center; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .photo-box img { width:100%; height:100%; object-fit:cover; border-radius:6px; display:block; }

    .teacher-details { flex:1; min-width:320px; }
    .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:8px 18px; align-items:start; }
    @media (max-width:860px) { .two-col { grid-template-columns: 1fr } }

    .detail-label { font-weight:800; color:#111827; font-size:0.92rem; margin-bottom:6px }
    .detail-value { color:var(--muted); font-size:0.92rem; }

    /* Contact box */
    .contact-body { background:#fff; padding:18px; border-radius:8px; border:1px solid #f1eaea; }

    /* Table styles (teaching load & history) */
    table { width:100%; border-collapse:collapse; background:#fff; }
    thead th { text-align:left; padding:10px 12px; font-weight:800; background:transparent; color:#111827; border-bottom:1px solid #e9e2e2 }
    tbody td { padding:12px; border-bottom:1px solid #f3e3e3; color:var(--muted) }
    .table-wrap { overflow-x:auto; }

    .section-sub {
      background: linear-gradient(90deg, rgba(162,49,49,0.06), rgba(255,255,255,0));
      padding:10px 14px; border-radius:6px; margin-top:14px;
      font-weight:700; color: #2a1a1a;
      text-align:center;
    }

    .change-history-title { text-align:center; font-weight:800; padding:8px 0; color:#3a1b1b; }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center;
      z-index: 80; opacity:0; pointer-events:none; transition: opacity .18s ease;
    }
    .modal-backdrop.show { opacity:1; pointer-events:auto; }
    .modal {
      background: white; width: 720px; max-width:95%; border-radius:12px; padding:18px; box-shadow: var(--shadow);
    }
    .modal h3 { font-weight:800; margin-bottom:8px; color:#111827 }
    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width:640px) { .form-grid { grid-template-columns: 1fr } }
    .form-group label { font-weight:700; font-size:0.9rem; margin-bottom:6px; display:block }
    .form-group input, .form-group select { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e6e6e6; background:#fff }

    .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }

    .btn { padding:8px 12px; border-radius:8px; cursor:pointer; border:0; font-weight:700 }
    .btn-primary { background:var(--accent); color:white }
    .btn-ghost { background:#fff; border:1px solid #e6e6e6; color:#111827 }

    .hidden { display:none !important }

    .toast {
      position:fixed; right:20px; bottom:20px; background:#16a34a; color:#fff; padding:10px 16px; border-radius:8px;
      box-shadow: var(--shadow); opacity:0; transform: translateY(10px); transition: all .25s ease;
    }
    .toast.show { opacity:1; transform:none }
  </style>
</head>
<body>
  <div id="sidebar-root">
     {% include 'teacher/subjectteacher/sidebar.html' %}
    </div>

  <main>
    <div class="container">
      <header class="header">
        <div>
          <div class="page-title">Profile Settings</div>
          <div id="greeting" class="greeting">Good afternoon, Salatan</div>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-right">
            <div class="font-bold">Salatan, Juliana Mae E.</div>
            <div class="text-sm text-gray-500">Adviser</div>
          </div>
          <div class="w-11 h-11 rounded-full overflow-hidden border-2 border-white">
            <img id="top-avatar" src="logo/miming.jfif" alt="Adviser" class="w-full h-full object-cover"
              onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'bg-red-700 text-white flex items-center justify-center w-full h-full font-bold\'>S</div>'">
          </div>
        </div>
      </header>

      <!-- Back -->
      <div class="mb-4">
        <button onclick="history.back()" class="flex items-center gap-2 text-red-700 font-semibold hover:text-red-900 transition">
          <i class="fa-solid fa-arrow-left"></i> Back
        </button>
      </div>

      <!-- Teacher Data -->
      <section class="card">
        <div class="section-header">
          <div class="section-title">Teacher Data</div>
          <button id="open-teacher-modal" class="small-update" aria-haspopup="dialog">Update Data</button>
        </div>

        <div class="section-body">
          <div class="teacher-layout">
            <!-- Photo -->
            <div class="photo-box">
              <img id="teacher-photo" src="Pictures/teacher-sample.jpg" alt="Teacher Photo"
                onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'bg-red-700 text-white font-bold flex items-center justify-center w-full h-full rounded\'>T</div>'">
            </div>

            <!-- Details -->
            <div class="teacher-details">
              <div class="two-col">
                <div>
                  <div class="detail-label">Employee ID</div>
                  <div class="detail-value" data-key="employee_id">12345678913</div>
                </div>

                <div>
                  <div class="detail-label">Position</div>
                  <div class="detail-value" data-key="position">Teacher - I</div>
                </div>

                <div>
                  <div class="detail-label">Last Name</div>
                  <div class="detail-value" data-key="lastname">Ackerman</div>
                </div>

                <div>
                  <div class="detail-label">Department</div>
                  <div class="detail-value" data-key="department">Science</div>
                </div>

                <div>
                  <div class="detail-label">First Name</div>
                  <div class="detail-value" data-key="firstname">Mikasa</div>
                </div>

                <div>
                  <div class="detail-label">Gender</div>
                  <div class="detail-value" data-key="gender">Female</div>
                </div>

                <div>
                  <div class="detail-label">Middle Name</div>
                  <div class="detail-value" data-key="middlename">Ambot</div>
                </div>

                <div>
                  <div class="detail-label">Date of Birth</div>
                  <div class="detail-value" data-key="dob">June 01, 2000</div>
                </div>

                <div>
                  <div class="detail-label">Age</div>
                  <div class="detail-value" data-key="age">25</div>
                </div>

                <div>
                  <div class="detail-label">Employment Status</div>
                  <div class="detail-value" data-key="employment_status">Permanent</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Contact Data -->
      <section class="card mt-6">
        <div class="section-header">
          <div class="section-title">Contact Data</div>
          <button id="open-contact-modal" class="small-update">Update Data</button>
        </div>

        <div class="section-body">
          <div class="contact-body">
            <div class="grid md:grid-cols-3 gap-4">
              <div>
                <div class="detail-label">Email</div>
                <div class="detail-value" data-key="email">mikasasackerman@deped.gov</div>
              </div>
              <div>
                <div class="detail-label">Phone</div>
                <div class="detail-value" data-key="phone">+63 912 345 6789</div>
              </div>
              <div>
                <div class="detail-label">Address</div>
                <div class="detail-value" data-key="address">Eden</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Teaching Load -->
      <section class="card mt-6">
        <div class="section-header">
          <div class="section-title">Teaching Load (Handled Classes)</div>
          <div></div>
        </div>

        <div class="section-body">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:45%">Subject</th>
                  <th style="width:40%">Grade & Section</th>
                  <th style="width:15%">Number of Students</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Physics</td>
                  <td>Grade 9 â€“ St. Anne</td>
                  <td>45</td>
                </tr>
                <tr>
                  <td>Science</td>
                  <td>Grade 8 â€“ St. John</td>
                  <td>50</td>
                </tr>
                <tr>
                  <td>Science (Lab)</td>
                  <td>Grade 8 â€“ St. John</td>
                  <td>50</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Change History -->
      <section class="card mt-6">
        <div class="section-header" style="flex-direction:column; align-items:stretch; gap:8px;">
          <div class="section-title" style="text-align:center;">Change History</div>
        </div>

        <div class="section-body">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:50%">Actions</th>
                  <th style="width:25%">Date</th>
                  <th style="width:25%">Time</th>
                </tr>
              </thead>
              <tbody id="history-body">
                <tr>
                  <td>Record Created</td>
                  <td>07/09/2025</td>
                  <td>10:30 am</td>
                </tr>
                <tr>
                  <td>Updated Profile</td>
                  <td>07/09/2025</td>
                  <td>10:30 am</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal: Teacher Personal -->
  <div id="modal-teacher" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <h3>Edit Teacher Details</h3>
      <p class="text-sm text-gray-600 mb-4">Update the teacher's personal information. Changes will reflect immediately after saving.</p>

      <div class="grid md:grid-cols-3 gap-4 mb-4">
        <div class="col-span-1">
          <div class="detail-label mb-2">Photo Preview</div>
          <div style="width:100%;height:160px;border:1px solid #eee;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center">
            <img id="photo-preview" src="Pictures/teacher-sample.jpg" style="width:100%;height:100%;object-fit:cover" alt="preview"
              onerror="this.style.display='none'">
          </div>
          <div class="mt-2">
            <input id="teacher-photo-input" type="file" accept="image/*" class="mt-2 text-sm">
          </div>
        </div>

        <div class="col-span-2">
          <div class="form-grid">
            <div class="form-group">
              <label for="inp-employee-id">Employee ID</label>
              <input id="inp-employee-id" type="text" />
            </div>
            <div class="form-group">
              <label for="inp-position">Position</label>
              <input id="inp-position" type="text" />
            </div>

            <div class="form-group">
              <label for="inp-lastname">Last Name</label>
              <input id="inp-lastname" type="text" />
            </div>
            <div class="form-group">
              <label for="inp-department">Department</label>
              <input id="inp-department" type="text" />
            </div>

            <div class="form-group">
              <label for="inp-firstname">First Name</label>
              <input id="inp-firstname" type="text" />
            </div>
            <div class="form-group">
              <label for="inp-gender">Gender</label>
              <select id="inp-gender">
                <option>Female</option>
                <option>Male</option>
                <option>Other</option>
              </select>
            </div>

            <div class="form-group">
              <label for="inp-middlename">Middle Name</label>
              <input id="inp-middlename" type="text" />
            </div>
            <div class="form-group">
              <label for="inp-dob">Date of Birth</label>
              <input id="inp-dob" type="date" />
            </div>

            <div class="form-group">
              <label for="inp-age">Age</label>
              <input id="inp-age" type="number" min="0" />
            </div>
            <div class="form-group">
              <label for="inp-employment-status">Employment Status</label>
              <input id="inp-employment-status" type="text" />
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('teacher')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTeacherChanges()">Save changes</button>
      </div>
    </div>
  </div>

  <!-- Modal: Contact -->
  <div id="modal-contact" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <h3>Edit Contact Details</h3>
      <p class="text-sm text-gray-600 mb-4">Update contact information.</p>

      <div class="form-grid">
        <div class="form-group">
          <label for="inp-email">Email</label>
          <input id="inp-email" type="email" />
        </div>
        <div class="form-group">
          <label for="inp-phone">Phone</label>
          <input id="inp-phone" type="text" />
        </div>
        <div class="form-group">
          <label for="inp-address">Address</label>
          <input id="inp-address" type="text" />
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('contact')">Cancel</button>
        <button class="btn btn-primary" onclick="saveContactChanges()">Save</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved</div>

  <script>
    // Greeting date (keeps same approach but shows long date like screenshot)
    (function(){
      const g = document.getElementById('greeting');
      const d = new Date();
      g.textContent = d.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    })();

    // Modal helpers
    function openModal(type){
      const mb = document.getElementById('modal-' + type);
      if (!mb) return;
      // populate modal fields with existing values
      if (type === 'teacher') populateTeacherModal();
      if (type === 'contact') populateContactModal();
      mb.classList.add('show');
      mb.setAttribute('aria-hidden','false');
    }
    function closeModal(type){
      const mb = document.getElementById('modal-' + type);
      if (!mb) return;
      mb.classList.remove('show');
      mb.setAttribute('aria-hidden','true');
      // reset file input preview if needed - do not auto clear to avoid data loss
    }

    // Wire open buttons
    document.getElementById('open-teacher-modal').addEventListener('click', ()=> openModal('teacher'));
    document.getElementById('open-contact-modal').addEventListener('click', ()=> openModal('contact'));

    // Photo preview handling
    const photoInput = document.getElementById('teacher-photo-input');
    const photoPreview = document.getElementById('photo-preview');
    const teacherPhotoMain = document.getElementById('teacher-photo');

    photoInput.addEventListener('change', function(e){
      const f = this.files && this.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        photoPreview.src = ev.target.result;
      }
      reader.readAsDataURL(f);
    });

    // Populate teacher modal from current view values
    function populateTeacherModal(){
      document.getElementById('inp-employee-id').value = getText('[data-key="employee_id"]');
      document.getElementById('inp-position').value = getText('[data-key="position"]');
      document.getElementById('inp-lastname').value = getText('[data-key="lastname"]');
      document.getElementById('inp-department').value = getText('[data-key="department"]');
      document.getElementById('inp-firstname').value = getText('[data-key="firstname"]');
      document.getElementById('inp-gender').value = getText('[data-key="gender"]') || 'Female';
      document.getElementById('inp-middlename').value = getText('[data-key="middlename"]');
      // convert display dob (like "June 01, 2000") to yyyy-mm-dd if possible
      const dobText = getText('[data-key="dob"]');
      let dd = '';
      if (dobText) {
        const parsed = new Date(dobText);
        if (!isNaN(parsed)) {
          dd = parsed.toISOString().slice(0,10);
        } else {
          // if not parseable, leave empty
          dd = '';
        }
      }
      document.getElementById('inp-dob').value = dd;
      document.getElementById('inp-age').value = getText('[data-key="age"]');
      document.getElementById('inp-employment-status').value = getText('[data-key="employment_status"]');

      // preview current photo
      if (teacherPhotoMain && teacherPhotoMain.src) {
        photoPreview.src = teacherPhotoMain.src;
      }
      // clear file input
      photoInput.value = '';
    }

    function populateContactModal(){
      document.getElementById('inp-email').value = getText('[data-key="email"]');
      document.getElementById('inp-phone').value = getText('[data-key="phone"]');
      document.getElementById('inp-address').value = getText('[data-key="address"]');
    }

    // utils
    function getText(selector){
      const el = document.querySelector(selector);
      return el ? el.textContent.trim() : '';
    }
    function setText(selector, value){
      const el = document.querySelector(selector);
      if (el) el.textContent = value ?? '';
    }

    // Saving changes
    function saveTeacherChanges(){
      // update text fields
      setText('[data-key="employee_id"]', document.getElementById('inp-employee-id').value);
      setText('[data-key="position"]', document.getElementById('inp-position').value);
      setText('[data-key="lastname"]', document.getElementById('inp-lastname').value);
      setText('[data-key="department"]', document.getElementById('inp-department').value);
      setText('[data-key="firstname"]', document.getElementById('inp-firstname').value);
      setText('[data-key="gender"]', document.getElementById('inp-gender').value);
      setText('[data-key="middlename"]', document.getElementById('inp-middlename').value);

      // Date formatting: if date provided, format to readable string
      const dobVal = document.getElementById('inp-dob').value;
      if (dobVal) {
        const d = new Date(dobVal);
        if (!isNaN(d)) {
          const opts = { year:'numeric', month:'long', day:'2-digit' };
          setText('[data-key="dob"]', d.toLocaleDateString('en-US', opts));
        } else {
          setText('[data-key="dob"]', dobVal);
        }
      } else {
        setText('[data-key="dob"]', '');
      }

      setText('[data-key="age"]', document.getElementById('inp-age').value);
      setText('[data-key="employment_status"]', document.getElementById('inp-employment-status').value);

      // Update photo if a new file selected (use preview image src)
      const f = photoInput.files && photoInput.files[0];
      if (f) {
        const reader = new FileReader();
        reader.onload = function(ev){
          teacherPhotoMain.src = ev.target.result;
        }
        reader.readAsDataURL(f);
      } else {
        // If user only previewed but didn't choose file, the preview stays local in modal; set main photo to preview src
        if (photoPreview.src) {
          teacherPhotoMain.src = photoPreview.src;
        }
      }

      // Add change history entry
      addHistoryEntry('Updated Profile');

      closeModal('teacher');
      showToast('Teacher details updated');
    }

    function saveContactChanges(){
      setText('[data-key="email"]', document.getElementById('inp-email').value);
      setText('[data-key="phone"]', document.getElementById('inp-phone').value);
      setText('[data-key="address"]', document.getElementById('inp-address').value);

      addHistoryEntry('Updated Contact Data');

      closeModal('contact');
      showToast('Contact details updated');
    }

    // History helper
    function addHistoryEntry(action){
      const tb = document.getElementById('history-body');
      if (!tb) return;
      const now = new Date();
      const date = now.toLocaleDateString('en-GB'); // dd/mm/yyyy
      const time = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12:true});
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${action}</td><td>${date}</td><td>${time}</td>`;
      tb.insertBefore(tr, tb.firstChild);
    }

    // Toast
    let toastTimer = 0;
    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>t.classList.remove('show'),3000);
    }

    // Close modal when clicking backdrop outside modal content
    document.querySelectorAll('.modal-backdrop').forEach(backdrop=>{
      backdrop.addEventListener('click', (e)=>{
        if (e.target === backdrop) {
          // determine type
          const id = backdrop.id;
          if (id === 'modal-teacher') closeModal('teacher');
          if (id === 'modal-contact') closeModal('contact');
        }
      });
    });

    // Keyboard: Esc to close modals
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') {
        closeModal('teacher');
        closeModal('contact');
      }
    });
  </script>
</body>
</html>
