{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>E-Class Record - {{ teacher.full_name }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.umd.min.js"></script>
  
  <style>
    .loader { 
      border: 5px solid #f3f3f3; 
      border-radius: 50%; 
      border-top: 5px solid #3b82f6; 
      width: 40px; 
      height: 40px; 
      animation: spin 1s linear infinite; 
      display:none; 
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }
    @keyframes spin { 
      0% { transform: rotate(0deg);} 
      100% { transform: rotate(360deg);} 
    }

    .focus-ring:focus { 
      outline: none; 
      box-shadow: 0 0 0 4px rgba(59,130,246,0.12); 
      border-color: #60a5fa; 
    }

    .page-wrapper {
      display: flex;
      flex-wrap: nowrap;
      gap: 20px;
      max-width: 1900px;
      margin: 20px auto;
    }

    .main-container {
      flex: 3;
      min-width: 700px;
      padding: 25px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
    }
    
    .history-sidebar {
      flex: 1;
      min-width: 300px;
      padding: 25px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
      align-self: flex-start;
      max-height: 80vh;
      overflow-y: auto;
    }
    .history-sidebar h2 {
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
      color: #333;
    }
    #history-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .history-item {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s, border-color 0.3s;
      font-size: 14px;
    }
    .history-item:hover {
      background: #f8f9fa;
      border-color: #007bff;
    }
    .history-item strong {
      color: #007bff;
      display: block;
      margin-bottom: 4px;
    }
    .history-item span {
      font-size: 12px;
      color: #555;
    }
    #history-list-empty {
      font-style: italic;
      color: #888;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #eee;
      padding-bottom: 15px;
      margin-bottom: 15px;
    }
    .header-container h1 {
      margin: 0;
      color: #333;
    }
    .header-buttons button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
      transition: all 0.3s;
    }
    .header-buttons button:hover {
      opacity: 0.8;
      transform: translateY(-2px);
    }
    #pdf-btn {
      background-color: #28a745;
      color: white;
    }
    #excel-btn {
      background-color: #17a2b8;
      color: white;
    }
    #print-btn {
      background-color: #dc3545;
      color: white;
    }
    #save-btn {
      background-color: #007bff;
      color: white;
    }

    .sub-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      font-size: 16px;
      color: #555;
      flex-wrap: wrap;
      gap: 10px;
    }
    .subject-info {
      font-weight: bold;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    .subject-info i {
      margin-right: 5px;
      color: #007bff;
    }
    
    .subject-info select, .subject-info input {
      font-weight: bold;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 15px;
      background: #f9f9f9;
    }

    .back-btn {
      background: #6c757d;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s, transform 0.3s;
    }
    .back-btn:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    h1, h2 {
      color: #333;
    }

    .criteria-title {
      font-size: 1.3em;
      font-weight: bold;
      color: #007bff;
      margin-top: 25px;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    .criteria-title i {
      margin-right: 8px;
    }

    .tabs {
      overflow: hidden;
      border-bottom: 2px solid #007bff;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px -8px rgba(0, 0, 0, 0.1);
    }

    .tab-link {
      background-color: #f1f1f1;
      float: left;
      border: 1px solid #ccc;
      border-bottom: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      font-size: 17px;
      transition: 0.3s;
      border-radius: 5px 5px 0 0;
      margin-right: 2px;
    }
    .tab-link:hover {
      background-color: #ddd;
    }
    .tab-link.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }

    .tab-content {
      display: none;
      padding: 20px;
      border: 1px solid #ccc;
      border-top: none;
      background-color: white;
      border-radius: 0 0 5px 5px;
      overflow-x: auto;
    }

    .info-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      margin-bottom: 20px;
      max-width: 600px;
    }
    .info-grid label {
      font-weight: bold;
      text-align: right;
      padding-top: 5px;
    }
    .info-grid input {
      padding: 8px;
      width: 80px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      min-width: 50px;
    }

    th {
      background-color: #f2f2f2;
      font-weight: bold;
      position: sticky;
      top: 0;
    }

    td.student-name, th.student-name {
      text-align: left;
      min-width: 200px;
      position: sticky;
      left: 50px;
      background-color: white;
      z-index: 1;
      border-right: 2px solid #ddd;
    }
    td.student-sex, th.student-sex {
      min-width: 60px;
      position: sticky;
      left: 250px;
      background-color: white;
      z-index: 1;
      border-right: 2px solid #ddd;
    }
    
    td:first-child, th:first-child {
      min-width: 50px;
      position: sticky;
      left: 0;
      background-color: #f9f9f9;
      z-index: 1;
      border-right: 2px solid #ddd;
    }
    th:first-child, th.student-name, th.student-sex {
      z-index: 2;
    }
    
    tbody tr:hover {
      background-color: #f8f9fa;
    }
    tbody tr:hover td:first-child {
      background-color: #f1f1f1;
    }
    tbody tr:hover td.student-name,
    tbody tr:hover td.student-sex {
      background-color: #f1f1f1;
    }

    td input {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      text-align: center;
      padding: 6px 2px;
      -moz-appearance: textfield;
    }
    td input:focus {
      outline: 2px solid #007bff;
      border-color: #007bff;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    td.locked, tr.hps-row .locked {
      background-color: #eee;
      font-weight: bold;
      color: #333;
    }

    tr.hps-row {
      background-color: #fffacd;
    }
    th.hps-label {
      background-color: #fffacd;
      font-weight: bold;
      text-align: left;
    }
    th.hps-label.student-name {
      background-color: #fffacd;
    }
    th.hps-label.student-sex {
      background-color: #fffacd;
    }

    tr.hps-row .hps-total {
      background-color: #fffacd;
      font-weight: bold;
    }

    tr.hps-row input {
      background-color: #fffacd;
      font-weight: bold;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 0;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s;
    }
    .modal-header {
      padding: 16px;
      background-color: #007bff;
      color: white;
      border-radius: 8px 8px 0 0;
    }
    .modal-header h2 {
      margin: 0;
      color: white;
    }
    .close-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      line-height: 1;
      cursor: pointer;
    }
    .close-btn:hover,
    .close-btn:focus {
      color: #000;
      text-decoration: none;
    }
    .modal-body {
      padding: 20px;
      font-size: 16px;
    }
    @keyframes fadeIn {
      from {opacity: 0}
      to {opacity: 1}
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    .footer-prepared {
      margin-top: 50px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .footer-prepared p {
      font-size: 16px;
      color: #333;
      margin: 0;
    }
    .footer-prepared .signature {
      margin-top: 60px;
      width: 300px;
    }
    .footer-prepared .name {
      font-weight: bold;
      font-size: 16px;
      padding-bottom: 5px;
      border-bottom: 1px solid #000;
      display: block;
      text-align: center;
    }
    .footer-prepared .position {
      font-size: 15px;
      color: #555;
      display: block;
      text-align: center;
      margin-top: 8px;
    }

    .letterhead {
      background-color: #a10f0f;
      color: #fff;
      padding: 10px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    .flex-left,
    .flex-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      width: 85px;
      height: 85px;
      object-fit: contain;
      background: transparent;
      padding: 4px;
    }
    #logo4 {
      width: 120px;
      height: auto;
    }
    .center-content {
      flex: 1;
      text-align: center;
      line-height: 1.35;
      padding: 0 10px;
    }
    .center-content h2 {
      font-size: 0.9rem;
      margin: 3px 0;
      font-weight: 600;
      color: #fff;
    }
    .center-content h1 {
      font-size: 1.3rem;
      margin: 3px 0;
      font-weight: 800;
      text-transform: uppercase;
      color: #fff;
    }
    .center-content p {
      font-size: 0.85rem;
      margin: 2px 0;
    }
    .footer {
      background-color: #a10f0f;
      color: #fff;
      padding: 4px 20px;
      font-size: 0.75rem;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .print-only {
      display: none;
    }

    @media print {
      body {
        margin: 0;
        padding: 0;
        background: #fff;
        font-size: 10pt;
      }
      
      #sidebar-root {
        display: none !important;
      }
      
      .main-content-wrapper {
        margin-left: 0 !important;
      }
      
      .page-wrapper {
        display: block;
      }
      .main-container {
        box-shadow: none;
        border: none;
        padding: 0;
        margin: 0;
        max-width: 100%;
        flex: none;
        width: 100%;
      }
      
      .print-only {
        display: block;
      }
      .footer {
        position: fixed;
        bottom: 0;
        width: 100%;
      }

      .no-print, .history-sidebar {
        display: none !important;
      }
      
      .tab-content {
        display: none !important;
        border: none;
        padding: 0;
        overflow: visible;
      }
      .tab-content[style*="display: block"] {
        display: block !important;
      }
      
      .sub-header {
        display: block;
      }
      
      table, th, td {
        border: 1px solid #000 !important;
      }
      td.student-name, th.student-name, 
      td.student-sex, th.student-sex,
      td:first-child, th:first-child {
        position: static;
        left: auto;
        background-color: inherit;
        border-right: 1px solid #000 !important;
      }

      tr.hps-row, tr.hps-row input, tr.hps-row .hps-total, th.hps-label {
        background-color: #fffacd !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      th {
        background-color: #f2f2f2 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      td.locked, tr.hps-row .locked {
        background-color: #eee !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      tr {
        page-break-inside: avoid;
      }
      h2 {
        page-break-before: always;
      }
      .footer-prepared {
        page-break-inside: avoid;
      }
      #Summary h2 {
        page-break-before: always;
      }
      #Q1 h2 {
        page-break-before: auto;
      }
      
      .letterhead, .letterhead h1, .letterhead h2, .letterhead p {
        color: #000 !important;
      }
      .letterhead {
        background-color: #fff !important;
        border-bottom: 2px solid #000;
        padding: 10px;
      }
      .footer {
        color: #000 !important;
        background-color: #fff !important;
        border-top: 1px solid #000;
        justify-content: flex-end;
      }
      .logo {
        display: none;
      }
    }

    /* Additional styles for warning modal */
  #warningModal .modal-header {
    background-color: #ffc107; /* Yellow for "at risk" */
    color: #000;
  }

  #warningModal.failed-warning .modal-header {
    background-color: #dc3545; /* Red for "failed" */
    color: white;
  }

  #warningModal #warning-requirements-list li {
    padding: 10px;
    margin-bottom: 8px;
    background: white;
    border-left: 4px solid #007bff;
    border-radius: 4px;
    font-size: 14px;
  }

  #warningModal #warning-requirements-list li i {
    color: #007bff;
    margin-right: 8px;
  }

  /* Highlighting styles for at-risk students */
  .student-name.at-risk-highlight {
    background-color: #fee !important; /* Light red */
    font-weight: bold !important;
    cursor: pointer !important;
    position: relative;
  }

  .student-name.failed-highlight {
    background-color: #fdd !important; /* Dark red */
    font-weight: bold !important;
    cursor: pointer !important;
    position: relative;
  }

  .student-name.at-risk-highlight:hover,
  .student-name.failed-highlight:hover {
    opacity: 0.9;
  }

  /* Warning icon badge */
  .warning-badge {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
  }

  .at-risk-highlight .warning-badge {
    color: #ffc107;
  }

  .failed-highlight .warning-badge {
    color: #dc3545;
  }
  </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased">

{% csrf_token %}

<div class="loader" id="main-loader"></div>

{% if error %}
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative m-4" role="alert">
  <strong class="font-bold">Error!</strong>
  <span class="block sm:inline">{{ error }}</span>
</div>
{% endif %}

<div id="sidebar-root">
  {% include 'teacher/adviser/sidebar.html' %}
</div>

<div class="main-content-wrapper ml-0 lg:ml-64 transition-all duration-300 min-h-screen">

<div class="print-only">
  <div class="letterhead" id="letterhead">
    <div class="flex-left">
      <img class="logo" id="logo1" src="https://placehold.co/85x85/ffffff/a10f0f?text=Logo+1" alt="Left Logo 1">
      <img class="logo" id="logo2" src="https://placehold.co/85x85/ffffff/a10f0f?text=Logo+2" alt="Left Logo 2">
    </div>
    <div class="center-content" id="header-text">
      <h2>Republic of the Philippines</h2>
      <h2>Department of Education</h2>
      <h2>REGION IX – ZAMBOANGA PENINSULA</h2>
      <h2>Schools Division Office of Zamboanga City</h2>
      <h1>Zamboanga National High School West</h1>
      <p>R.T. Lim Boulevard, Zamboanga City, Philippines</p>
      <p><strong>School ID:</strong> 303942</p>
    </div>
    <div class="flex-right">
      <img class="logo" id="logo3" src="https://placehold.co/85x85/ffffff/a10f0f?text=Logo+3" alt="Right Logo 1">
      <img class="logo" id="logo4" src="https://placehold.co/120x85/ffffff/a10f0f?text=Logo+4" alt="Right Logo 2">
    </div>
  </div>
</div>

<div class="page-wrapper">

  <div class="main-container">

    <div class="header-container no-print">
      <h1>E-Class Record</h1>
      <div class="header-buttons">
        <button id="save-btn" title="Save Progress"><i class="fa-solid fa-save"></i> Save</button>
        <button id="pdf-btn" title="Download as PDF"><i class="fa-solid fa-file-arrow-down"></i> Download PDF</button>
        <button id="excel-btn" title="Download as Excel"><i class="fa-solid fa-file-excel"></i> Excel</button>
        <button id="print-btn" title="Print"><i class="fa-solid fa-print"></i> Print</button>
      </div>
    </div>

    <div class="sub-header">
      <div class="subject-info">
        <span>
          <i class="fa-solid fa-users"></i>Section: 
          <select id="section-select" class="no-print">
            <option value="">Select Section</option>
            {% for section in all_sections %}
            <option value="{{ section.id }}">{{ section.name }}</option>
            {% endfor %}
          </select>
        </span>

        <span>
          <i class="fa-solid fa-book"></i>Subject: 
          <select id="subject-select" class="no-print">
            <option value="">Select Subject</option>
            {% for subject in all_subjects %}
            <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
            {% endfor %}
          </select>
        </span>

        <span>
          <i class="fa-solid fa-calendar-days"></i>S.Y. 
          <select id="school-year-select" class="no-print">
            {% for sy in school_year_choices %}
            <option value="{{ sy.name }}" {% if sy.is_current %}selected{% endif %}>{{ sy.name }}</option>
            {% endfor %}
          </select>
        </span>
      </div>
      <button class="back-btn no-print" onclick="history.back()" title="Go Back"><i class="fa-solid fa-arrow-left"></i> Back</button>
    </div>

    <nav class="tabs no-print">
      <button class="tab-link active" data-quarter="Q1" onclick="openTab(event, 'Q1')">Quarter 1</button>
      <button class="tab-link" data-quarter="Q2" onclick="openTab(event, 'Q2')">Quarter 2</button>
      <button class="tab-link" data-quarter="Q3" onclick="openTab(event, 'Q3')">Quarter 3</button>
      <button class="tab-link" data-quarter="Q4" onclick="openTab(event, 'Q4')">Quarter 4</button>
      <button class="tab-link" data-quarter="Summary" onclick="openTab(event, 'Summary')">Summary</button>
    </nav>

    <div id="Q1" class="tab-content" style="display: block;">
      <h2>First Quarter</h2>
      
      <h3 class="criteria-title no-print">
        <i class="fa-solid fa-sliders"></i> Grading Criteria Configuration
      </h3>
      <div class="info-grid no-print">
        <label>Written Works %:</label><input type="number" class="weight-input" id="q1-ww-weight" data-quarter="1" value="30" min="0" max="100">
        <label>Performance Tasks %:</label><input type="number" class="weight-input" id="q1-pt-weight" data-quarter="1" value="50" min="0" max="100">
        <label>Quarterly Assessment %:</label><input type="number" class="weight-input" id="q1-qa-weight" data-quarter="1" value="20" min="0" max="100">
      </div>

      <table id="q1-table">
        <thead>
          <tr>
            <th rowspan="2">No.</th>
            <th rowspan="2" class="student-name">Learners' Names</th>
            <th rowspan="2" class="student-sex">Sex</th>
            <th colspan="13" id="q1-ww-header">Written Works (30%)</th>
            <th colspan="13" id="q1-pt-header">Performance Tasks (50%)</th>
            <th colspan="3" id="q1-qa-header">Quarterly Assessment (20%)</th>
            <th rowspan="2">Initial Grade</th>
            <th rowspan="2">Quarterly Grade</th>
          </tr>
          <tr>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
            <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
            <th>Total</th><th>PS</th><th>WS</th>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
            <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
            <th>Total</th><th>PS</th><th>WS</th>
            <th>1</th><th>PS</th><th>WS</th>
          </tr>
          <tr class="hps-row">
            <th class="hps-label"></th>
            <th class="hps-label student-name">Highest Possible Score</th>
            <th class="hps-label student-sex"></th>
            <td><input type="number" class="hps" id="q1-ww-hps-1" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-ww-hps-2" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-ww-hps-3" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-ww-hps-4" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-ww-hps-5" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-ww-hps-6" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-ww-hps-7" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-ww-hps-8" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-ww-hps-9" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-ww-hps-10" data-quarter="1" value="10"></td>
            <td class="hps-total" id="q1-ww-hps-total">100</td>
            <td class="locked">100</td><td class="locked" id="q1-ww-hps-ws">30.00</td>
            
            <td><input type="number" class="hps" id="q1-pt-hps-1" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-pt-hps-2" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-pt-hps-3" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-pt-hps-4" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-pt-hps-5" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-pt-hps-6" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-pt-hps-7" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-pt-hps-8" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-pt-hps-9" data-quarter="1" value="10"></td>
            <td><input type="number" class="hps" id="q1-pt-hps-10" data-quarter="1" value="10"></td>
            <td class="hps-total" id="q1-pt-hps-total">100</td>
            <td class="locked">100</td><td class="locked" id="q1-pt-hps-ws">50.00</td>
            
            <td><input type="number" class="hps" id="q1-qa-hps-1" data-quarter="1" value="50"></td>
            <td class="hps-total" id="q1-qa-hps-total">50</td>
            <td class="locked" id="q1-qa-hps-ws">20.00</td>
          </tr>
        </thead>
        <tbody id="q1-body">
          <tr>
            <td colspan="32" style="text-align: center; padding: 20px; color: #888;">
              <i class="fa-solid fa-info-circle"></i> Please select a section and subject to load students
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="Q2" class="tab-content">
      <h2>Second Quarter</h2>
      
      <h3 class="criteria-title no-print">
        <i class="fa-solid fa-sliders"></i> Grading Criteria Configuration
      </h3>
      <div class="info-grid no-print">
        <label>Written Works %:</label><input type="number" class="weight-input" id="q2-ww-weight" data-quarter="2" value="30" min="0" max="100">
        <label>Performance Tasks %:</label><input type="number" class="weight-input" id="q2-pt-weight" data-quarter="2" value="50" min="0" max="100">
        <label>Quarterly Assessment %:</label><input type="number" class="weight-input" id="q2-qa-weight" data-quarter="2" value="20" min="0" max="100">
      </div>

      <table id="q2-table">
        <thead>
          <tr>
            <th rowspan="2">No.</th>
            <th rowspan="2" class="student-name">Learners' Names</th>
            <th rowspan="2" class="student-sex">Sex</th>
            <th colspan="13" id="q2-ww-header">Written Works (30%)</th>
            <th colspan="13" id="q2-pt-header">Performance Tasks (50%)</th>
            <th colspan="3" id="q2-qa-header">Quarterly Assessment (20%)</th>
            <th rowspan="2">Initial Grade</th>
            <th rowspan="2">Quarterly Grade</th>
          </tr>
          <tr>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
            <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
            <th>Total</th><th>PS</th><th>WS</th>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
            <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
            <th>Total</th><th>PS</th><th>WS</th>
            <th>1</th><th>PS</th><th>WS</th>
          </tr>
          <tr class="hps-row">
            <th class="hps-label"></th>
            <th class="hps-label student-name">Highest Possible Score</th>
            <th class="hps-label student-sex"></th>
            <td><input type="number" class="hps" id="q2-ww-hps-1" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-ww-hps-2" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-ww-hps-3" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-ww-hps-4" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-ww-hps-5" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-ww-hps-6" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-ww-hps-7" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-ww-hps-8" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-ww-hps-9" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-ww-hps-10" data-quarter="2" value="10"></td>
            <td class="hps-total" id="q2-ww-hps-total">100</td>
            <td class="locked">100</td><td class="locked" id="q2-ww-hps-ws">30.00</td>
            
            <td><input type="number" class="hps" id="q2-pt-hps-1" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-pt-hps-2" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-pt-hps-3" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-pt-hps-4" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-pt-hps-5" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-pt-hps-6" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-pt-hps-7" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-pt-hps-8" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-pt-hps-9" data-quarter="2" value="10"></td>
            <td><input type="number" class="hps" id="q2-pt-hps-10" data-quarter="2" value="10"></td>
            <td class="hps-total" id="q2-pt-hps-total">100</td>
            <td class="locked">100</td><td class="locked" id="q2-pt-hps-ws">50.00</td>
            
            <td><input type="number" class="hps" id="q2-qa-hps-1" data-quarter="2" value="50"></td>
            <td class="hps-total" id="q2-qa-hps-total">50</td>
            <td class="locked" id="q2-qa-hps-ws">20.00</td>
          </tr>
        </thead>
        <tbody id="q2-body">
          <tr>
            <td colspan="32" style="text-align: center; padding: 20px; color: #888;">
              <i class="fa-solid fa-info-circle"></i> Please select a section and subject to load students
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="Q3" class="tab-content">
      <h2>Third Quarter</h2>
      
      <h3 class="criteria-title no-print">
        <i class="fa-solid fa-sliders"></i> Grading Criteria Configuration
      </h3>
      <div class="info-grid no-print">
        <label>Written Works %:</label><input type="number" class="weight-input" id="q3-ww-weight" data-quarter="3" value="30" min="0" max="100">
        <label>Performance Tasks %:</label><input type="number" class="weight-input" id="q3-pt-weight" data-quarter="3" value="50" min="0" max="100">
        <label>Quarterly Assessment %:</label><input type="number" class="weight-input" id="q3-qa-weight" data-quarter="3" value="20" min="0" max="100">
      </div>

      <table id="q3-table">
        <thead>
          <tr>
            <th rowspan="2">No.</th>
            <th rowspan="2" class="student-name">Learners' Names</th>
            <th rowspan="2" class="student-sex">Sex</th>
            <th colspan="13" id="q3-ww-header">Written Works (30%)</th>
            <th colspan="13" id="q3-pt-header">Performance Tasks (50%)</th>
            <th colspan="3" id="q3-qa-header">Quarterly Assessment (20%)</th>
            <th rowspan="2">Initial Grade</th>
            <th rowspan="2">Quarterly Grade</th>
          </tr>
          <tr>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
            <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
            <th>Total</th><th>PS</th><th>WS</th>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
            <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
            <th>Total</th><th>PS</th><th>WS</th>
            <th>1</th><th>PS</th><th>WS</th>
          </tr>
          <tr class="hps-row">
            <th class="hps-label"></th>
            <th class="hps-label student-name">Highest Possible Score</th>
            <th class="hps-label student-sex"></th>
            <td><input type="number" class="hps" id="q3-ww-hps-1" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-ww-hps-2" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-ww-hps-3" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-ww-hps-4" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-ww-hps-5" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-ww-hps-6" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-ww-hps-7" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-ww-hps-8" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-ww-hps-9" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-ww-hps-10" data-quarter="3" value="10"></td>
            <td class="hps-total" id="q3-ww-hps-total">100</td>
            <td class="locked">100</td><td class="locked" id="q3-ww-hps-ws">30.00</td>
            
            <td><input type="number" class="hps" id="q3-pt-hps-1" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-pt-hps-2" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-pt-hps-3" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-pt-hps-4" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-pt-hps-5" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-pt-hps-6" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-pt-hps-7" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-pt-hps-8" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-pt-hps-9" data-quarter="3" value="10"></td>
            <td><input type="number" class="hps" id="q3-pt-hps-10" data-quarter="3" value="10"></td>
            <td class="hps-total" id="q3-pt-hps-total">100</td>
            <td class="locked">100</td><td class="locked" id="q3-pt-hps-ws">50.00</td>
            
            <td><input type="number" class="hps" id="q3-qa-hps-1" data-quarter="3" value="50"></td>
            <td class="hps-total" id="q3-qa-hps-total">50</td>
            <td class="locked" id="q3-qa-hps-ws">20.00</td>
          </tr>
        </thead>
        <tbody id="q3-body">
          <tr>
            <td colspan="32" style="text-align: center; padding: 20px; color: #888;">
              <i class="fa-solid fa-info-circle"></i> Please select a section and subject to load students
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="Q4" class="tab-content">
      <h2>Fourth Quarter</h2>
      
      <h3 class="criteria-title no-print">
        <i class="fa-solid fa-sliders"></i> Grading Criteria Configuration
      </h3>
      <div class="info-grid no-print">
        <label>Written Works %:</label><input type="number" class="weight-input" id="q4-ww-weight" data-quarter="4" value="30" min="0" max="100">
        <label>Performance Tasks %:</label><input type="number" class="weight-input" id="q4-pt-weight" data-quarter="4" value="50" min="0" max="100">
        <label>Quarterly Assessment %:</label><input type="number" class="weight-input" id="q4-qa-weight" data-quarter="4" value="20" min="0" max="100">
      </div>

      <table id="q4-table">
        <thead>
          <tr>
            <th rowspan="2">No.</th>
            <th rowspan="2" class="student-name">Learners' Names</th>
            <th rowspan="2" class="student-sex">Sex</th>
            <th colspan="13" id="q4-ww-header">Written Works (30%)</th>
            <th colspan="13" id="q4-pt-header">Performance Tasks (50%)</th>
            <th colspan="3" id="q4-qa-header">Quarterly Assessment (20%)</th>
            <th rowspan="2">Initial Grade</th>
            <th rowspan="2">Quarterly Grade</th>
          </tr>
          <tr>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
            <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
            <th>Total</th><th>PS</th><th>WS</th>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
            <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
            <th>Total</th><th>PS</th><th>WS</th>
            <th>1</th><th>PS</th><th>WS</th>
          </tr>
          <tr class="hps-row">
            <th class="hps-label"></th>
            <th class="hps-label student-name">Highest Possible Score</th>
            <th class="hps-label student-sex"></th>
            <td><input type="number" class="hps" id="q4-ww-hps-1" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-ww-hps-2" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-ww-hps-3" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-ww-hps-4" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-ww-hps-5" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-ww-hps-6" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-ww-hps-7" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-ww-hps-8" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-ww-hps-9" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-ww-hps-10" data-quarter="4" value="10"></td>
            <td class="hps-total" id="q4-ww-hps-total">100</td>
            <td class="locked">100</td><td class="locked" id="q4-ww-hps-ws">30.00</td>
            
            <td><input type="number" class="hps" id="q4-pt-hps-1" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-pt-hps-2" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-pt-hps-3" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-pt-hps-4" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-pt-hps-5" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-pt-hps-6" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-pt-hps-7" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-pt-hps-8" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-pt-hps-9" data-quarter="4" value="10"></td>
            <td><input type="number" class="hps" id="q4-pt-hps-10" data-quarter="4" value="10"></td>
            <td class="hps-total" id="q4-pt-hps-total">100</td>
            <td class="locked">100</td><td class="locked" id="q4-pt-hps-ws">50.00</td>
            
            <td><input type="number" class="hps" id="q4-qa-hps-1" data-quarter="4" value="50"></td>
            <td class="hps-total" id="q4-qa-hps-total">50</td>
            <td class="locked" id="q4-qa-hps-ws">20.00</td>
          </tr>
        </thead>
        <tbody id="q4-body">
          <tr>
            <td colspan="32" style="text-align: center; padding: 20px; color: #888;">
              <i class="fa-solid fa-info-circle"></i> Please select a section and subject to load students
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="Summary" class="tab-content">
      <h2>Summary of Quarterly Grades for <span id="summary-section-name">Select a Section</span></h2>
      <table id="summary-table">
        <thead>
          <tr>
            <th>No.</th>
            <th class="student-name">Learners' Names</th>
            <th class="student-sex">Sex</th>
            <th>1st Quarter</th>
            <th>2nd Quarter</th>
            <th>3rd Quarter</th>
            <th>4th Quarter</th>
            <th>Final Grade</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody id="summary-body">
          <tr>
            <td colspan="9" style="text-align: center; padding: 20px; color: #888;">
              <i class="fa-solid fa-info-circle"></i> Summary will be auto-generated from quarterly data
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="footer-prepared">
      <p>Prepared by:</p>
      <div class="signature">
        <span class="name">{{ teacher.full_name }}</span>
        <span class="position">{{ teacher.position }}</span>
      </div>
    </div>

  </div>

  <div class="history-sidebar no-print">
    <h2><i class="fa-solid fa-clock-rotate-left"></i> Saved History</h2>
    <div id="history-list">
      <p id="history-list-empty">No history saved yet. Click the 'Save' button to create a snapshot.</p>
    </div>
  </div>

</div>

</div>

<div class="print-only">
  <footer class="footer">
    <span id="page-number">Page 1</span>
  </footer>
</div>

<div id="saveModal" class="modal no-print">
  <div class="modal-content">
    <div class="modal-header">
      <span class="close-btn">&times;</span>
      <h2><i class="fa-solid fa-check-circle"></i> Save Confirmation</h2>
    </div>
    <div class="modal-body">
      <p>Your work has been successfully saved to the history panel!</p>
    </div>
  </div>
</div>

<!-- ============================================================================ -->
<!-- EARLY WARNING MODAL -->
<!-- ============================================================================ -->
<div id="warningModal" class="modal no-print">
  <div class="modal-content">
    <div class="modal-header" id="warning-modal-header">
      <span class="close-btn" onclick="closeWarningModal()">&times;</span>
      <h2 id="warning-modal-title"><i class="fa-solid fa-triangle-exclamation"></i> Student At Risk</h2>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 20px;">
        <p style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">
          <span id="warning-student-name">Student Name</span> 
          <span id="warning-status-text">is at risk of failing</span>
        </p>
        <p style="color: #666; font-size: 14px;">
          <strong>Subject:</strong> <span id="warning-subject"></span> • 
          <strong>Quarter:</strong> <span id="warning-quarter"></span>
        </p>
      </div>

      <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <span style="color: #666; font-size: 14px;">Current Quarterly Grade:</span>
            <div style="font-size: 32px; font-weight: bold;" id="warning-current-grade">72</div>
          </div>
          <div style="text-align: center; font-size: 24px; color: #999;">→</div>
          <div style="text-align: right;">
            <span style="color: #666; font-size: 14px;">Needs to reach:</span>
            <div style="font-size: 32px; font-weight: bold; color: #28a745;">75</div>
          </div>
        </div>
      </div>

      <!-- AT-RISK CONTENT (Quarter In Progress) -->
      <div id="warning-at-risk-content" style="display: none;">
        <h4 style="margin-bottom: 15px; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px;">
          <i class="fa-solid fa-chart-line" style="color: #007bff;"></i> 
          Current Performance
        </h4>
        <div id="warning-current-performance" style="margin-bottom: 20px;">
          <!-- Dynamically filled -->
        </div>

        <h4 style="margin-bottom: 15px; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px;">
          <i class="fa-solid fa-target" style="color: #ffc107;"></i> 
          What This Student Needs
        </h4>
        <div id="warning-requirements" style="margin-bottom: 20px;">
          <!-- Dynamically filled -->
        </div>

        <div style="background: #e3f2fd; padding: 12px; border-radius: 5px; border-left: 4px solid #2196f3;">
          <p style="margin: 0; color: #1565c0; font-size: 14px;">
            <i class="fa-solid fa-info-circle"></i> 
            <strong>Note:</strong> These are projections based on current performance. Student can still improve.
          </p>
        </div>
      </div>

      <!-- FAILED CONTENT (Quarter Complete) -->
      <div id="warning-failed-content" style="display: none;">
        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
          <p style="margin: 0; color: #856404;">
            <i class="fa-solid fa-calendar-check"></i> 
            <strong>Quarter Complete:</strong> All assessments have been submitted.
          </p>
        </div>

        <h4 style="margin-bottom: 15px; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px;">
          <i class="fa-solid fa-chart-pie" style="color: #dc3545;"></i> 
          Final Performance Breakdown
        </h4>
        <div id="warning-breakdown" style="margin-bottom: 20px;">
          <!-- Dynamically filled -->
        </div>

        <div style="background: #f8d7da; padding: 15px; border-radius: 5px; border-left: 4px solid #dc3545;">
          <p style="margin: 0; color: #721c24; font-weight: bold;">
            <i class="fa-solid fa-exclamation-triangle"></i> 
            IMMEDIATE ACTION REQUIRED
          </p>
          <p style="margin: 8px 0 0 0; color: #721c24; font-size: 14px;">
            An intervention plan must be created to support this student in the next quarter.
          </p>
        </div>
      </div>

      <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
        <button id="btn-dismiss-warning" onclick="dismissWarning()" 
                style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 5px; background: white; cursor: pointer; font-size: 14px; font-weight: 500;">
          Dismiss
        </button>
        <button id="btn-create-intervention" onclick="createInterventionFromWarning()" 
                style="padding: 10px 20px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer; font-size: 14px; font-weight: 500;"
                disabled>
          <i class="fa-solid fa-plus-circle"></i> Create Intervention
        </button>
      </div>
    </div>
  </div>
</div>


<script>
console.log('=== Starting Class Record Initialization ===');

// Initialize with error handling
window.SECTIONS_WITH_SUBJECTS = {};
try {
    const sectionsData = '{{ sections_with_subjects|escapejs }}';
    console.log('Raw sections data from Django:', sectionsData);
    
    if (sectionsData && sectionsData !== '{}') {
        window.SECTIONS_WITH_SUBJECTS = JSON.parse(sectionsData);
        console.log('✓ Successfully parsed sections data:', window.SECTIONS_WITH_SUBJECTS);
    } else {
        console.warn('⚠ No sections data received from Django');
    }
} catch(e) {
    console.error('✗ Error parsing sections data:', e);
}

// Global configuration
window.CURRENT_TEACHER_ID = {{ teacher.id }};
window.CURRENT_SCHOOL_YEAR = "{{ current_school_year.name }}";
window.API_GET_CLASSRECORD = "{% url 'teacher:api-get-classrecord' %}";
window.API_SAVE_CLASSRECORD = "{% url 'teacher:api-save-classrecord' %}";
window.API_EXPORT_PDF = "{% url 'teacher:api-export-pdf' 0 %}".replace('/0/', '/{id}/');
window.API_EXPORT_EXCEL = "{% url 'teacher:api-export-excel' 0 %}".replace('/0/', '/{id}/');
window.API_CLASSRECORD_HISTORY = "{% url 'teacher:api-classrecord-history' %}";

// Application state
let currentClassRecordId = null;
let unsavedChanges = false;
let autoSaveTimeout = null;

// Debug all the data
console.log('Teacher ID:', window.CURRENT_TEACHER_ID);
console.log('School Year:', window.CURRENT_SCHOOL_YEAR);
console.log('Total sections in dropdown:', {{ all_sections|length }});
console.log('Total subjects available:', {{ all_subjects|length }});

console.log('=== Initialization Complete ===\n');


// ============================================================================
// EVENT LISTENERS - Setup on DOM Ready
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Ready - Attaching event listeners');
    
    // Section selection - Auto-populate subjects
    const sectionSelect = document.getElementById('section-select');
    if (sectionSelect) {
        sectionSelect.addEventListener('change', function(e) {
            const sectionId = e.target.value;
            const subjectSelect = document.getElementById('subject-select');
            
            console.log('Section changed to:', sectionId);
            
            if (!sectionId || !subjectSelect) {
                console.warn('No section selected or subject select not found');
                return;
            }
            
            // Clear existing subject options
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            
            // Get subjects for this section
            const sectionData = window.SECTIONS_WITH_SUBJECTS[sectionId];
            
            if (sectionData && sectionData.subjects && sectionData.subjects.length > 0) {
                console.log('Found subjects for section:', sectionData.subjects);
                
                // Populate subjects dropdown
                sectionData.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.code;
                    option.textContent = subject.name;
                    option.dataset.assignmentId = subject.assignment_id;
                    subjectSelect.appendChild(option);
                });
                
                // Enable the subject dropdown
                subjectSelect.disabled = false;
                
                // Auto-select first subject if there's only one
                if (sectionData.subjects.length === 1) {
                    subjectSelect.value = sectionData.subjects[0].code;
                    subjectSelect.dispatchEvent(new Event('change'));
                }
                
                console.log('✓ Populated', sectionData.subjects.length, 'subjects');
            } else {
                console.warn('No subjects found for section ID:', sectionId);
                subjectSelect.innerHTML = '<option value="">No subjects assigned</option>';
                subjectSelect.disabled = true;
            }
        });
    }
    
    // Subject selection - Load class record
    const subjectSelect = document.getElementById('subject-select');
    if (subjectSelect) {
        subjectSelect.addEventListener('change', function(e) {
            const sectionId = document.getElementById('section-select')?.value;
            const subjectCode = e.target.value;
            const activeTab = document.querySelector('.tab-link.active');
            const quarter = activeTab?.getAttribute('data-quarter') || 'Q1';
            
            console.log('Subject changed to:', subjectCode);
            console.log('Current quarter:', quarter);
            
            if (sectionId && subjectCode) {
                loadClassRecord(sectionId, subjectCode, quarter);
            }
        });
    }
    
    // Save button
    const saveBtn = document.getElementById('save-btn');
    if (saveBtn) {
        saveBtn.addEventListener('click', saveClassRecord);
    }
    
    // Export buttons
    const pdfBtn = document.getElementById('pdf-btn');
    if (pdfBtn) {
        pdfBtn.addEventListener('click', exportToPdf);
    }
    
    const excelBtn = document.getElementById('excel-btn');
    if (excelBtn) {
        excelBtn.addEventListener('click', exportToExcel);
    }
    
    const printBtn = document.getElementById('print-btn');
    if (printBtn) {
        printBtn.addEventListener('click', () => window.print());
    }
    
    // Auto-save on input changes (debounced)
    const mainContainer = document.querySelector('.main-container');
    if (mainContainer) {
        mainContainer.addEventListener('input', (e) => {
            const target = e.target;
            
            if (target.classList.contains('score')) {
                const activeTab = document.querySelector('.tab-content[style*="display: block"]');
                if (activeTab) {
                    const qNum = activeTab.id.replace('Q', '');
                    calculateQuarterGrades(qNum);
                }
                markUnsaved();
                debouncedAutoSave();
            }
            else if (target.classList.contains('hps')) {
                const qNum = target.dataset.quarter;
                calculateQuarterHPS(qNum);
                markUnsaved();
                debouncedAutoSave();
            }
            else if (target.classList.contains('weight-input')) {
                const qNum = target.dataset.quarter;
                updateQuarterWeights(qNum);
                markUnsaved();
                debouncedAutoSave();
            }
        });
    }
    
    // Modal close button
    const modal = document.getElementById('saveModal');
    const closeBtn = document.querySelector('.close-btn');
    
    if (closeBtn) {
        closeBtn.onclick = () => {
            if (modal) modal.style.display = "none";
        };
    }
    
    window.onclick = (event) => {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    };
    
    // Initialize calculations for all quarters
    for (let q = 1; q <= 4; q++) {
        updateQuarterWeights(q);
        calculateQuarterHPS(q);
    }
    
    // Load history sidebar
    loadHistory();
    
    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', (e) => {
        if (unsavedChanges) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
    
    console.log('✓ All event listeners attached');
});


// ============================================================================
// LOAD CLASS RECORD FROM API
// ============================================================================

async function loadClassRecord(sectionId, subjectCode, quarter) {
    showLoader('Loading class record...');
    
    try {
        const schoolYear = document.getElementById('school-year-select')?.value || window.CURRENT_SCHOOL_YEAR;
        
        const url = `${window.API_GET_CLASSRECORD}?section_id=${sectionId}&subject_code=${subjectCode}&quarter=${quarter}&school_year=${schoolYear}`;
        
        console.log('Fetching from:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        console.log('API Response:', data);
        
        if (data.success) {
            currentClassRecordId = data.class_record.id;
            populateClassRecord(data.class_record, data.students, quarter);
            
            if (data.created) {
                showNotification('New class record created!', 'success');
            } else {
                showNotification('Class record loaded successfully', 'info');
            }
            
            // Reset unsaved changes flag
            unsavedChanges = false;
        } else {
            showNotification(data.error || 'Failed to load class record', 'error');
            console.error('Error:', data.error);
        }
    } catch (error) {
        console.error('Error loading class record:', error);
        showNotification('Error loading class record. Please try again.', 'error');
    } finally {
        hideLoader();
    }
}


// ============================================================================
// POPULATE CLASS RECORD WITH DATA
// ============================================================================

function populateClassRecord(classRecord, students, quarter) {
    console.log('=== POPULATING CLASS RECORD ===');
    console.log('Quarter:', quarter);
    console.log('Students:', students);
    console.log('Students count:', students.length);
    
    const qNum = quarter.replace('Q', '');
    const qLower = `q${qNum}`;
    
    // Update weights
    const wwWeightInput = document.getElementById(`${qLower}-ww-weight`);
    const ptWeightInput = document.getElementById(`${qLower}-pt-weight`);
    const qaWeightInput = document.getElementById(`${qLower}-qa-weight`);
    
    if (wwWeightInput) wwWeightInput.value = classRecord.weights.ww;
    if (ptWeightInput) ptWeightInput.value = classRecord.weights.pt;
    if (qaWeightInput) qaWeightInput.value = classRecord.weights.qa;
    
    // Update HPS values
    classRecord.hps.ww.forEach((hps, idx) => {
        const input = document.getElementById(`${qLower}-ww-hps-${idx + 1}`);
        if (input) input.value = hps || 10;
    });
    
    classRecord.hps.pt.forEach((hps, idx) => {
        const input = document.getElementById(`${qLower}-pt-hps-${idx + 1}`);
        if (input) input.value = hps || 10;
    });
    
    const qaHpsInput = document.getElementById(`${qLower}-qa-hps-1`);
    if (qaHpsInput) qaHpsInput.value = classRecord.hps.qa[0] || 50;
    
    // Populate student rows
    const tbody = document.getElementById(`${qLower}-body`);
    console.log('Table body element:', tbody);
    
    if (!tbody) {
        console.error('❌ Table body not found:', `${qLower}-body`);
        return;
    }
    
    tbody.innerHTML = ''; // Clear existing rows
    
    if (students.length === 0) {
        console.warn('⚠ No students to display');
        tbody.innerHTML = `
            <tr>
                <td colspan="32" style="text-align: center; padding: 20px; color: #888;">
                    <i class="fa-solid fa-info-circle"></i> No students found in this section
                </td>
            </tr>
        `;
        return;
    }
    
    // Create rows for each student
    students.forEach((student, idx) => {
        console.log(`Creating row for student ${idx + 1}:`, student.name);
        const row = createStudentRow(qLower, student, idx + 1);
        tbody.appendChild(row);
    });
    
    console.log(`✅ Successfully added ${students.length} student rows to table`);
    
    // Update summary section name
    const summaryName = document.getElementById('summary-section-name');
    if (summaryName) {
        summaryName.textContent = classRecord.section;
    }
    
    // Recalculate everything
    updateQuarterWeights(qNum);
    calculateQuarterHPS(qNum);
    calculateQuarterGrades(qNum);
}


function createStudentRow(quarter, student, number) {
    console.log('Creating row HTML for:', student.name);
    
    const row = document.createElement('tr');
    row.id = `${quarter}-student-${student.id}`;
    row.dataset.studentId = student.id;
    row.dataset.gradeId = student.grade_id;
    
    // Start building the row HTML
    let rowHTML = `
        <td>${number}</td>
        <td class="student-name">${student.name}</td>
        <td class="student-sex">${student.gender}</td>
    `;
    
    // Written Works columns (10 columns)
    student.scores.ww.forEach((score) => {
        rowHTML += `<td><input type="number" class="score ${quarter}-ww" value="${score || 0}" step="0.01"></td>`;
    });
    rowHTML += `
        <td class="locked ${quarter}-ww-total">${(student.computed.ww_total || 0).toFixed(2)}</td>
        <td class="locked ${quarter}-ww-ps">${(student.computed.ww_percentage || 0).toFixed(2)}</td>
        <td class="locked ${quarter}-ww-ws">${(student.computed.ww_weighted_score || 0).toFixed(2)}</td>
    `;
    
    // Performance Tasks columns (10 columns)
    student.scores.pt.forEach((score) => {
        rowHTML += `<td><input type="number" class="score ${quarter}-pt" value="${score || 0}" step="0.01"></td>`;
    });
    rowHTML += `
        <td class="locked ${quarter}-pt-total">${(student.computed.pt_total || 0).toFixed(2)}</td>
        <td class="locked ${quarter}-pt-ps">${(student.computed.pt_percentage || 0).toFixed(2)}</td>
        <td class="locked ${quarter}-pt-ws">${(student.computed.pt_weighted_score || 0).toFixed(2)}</td>
    `;
    
    // Quarterly Assessment columns
    rowHTML += `
        <td><input type="number" class="score ${quarter}-qa" value="${student.scores.qa[0] || 0}" step="0.01"></td>
        <td class="locked ${quarter}-qa-ps">${(student.computed.qa_percentage || 0).toFixed(2)}</td>
        <td class="locked ${quarter}-qa-ws">${(student.computed.qa_weighted_score || 0).toFixed(2)}</td>
    `;
    
    // Grade columns
    rowHTML += `
        <td class="locked ${quarter}-initial-grade">${(student.computed.initial_grade || 0).toFixed(2)}</td>
        <td class="locked ${quarter}-quarterly-grade">${student.computed.quarterly_grade || 0}</td>
    `;
    
    row.innerHTML = rowHTML;
    return row;
}


// ============================================================================
// SAVE CLASS RECORD TO API
// ============================================================================

async function saveClassRecord() {
    if (!currentClassRecordId) {
        showNotification('No class record loaded', 'warning');
        return;
    }
    
    showLoader('Saving class record...');
    
    try {
        // Collect current data from UI
        const activeTab = document.querySelector('.tab-content[style*="display: block"]');
        const qNum = activeTab?.id.replace('Q', '') || '1';
        const q = `q${qNum}`;
        
        // Collect weights
        const weights = {
            ww: parseInt(document.getElementById(`${q}-ww-weight`)?.value) || 30,
            pt: parseInt(document.getElementById(`${q}-pt-weight`)?.value) || 50,
            qa: parseInt(document.getElementById(`${q}-qa-weight`)?.value) || 20
        };
        
        // Collect HPS
        const hps = {
            ww: [],
            pt: [],
            qa: []
        };
        
        for (let i = 1; i <= 10; i++) {
            const wwHps = document.getElementById(`${q}-ww-hps-${i}`);
            const ptHps = document.getElementById(`${q}-pt-hps-${i}`);
            if (wwHps) hps.ww.push(parseInt(wwHps.value) || 10);
            if (ptHps) hps.pt.push(parseInt(ptHps.value) || 10);
        }
        
        const qaHps = document.getElementById(`${q}-qa-hps-1`);
        if (qaHps) hps.qa.push(parseInt(qaHps.value) || 50);
        
        // Collect student scores
        const students = [];
        const tbody = document.getElementById(`${q}-body`);
        
        if (tbody) {
            tbody.querySelectorAll('tr[data-grade-id]').forEach(row => {
                const gradeId = row.dataset.gradeId;
                if (!gradeId) return;
                
                const scores = {
                    ww: [],
                    pt: [],
                    qa: []
                };
                
                row.querySelectorAll(`.${q}-ww`).forEach(input => {
                    scores.ww.push(parseFloat(input.value) || 0);
                });
                
                row.querySelectorAll(`.${q}-pt`).forEach(input => {
                    scores.pt.push(parseFloat(input.value) || 0);
                });
                
                row.querySelectorAll(`.${q}-qa`).forEach(input => {
                    scores.qa.push(parseFloat(input.value) || 0);
                });
                
                students.push({
                    grade_id: parseInt(gradeId),
                    scores: scores
                });
            });
        }
        
        // Send to backend
        const response = await fetch(window.API_SAVE_CLASSRECORD, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                class_record_id: currentClassRecordId,
                weights: weights,
                hps: hps,
                students: students
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Class record saved successfully!', 'success');
            unsavedChanges = false;
            
            // Show modal
            const modal = document.getElementById('saveModal');
            if (modal) {
                modal.style.display = 'block';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 2000);
            }
            
            // Reload history
            loadHistory();
        } else {
            showNotification(data.error || 'Failed to save class record', 'error');
        }
    } catch (error) {
        console.error('Error saving class record:', error);
        showNotification('Error saving class record. Please try again.', 'error');
    } finally {
        hideLoader();
    }
}


// Debounced auto-save
function debouncedAutoSave() {
    if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
    }
    
    autoSaveTimeout = setTimeout(() => {
        console.log('Auto-saving...');
        saveClassRecord();
    }, 5000); // 5 seconds after last change
}


function markUnsaved() {
    unsavedChanges = true;
}


// ============================================================================
// EXPORT FUNCTIONS
// ============================================================================

function exportToPdf() {
    if (!currentClassRecordId) {
        showNotification('No class record loaded', 'warning');
        return;
    }
    
    const url = window.API_EXPORT_PDF.replace('{id}', currentClassRecordId);
    
    showLoader('Generating PDF...');
    
    try {
        window.location.href = url;
        showNotification('PDF download started', 'success');
    } catch (error) {
        console.error('Error exporting PDF:', error);
        showNotification('Error exporting PDF. Please try again.', 'error');
    } finally {
        setTimeout(() => hideLoader(), 1000);
    }
}


function exportToExcel() {
    if (!currentClassRecordId) {
        showNotification('No class record loaded', 'warning');
        return;
    }
    
    const url = window.API_EXPORT_EXCEL.replace('{id}', currentClassRecordId);
    
    showLoader('Generating Excel file...');
    
    try {
        window.location.href = url;
        showNotification('Excel download started', 'success');
    } catch (error) {
        console.error('Error exporting Excel:', error);
        showNotification('Error exporting Excel. Please try again.', 'error');
    } finally {
        setTimeout(() => hideLoader(), 1000);
    }
}


// ============================================================================
// HISTORY SIDEBAR
// ============================================================================

async function loadHistory() {
    try {
        const response = await fetch(window.API_CLASSRECORD_HISTORY, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (data.success && data.history) {
            displayHistory(data.history);
        }
    } catch (error) {
        console.error('Error loading history:', error);
    }
}


function displayHistory(history) {
    const historyList = document.getElementById('history-list');
    const emptyMsg = document.getElementById('history-list-empty');
    
    if (!historyList) return;
    
    if (history.length === 0) {
        if (emptyMsg) emptyMsg.style.display = 'block';
        return;
    }
    
    if (emptyMsg) emptyMsg.style.display = 'none';
    historyList.innerHTML = '';
    
    history.forEach(log => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
            <strong>${log.action}</strong>
            <span>${log.date} at ${log.time}</span>
        `;
        historyList.appendChild(item);
    });
}


// ============================================================================
// TAB SWITCHING
// ============================================================================

function openTab(event, tabName) {
    // Hide all tab contents
    let tabContent = document.getElementsByClassName("tab-content");
    for (let i = 0; i < tabContent.length; i++) {
        tabContent[i].style.display = "none";
    }
    
    // Remove active class from all tabs
    let tabLinks = document.getElementsByClassName("tab-link");
    for (let i = 0; i < tabLinks.length; i++) {
        tabLinks[i].className = tabLinks[i].className.replace(" active", "");
    }
    
    // Show the current tab
    const tab = document.getElementById(tabName);
    if (tab) tab.style.display = "block";
    if (event?.currentTarget) event.currentTarget.className += " active";
    
    // Reload data when switching quarters (except Summary)
    if (tabName !== 'Summary') {
        const sectionId = document.getElementById('section-select')?.value;
        const subjectCode = document.getElementById('subject-select')?.value;
        
        if (sectionId && subjectCode) {
            loadClassRecord(sectionId, subjectCode, tabName);
        }
    }
}


// ============================================================================
// CALCULATION FUNCTIONS
// ============================================================================

function updateQuarterWeights(qNum) {
    let ww = Number(document.getElementById(`q${qNum}-ww-weight`)?.value) || 0;
    let pt = Number(document.getElementById(`q${qNum}-pt-weight`)?.value) || 0;
    let qa = Number(document.getElementById(`q${qNum}-qa-weight`)?.value) || 0;

    const wwHeader = document.getElementById(`q${qNum}-ww-header`);
    const ptHeader = document.getElementById(`q${qNum}-pt-header`);
    const qaHeader = document.getElementById(`q${qNum}-qa-header`);
    
    if (wwHeader) wwHeader.innerText = `Written Works (${ww}%)`;
    if (ptHeader) ptHeader.innerText = `Performance Tasks (${pt}%)`;
    if (qaHeader) qaHeader.innerText = `Quarterly Assessment (${qa}%)`;

    const wwWs = document.getElementById(`q${qNum}-ww-hps-ws`);
    const ptWs = document.getElementById(`q${qNum}-pt-hps-ws`);
    const qaWs = document.getElementById(`q${qNum}-qa-hps-ws`);
    
    if (wwWs) wwWs.innerText = (ww).toFixed(2);
    if (ptWs) ptWs.innerText = (pt).toFixed(2);
    if (qaWs) qaWs.innerText = (qa).toFixed(2);

    calculateQuarterGrades(qNum);
}


function calculateQuarterHPS(qNum) {
    let wwHpsTotal = 0;
    document.querySelectorAll(`#q${qNum}-table .hps-row .hps[id^="q${qNum}-ww-hps-"]`).forEach(input => {
        wwHpsTotal += Number(input.value) || 0;
    });
    const wwTotal = document.getElementById(`q${qNum}-ww-hps-total`);
    if (wwTotal) wwTotal.innerText = wwHpsTotal;

    let ptHpsTotal = 0;
    document.querySelectorAll(`#q${qNum}-table .hps-row .hps[id^="q${qNum}-pt-hps-"]`).forEach(input => {
        ptHpsTotal += Number(input.value) || 0;
    });
    const ptTotal = document.getElementById(`q${qNum}-pt-hps-total`);
    if (ptTotal) ptTotal.innerText = ptHpsTotal;
    
    let qaHpsTotal = Number(document.getElementById(`q${qNum}-qa-hps-1`)?.value) || 0;
    const qaTotal = document.getElementById(`q${qNum}-qa-hps-total`);
    if (qaTotal) qaTotal.innerText = qaHpsTotal;
    
    calculateQuarterGrades(qNum);
}


function calculateQuarterGrades(qNum) {
    const WW_WEIGHT = (Number(document.getElementById(`q${qNum}-ww-weight`)?.value) || 0) / 100;
    const PT_WEIGHT = (Number(document.getElementById(`q${qNum}-pt-weight`)?.value) || 0) / 100;
    const QA_WEIGHT = (Number(document.getElementById(`q${qNum}-qa-weight`)?.value) || 0) / 100;

    const wwHpsTotal = Number(document.getElementById(`q${qNum}-ww-hps-total`)?.innerText) || 1;
    const ptHpsTotal = Number(document.getElementById(`q${qNum}-pt-hps-total`)?.innerText) || 1;
    const qaHpsTotal = Number(document.getElementById(`q${qNum}-qa-hps-total`)?.innerText) || 1;

    const tbody = document.getElementById(`q${qNum}-body`);
    if (!tbody) return;
    
    tbody.querySelectorAll('tr[data-student-id]').forEach((row) => {
        // Calculate Written Works
        let wwTotal = 0;
        row.querySelectorAll(`.q${qNum}-ww`).forEach(input => {
            wwTotal += Number(input.value) || 0;
        });
        const wwPS = (wwTotal / wwHpsTotal) * 100;
        const wwWS = wwPS * WW_WEIGHT;
        
        const wwTotalCell = row.querySelector(`.q${qNum}-ww-total`);
        const wwPSCell = row.querySelector(`.q${qNum}-ww-ps`);
        const wwWSCell = row.querySelector(`.q${qNum}-ww-ws`);
        if (wwTotalCell) wwTotalCell.innerText = wwTotal.toFixed(2);
        if (wwPSCell) wwPSCell.innerText = wwPS.toFixed(2);
        if (wwWSCell) wwWSCell.innerText = wwWS.toFixed(2);

        // Calculate Performance Tasks
        let ptTotal = 0;
        row.querySelectorAll(`.q${qNum}-pt`).forEach(input => {
            ptTotal += Number(input.value) || 0;
        });
        const ptPS = (ptTotal / ptHpsTotal) * 100;
        const ptWS = ptPS * PT_WEIGHT;
        
        const ptTotalCell = row.querySelector(`.q${qNum}-pt-total`);
        const ptPSCell = row.querySelector(`.q${qNum}-pt-ps`);
        const ptWSCell = row.querySelector(`.q${qNum}-pt-ws`);
        if (ptTotalCell) ptTotalCell.innerText = ptTotal.toFixed(2);
        if (ptPSCell) ptPSCell.innerText = ptPS.toFixed(2);
        if (ptWSCell) ptWSCell.innerText = ptWS.toFixed(2);

        // Calculate Quarterly Assessment
        let qaTotal = 0;
        row.querySelectorAll(`.q${qNum}-qa`).forEach(input => {
            qaTotal += Number(input.value) || 0;
        });
        const qaPS = (qaTotal / qaHpsTotal) * 100;
        const qaWS = qaPS * QA_WEIGHT;
        
        const qaPSCell = row.querySelector(`.q${qNum}-qa-ps`);
        const qaWSCell = row.querySelector(`.q${qNum}-qa-ws`);
        if (qaPSCell) qaPSCell.innerText = qaPS.toFixed(2);
        if (qaWSCell) qaWSCell.innerText = qaWS.toFixed(2);

        // Calculate Final Grades
        const initialGrade = wwWS + ptWS + qaWS;
        const quarterlyGrade = transmute(initialGrade);
        
        const initialGradeCell = row.querySelector(`.q${qNum}-initial-grade`);
        const quarterlyGradeCell = row.querySelector(`.q${qNum}-quarterly-grade`);
        if (initialGradeCell) initialGradeCell.innerText = initialGrade.toFixed(2);
        if (quarterlyGradeCell) quarterlyGradeCell.innerText = quarterlyGrade;
        
        // Update summary if available
        calculateSummary(row.dataset.studentId);
    });
}


function calculateSummary(studentId) {
    const summaryRow = document.getElementById(`summary-student-${studentId}`);
    if (!summaryRow) return;

    let q1Grade = 0;
    let q2Grade = 0;
    let q3Grade = 0;
    let q4Grade = 0;

    const q1Row = document.getElementById(`q1-student-${studentId}`);
    if (q1Row) {
        const q1Cell = q1Row.querySelector('.q1-quarterly-grade');
        q1Grade = Number(q1Cell?.innerText) || 0;
    }
    
    const q2Row = document.getElementById(`q2-student-${studentId}`);
    if (q2Row) {
        const q2Cell = q2Row.querySelector('.q2-quarterly-grade');
        q2Grade = Number(q2Cell?.innerText) || 0;
    }
    
    const q3Row = document.getElementById(`q3-student-${studentId}`);
    if (q3Row) {
        const q3Cell = q3Row.querySelector('.q3-quarterly-grade');
        q3Grade = Number(q3Cell?.innerText) || 0;
    }

    const q4Row = document.getElementById(`q4-student-${studentId}`);
    if (q4Row) {
        const q4Cell = q4Row.querySelector('.q4-quarterly-grade');
        q4Grade = Number(q4Cell?.innerText) || 0;
    }
    
    const q1GradeCell = summaryRow.querySelector('.q1-grade');
    const q2GradeCell = summaryRow.querySelector('.q2-grade');
    const q3GradeCell = summaryRow.querySelector('.q3-grade');
    const q4GradeCell = summaryRow.querySelector('.q4-grade');
    
    if (q1GradeCell) q1GradeCell.innerText = q1Grade;
    if (q2GradeCell) q2GradeCell.innerText = q2Grade;
    if (q3GradeCell) q3GradeCell.innerText = q3Grade;
    if (q4GradeCell) q4GradeCell.innerText = q4Grade;

    const finalGrade = Math.round((q1Grade + q2Grade + q3Grade + q4Grade) / 4);
    
    const finalGradeCell = summaryRow.querySelector('.final-grade');
    if (finalGradeCell) finalGradeCell.innerText = finalGrade > 0 ? finalGrade : 0;
    
    const remarks = finalGrade >= 75 ? "PASSED" : (finalGrade > 0 ? "FAILED" : "---");
    const remarksCell = summaryRow.querySelector('.remarks');
    if (remarksCell) remarksCell.innerText = remarks;
}


function transmute(initialGrade) {
    if (initialGrade >= 100) return 100;
    if (initialGrade >= 98.40) return 99;
    if (initialGrade >= 96.80) return 98;
    if (initialGrade >= 95.20) return 97;
    if (initialGrade >= 93.60) return 96;
    if (initialGrade >= 92.00) return 95;
    if (initialGrade >= 90.40) return 94;
    if (initialGrade >= 88.80) return 93;
    if (initialGrade >= 87.20) return 92;
    if (initialGrade >= 85.60) return 91;
    if (initialGrade >= 84.00) return 90;
    if (initialGrade >= 82.40) return 89;
    if (initialGrade >= 80.80) return 88;
    if (initialGrade >= 79.20) return 87;
    if (initialGrade >= 77.60) return 86;
    if (initialGrade >= 76.00) return 85;
    if (initialGrade >= 74.40) return 84;
    if (initialGrade >= 72.80) return 83;
    if (initialGrade >= 71.20) return 82;
    if (initialGrade >= 69.60) return 81;
    if (initialGrade >= 68.00) return 80;
    if (initialGrade >= 66.40) return 79;
    if (initialGrade >= 64.80) return 78;
    if (initialGrade >= 63.20) return 77;
    if (initialGrade >= 61.60) return 76;
    if (initialGrade >= 60.00) return 75;
    if (initialGrade >= 56.00) return 74;
    if (initialGrade >= 52.00) return 73;
    if (initialGrade >= 48.00) return 72;
    if (initialGrade >= 44.00) return 71;
    if (initialGrade >= 40.00) return 70;
    if (initialGrade >= 36.00) return 69;
    if (initialGrade >= 32.00) return 68;
    if (initialGrade >= 28.00) return 67;
    if (initialGrade >= 24.00) return 66;
    if (initialGrade >= 20.00) return 65;
    if (initialGrade >= 16.00) return 64;
    if (initialGrade >= 12.00) return 63;
    if (initialGrade >= 8.00) return 62;
    if (initialGrade >= 4.00) return 61;
    if (initialGrade >= 0) return 60;
    return 0;
}


// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}


function showLoader(message) {
    const loader = document.getElementById('main-loader');
    if (loader) {
        loader.style.display = 'block';
    }
}


function hideLoader() {
    const loader = document.getElementById('main-loader');
    if (loader) {
        loader.style.display = 'none';
    }
}


function showNotification(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // Create toast notification
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 500;
        ${type === 'success' ? 'background: #10b981;' : ''}
        ${type === 'error' ? 'background: #ef4444;' : ''}
        ${type === 'warning' ? 'background: #f59e0b;' : ''}
        ${type === 'info' ? 'background: #3b82f6;' : ''}
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function calculateRequiredPerformance(studentGrade, classRecord) {
    const ww_weight = classRecord.written_works_weight / 100;
    const pt_weight = classRecord.performance_tasks_weight / 100;
    const qa_weight = classRecord.quarterly_assessment_weight / 100;
    
    // Current status
    const current_ww_ws = studentGrade.ww_weighted_score;
    const current_pt_ws = studentGrade.pt_weighted_score;
    const current_qa_ws = studentGrade.qa_weighted_score;
    const current_initial_grade = studentGrade.initial_grade;
    
    // Target: Initial Grade ≈ 60 → Transmutes to 75
    const target_initial_grade = 60.0;
    const points_needed = target_initial_grade - current_initial_grade;
    
    // Check if QA is done
    const qa_done = studentGrade.qa_score_1 > 0;
    
    let result = {
        current_grade: studentGrade.quarterly_grade,
        target_grade: 75,
        points_needed: Math.max(0, points_needed),
        qa_completed: qa_done,
        warning_type: qa_done ? 'failed' : 'at_risk'
    };
    
    // ============================================================
    // CASE 1: QA NOT DONE (Quarter In Progress)
    // ============================================================
    if (!qa_done) {
        // Calculate current AVERAGES (not totals)
        const ww_scores = studentGrade.get_ww_scores_list();
        const pt_scores = studentGrade.get_pt_scores_list();
        
        const ww_completed_scores = ww_scores.filter(s => s > 0);
        const pt_completed_scores = pt_scores.filter(s => s > 0);
        
        const ww_current_avg = ww_completed_scores.length > 0 
            ? (ww_completed_scores.reduce((a, b) => a + b, 0) / ww_completed_scores.length) 
            : 0;
        
        const pt_current_avg = pt_completed_scores.length > 0
            ? (pt_completed_scores.reduce((a, b) => a + b, 0) / pt_completed_scores.length)
            : 0;
        
        // Calculate what PERCENTAGE they need on remaining work
        // Formula: (Target WS - Current WS) / Weight = Required Percentage
        
        // For WW: How much of the WW component is left?
        const ww_ps_current = studentGrade.ww_percentage;
        const ww_ps_needed = ((target_initial_grade * ww_weight) - current_ww_ws) / ww_weight;
        const ww_improvement_needed = Math.max(0, ww_ps_needed - ww_ps_current);
        
        // For PT: Same calculation
        const pt_ps_current = studentGrade.pt_percentage;
        const pt_ps_needed = ((target_initial_grade * pt_weight) - current_pt_ws) / pt_weight;
        const pt_improvement_needed = Math.max(0, pt_ps_needed - pt_ps_current);
        
        // For QA: Simple calculation
        const qa_ps_needed = ((target_initial_grade * qa_weight) - current_qa_ws) / qa_weight;
        
        result.advice = {
            ww: {
                current_avg: ww_current_avg.toFixed(1),
                current_percentage: ww_ps_current.toFixed(1),
                needed_percentage: Math.min(100, ww_ps_needed).toFixed(1),
                improvement_needed: ww_improvement_needed.toFixed(1),
                message: ww_improvement_needed > 0 
                    ? `Improve average from ${ww_current_avg.toFixed(1)}/10 to maintain at least ${ww_ps_needed.toFixed(0)}% in Written Works`
                    : `Maintain current performance in Written Works`
            },
            pt: {
                current_avg: pt_current_avg.toFixed(1),
                current_percentage: pt_ps_current.toFixed(1),
                needed_percentage: Math.min(100, pt_ps_needed).toFixed(1),
                improvement_needed: pt_improvement_needed.toFixed(1),
                message: pt_improvement_needed > 0
                    ? `Improve average from ${pt_current_avg.toFixed(1)}/10 to maintain at least ${pt_ps_needed.toFixed(0)}% in Performance Tasks`
                    : `Maintain current performance in Performance Tasks`
            },
            qa: {
                needed_percentage: Math.min(100, qa_ps_needed).toFixed(1),
                needed_score: Math.min(classRecord.qa_hps_1, Math.max(0, (qa_ps_needed / 100) * classRecord.qa_hps_1)).toFixed(1),
                message: `Score at least ${Math.min(classRecord.qa_hps_1, Math.max(0, (qa_ps_needed / 100) * classRecord.qa_hps_1)).toFixed(0)}/${classRecord.qa_hps_1} on the Quarterly Assessment`
            },
            overall_message: points_needed > 0 
                ? `Student needs ${points_needed.toFixed(1)} more points to reach passing grade.`
                : `Student is on track but needs to maintain performance.`
        };
    }
    
    // ============================================================
    // CASE 2: QA DONE (Quarter Complete)
    // ============================================================
    else {
        result.advice = {
            message: `Quarter is complete. Student scored ${studentGrade.quarterly_grade} (below passing grade of 75).`,
            intervention_required: true,
            components: {
                ww: {
                    percentage: studentGrade.ww_percentage.toFixed(1),
                    weighted: studentGrade.ww_weighted_score.toFixed(2)
                },
                pt: {
                    percentage: studentGrade.pt_percentage.toFixed(1),
                    weighted: studentGrade.pt_weighted_score.toFixed(2)
                },
                qa: {
                    percentage: studentGrade.qa_percentage.toFixed(1),
                    weighted: studentGrade.qa_weighted_score.toFixed(2)
                }
            }
        };
    }
    
    return result;
}


// ============================================================================
// EARLY WARNING SYSTEM - NEW FUNCTIONS
// ============================================================================

// Global state for warnings
let activeWarnings = {};
let currentWarningData = null;

/**
 * Check for early warnings after calculating grades
 * Call this after calculateQuarterGrades() completes
 */
async function checkEarlyWarnings(qNum) {
    if (!currentClassRecordId) return;
    
    console.log(`Checking early warnings for Q${qNum}...`);
    
    try {
        const response = await fetch("{% url 'teacher:api-check-warnings' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                class_record_id: currentClassRecordId,
                quarter: `Q${qNum}`
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('Warnings checked:', data.warnings_created);
            
            // Fetch and apply highlights
            await loadAndApplyWarnings(qNum);
        }
    } catch (error) {
        console.error('Error checking warnings:', error);
    }
}

/**
 * Load warnings from server and apply visual highlights
 */
async function loadAndApplyWarnings(qNum) {
    if (!currentClassRecordId) return;
    
    try {
        const response = await fetch(`{% url 'teacher:api-get-warnings' %}?class_record_id=${currentClassRecordId}`, {
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            activeWarnings = {};
            
            // Store warnings by student_id for quick lookup
            data.warnings.forEach(warning => {
                activeWarnings[warning.student_id] = warning;
            });
            
            // Apply visual highlights to table
            applyWarningHighlights(qNum);
            
            console.log(`Applied ${data.warnings.length} warning highlights`);
        }
    } catch (error) {
        console.error('Error loading warnings:', error);
    }
}

/**
 * Apply visual highlights to student name cells
 */
function applyWarningHighlights(qNum) {
    const tbody = document.getElementById(`q${qNum}-body`);
    if (!tbody) return;
    
    tbody.querySelectorAll('tr[data-student-id]').forEach((row) => {
        const studentId = row.dataset.studentId;
        const nameCell = row.querySelector('.student-name');
        
        if (!nameCell) return;
        
        // Remove existing highlights
        nameCell.classList.remove('at-risk-highlight', 'failed-highlight');
        const existingBadge = nameCell.querySelector('.warning-badge');
        if (existingBadge) existingBadge.remove();
        
        // Check if this student has an active warning
        const warning = activeWarnings[studentId];
        
        if (warning) {
            // Apply appropriate highlight
            if (warning.warning_type === 'failed') {
                nameCell.classList.add('failed-highlight');
                nameCell.innerHTML += ' <i class="fa-solid fa-circle-exclamation warning-badge"></i>';
            } else if (warning.warning_type === 'at_risk') {
                nameCell.classList.add('at-risk-highlight');
                nameCell.innerHTML += ' <i class="fa-solid fa-triangle-exclamation warning-badge"></i>';
            }
            
            // Make clickable
            nameCell.style.cursor = 'pointer';
            nameCell.dataset.warningId = warning.id;
            
            // Add click event
            nameCell.onclick = () => showWarningModal(warning);
        }
    });
}

/**
 * Show warning modal with student details
 */
function showWarningModal(warning) {
    currentWarningData = warning;
    
    const modal = document.getElementById('warningModal');
    const header = document.getElementById('warning-modal-header');
    const title = document.getElementById('warning-modal-title');
    const statusText = document.getElementById('warning-status-text');
    
    const atRiskContent = document.getElementById('warning-at-risk-content');
    const failedContent = document.getElementById('warning-failed-content');
    
    // Update modal styling based on warning type
    if (warning.warning_type === 'failed') {
        modal.classList.add('failed-warning');
        header.style.backgroundColor = '#dc3545';
        header.style.color = 'white';
        title.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Student Has Failed';
        statusText.textContent = 'has not achieved the passing grade';
        
        // Show failed content, hide at-risk content
        atRiskContent.style.display = 'none';
        failedContent.style.display = 'block';
        
        // Enable intervention button
        document.getElementById('btn-create-intervention').disabled = false;
        document.getElementById('btn-create-intervention').style.opacity = '1';
        
        // Populate breakdown
        const advice = warning.required_performance.advice;
        if (advice && advice.components) {
            document.getElementById('warning-breakdown').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="background: white; padding: 12px; border-radius: 5px; border: 1px solid #ddd;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Written Works</div>
                        <div style="font-size: 20px; font-weight: bold;">${advice.components.ww.percentage}%</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Weighted: ${advice.components.ww.weighted} pts</div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border: 1px solid #ddd;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Performance Tasks</div>
                        <div style="font-size: 20px; font-weight: bold;">${advice.components.pt.percentage}%</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Weighted: ${advice.components.pt.weighted} pts</div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border: 1px solid #ddd; grid-column: span 2;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Quarterly Assessment</div>
                        <div style="font-size: 20px; font-weight: bold;">${advice.components.qa.percentage}%</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Weighted: ${advice.components.qa.weighted} pts</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 5px;">
                    <strong>Final Initial Grade:</strong> ${warning.required_performance.current_grade} (Transmuted: ${warning.current_grade})
                </div>
            `;
        }
        
    } else {
        // AT-RISK
        modal.classList.remove('failed-warning');
        header.style.backgroundColor = '#ffc107';
        header.style.color = '#000';
        title.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Student At Risk';
        statusText.textContent = 'is at risk of failing';
        
        // Show at-risk content, hide failed content
        atRiskContent.style.display = 'block';
        failedContent.style.display = 'none';
        
        // Disable intervention button
        document.getElementById('btn-create-intervention').disabled = true;
        document.getElementById('btn-create-intervention').style.opacity = '0.5';
        
        // Populate current performance
        const advice = warning.required_performance.advice;
        if (advice) {
            document.getElementById('warning-current-performance').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #007bff;">
                        <div style="font-weight: bold; margin-bottom: 5px;">📝 Written Works</div>
                        <div style="color: #666; font-size: 14px;">
                            Average: ${advice.ww.current_avg}/10 (${advice.ww.current_percentage}%)
                        </div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #28a745;">
                        <div style="font-weight: bold; margin-bottom: 5px;">📋 Performance Tasks</div>
                        <div style="color: #666; font-size: 14px;">
                            Average: ${advice.pt.current_avg}/10 (${advice.pt.current_percentage}%)
                        </div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <div style="font-weight: bold; margin-bottom: 5px;">📄 Quarterly Assessment</div>
                        <div style="color: #666; font-size: 14px;">
                            Not yet taken
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('warning-requirements').innerHTML = `
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li style="padding: 12px; margin-bottom: 10px; background: white; border-left: 4px solid #007bff; border-radius: 4px;">
                        <i class="fa-solid fa-arrow-trend-up" style="color: #007bff; margin-right: 8px;"></i>
                        ${advice.ww.message}
                    </li>
                    <li style="padding: 12px; margin-bottom: 10px; background: white; border-left: 4px solid #28a745; border-radius: 4px;">
                        <i class="fa-solid fa-arrow-trend-up" style="color: #28a745; margin-right: 8px;"></i>
                        ${advice.pt.message}
                    </li>
                    <li style="padding: 12px; background: white; border-left: 4px solid #ffc107; border-radius: 4px;">
                        <i class="fa-solid fa-bullseye" style="color: #ffc107; margin-right: 8px;"></i>
                        ${advice.qa.message}
                    </li>
                </ul>
                <div style="margin-top: 15px; padding: 12px; background: #f1f3f5; border-radius: 5px; text-align: center;">
                    <strong style="color: #495057;">Overall:</strong> 
                    <span style="color: #666;">${advice.overall_message}</span>
                </div>
            `;
        }
    }
    
    // Populate student info
    document.getElementById('warning-student-name').textContent = warning.student_name;
    document.getElementById('warning-current-grade').textContent = warning.current_grade;
    
    // Get subject and quarter from current class record
    const subjectSelect = document.getElementById('subject-select');
    const subjectText = subjectSelect.options[subjectSelect.selectedIndex]?.text || 'Unknown Subject';
    const activeTab = document.querySelector('.tab-link.active');
    const quarterText = activeTab?.textContent || 'Unknown Quarter';
    
    document.getElementById('warning-subject').textContent = subjectText;
    document.getElementById('warning-quarter').textContent = quarterText;
    
    // Show modal
    modal.style.display = 'block';
}

/**
 * Close warning modal
 */
function closeWarningModal() {
    const modal = document.getElementById('warningModal');
    modal.style.display = 'none';
    currentWarningData = null;
}

/**
 * Dismiss warning (mark as dismissed in database)
 */
async function dismissWarning() {
    if (!currentWarningData) return;
    
    try {
        const response = await fetch("{% url 'teacher:api-dismiss-warning' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                warning_id: currentWarningData.id,
                notes: 'Dismissed by teacher'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Warning dismissed', 'info');
            closeWarningModal();
            
            // Refresh warnings
            const activeTab = document.querySelector('.tab-content[style*="display: block"]');
            if (activeTab) {
                const qNum = activeTab.id.replace('Q', '');
                await loadAndApplyWarnings(qNum);
            }
        }
    } catch (error) {
        console.error('Error dismissing warning:', error);
        showNotification('Error dismissing warning', 'error');
    }
}

/**
 * Create intervention from warning (redirect to intervention page)
 */
function createInterventionFromWarning() {
    if (!currentWarningData) return;
    
    // Get current context
    const sectionSelect = document.getElementById('section-select');
    const subjectSelect = document.getElementById('subject-select');
    const activeTab = document.querySelector('.tab-link.active');
    
    const sectionName = sectionSelect.options[sectionSelect.selectedIndex]?.text || '';
    const subjectCode = subjectSelect.value || '';
    const subjectName = subjectSelect.options[subjectSelect.selectedIndex]?.text || '';
    const quarter = activeTab?.getAttribute('data-quarter') || 'Q1';
    
    // Build redirect URL with query params
    const params = new URLSearchParams({
        student_id: currentWarningData.student_id,
        student_name: currentWarningData.student_name,
        subject_code: subjectCode,
        subject_name: subjectName,
        quarter: quarter,
        grade: currentWarningData.current_grade,
        section: sectionName,
        reason: 'failing',
        warning_id: currentWarningData.id
    });
    
    // Redirect to intervention page
    window.location.href = `{% url 'teacher:adviser-intervention' %}?${params.toString()}`;
}

/**
 * Initialize early warning system when page loads
 */
function initializeEarlyWarningSystem() {
    console.log('Initializing Early Warning System...');
    
    // Load warnings for current quarter
    const activeTab = document.querySelector('.tab-content[style*="display: block"]');
    if (activeTab && currentClassRecordId) {
        const qNum = activeTab.id.replace('Q', '');
        loadAndApplyWarnings(qNum);
    }
}

// ============================================================================
// MODIFY EXISTING FUNCTIONS TO INTEGRATE WARNING SYSTEM
// ============================================================================

// UPDATE: Modify your existing calculateQuarterGrades function
// Add this at the END of the calculateQuarterGrades function:

// Find this function and add to the end:
function calculateQuarterGrades(qNum) {
    // ... your existing calculation code ...
    
    // ADD THIS AT THE END:
    // Check for early warnings after calculations complete
    checkEarlyWarnings(qNum);
}

// UPDATE: Modify your existing DOMContentLoaded event
// Find the existing DOMContentLoaded and add this inside it:

document.addEventListener('DOMContentLoaded', () => {
    // ... your existing initialization code ...
    
    // ADD THIS AFTER YOUR EXISTING CODE:
    // Initialize early warning system
    setTimeout(() => {
        initializeEarlyWarningSystem();
    }, 1000); // Small delay to ensure everything else is loaded
    
    console.log('✓ Early Warning System initialized');
});
</script>

</body>
</html>