{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intervention System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f1f5f9;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    #sidebar-root { width: 240px; min-width: 240px; }
    .main-area { margin-left: 240px; }
    .modal-backdrop { transition: opacity 0.18s ease; }
    .tab-button {
      padding: 8px 16px;
      font-size: 0.875rem;
      font-weight: 500;
      color: #334155;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .tab-button:hover { background-color: #f1f5f9; }
    .tab-button.active {
      color: #1e40af;
      border-bottom-color: #1e40af;
    }
    .tab-content { display: none; padding-top: 1.5rem; }
    .tab-content.active { display: block; }
    .muted { color: #64748b; }
  </style>
</head>
<body>
  
  {% include 'teacher/adviser/sidebar.html' %}

  <div id="app" class="flex flex-col min-h-screen main-area">
    <header class="bg-white border-b border-slate-200 px-4 sm:px-6 lg:px-8 py-4 sticky top-0 z-20">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="bg-blue-800 p-3 rounded-lg flex items-center justify-center">
            <i class="fa-solid fa-chart-line fa-lg text-white"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-slate-900">Student Intervention System</h1>
            <p id="header-subtitle" class="text-sm text-slate-600">{{ sections.first.name }} • Quarter 1</p>
          </div>
        </div>

        <div class="flex items-center gap-6">
          <div class="flex items-center gap-3">
            <label for="section-select" class="text-sm font-medium text-slate-700">Section:</label>
            <select id="section-select" class="rounded-lg border border-slate-300 bg-white py-2 px-3 text-slate-700 shadow-sm focus:border-blue-600 focus:ring focus:ring-blue-100 transition-all cursor-pointer font-medium">
              {% for section in sections %}
              <option value="{{ section.id }}" {% if forloop.first %}selected{% endif %}>{{ section.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="flex items-center gap-3">
            <label for="quarter-select" class="text-sm font-medium text-slate-700">Quarter:</label>
            <select id="quarter-select" class="rounded-lg border border-slate-300 bg-white py-2 px-3 text-slate-700 shadow-sm focus:border-blue-600 focus:ring focus:ring-blue-100 transition-all cursor-pointer font-medium">
              {% for quarter in quarters %}
              <option value="{{ quarter }}" {% if quarter == 'Q1' %}selected{% endif %}>Quarter {{ quarter|slice:"1:" }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="flex items-center gap-3">
            <label for="subject-select" class="text-sm font-medium text-slate-700">Subject:</label>
            <select id="subject-select" class="rounded-lg border border-slate-300 bg-white py-2 px-3 text-slate-700 shadow-sm focus:border-blue-600 focus:ring focus:ring-blue-100 transition-all cursor-pointer font-medium">
              <option value="">All Subjects</option>
              {% for subject in subjects %}
              <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="w-px h-10 bg-slate-200"></div>

          <div class="text-right">
            <div class="font-semibold text-slate-900">{{ teacher.full_name }}</div>
            <div class="text-sm text-slate-500">{{ teacher.position }} • {{ teacher.department }}</div>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-grow p-4 sm:p-6 lg:p-8">
      <div class="max-w-8xl mx-auto">
        <section id="student-overview">
          <h2 class="text-lg font-semibold text-slate-800 mb-4">Student Overview</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 flex items-center justify-between">
              <div>
                <div class="text-sm font-medium text-slate-500">Total Students</div>
                <div id="stat-total" class="text-3xl font-bold text-slate-900">0</div>
              </div>
              <div class="bg-blue-100 text-blue-700 p-3 rounded-full"><i class="fa-solid fa-users fa-lg"></i></div>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 flex items-center justify-between">
              <div>
                <div class="text-sm font-medium text-slate-500">Critical Risk</div>
                <div id="stat-critical" class="text-3xl font-bold text-red-600">0</div>
              </div>
              <div class="bg-red-100 text-red-600 p-3 rounded-full"><i class="fa-solid fa-triangle-exclamation fa-lg"></i></div>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 flex items-center justify-between">
              <div>
                <div class="text-sm font-medium text-slate-500">At Risk</div>
                <div id="stat-at-risk" class="text-3xl font-bold text-yellow-500">0</div>
              </div>
              <div class="bg-yellow-100 text-yellow-500 p-3 rounded-full"><i class="fa-solid fa-exclamation-circle fa-lg"></i></div>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 flex items-center justify-between">
              <div>
                <div class="text-sm font-medium text-slate-500">On Track</div>
                <div id="stat-on-track" class="text-3xl font-bold text-green-600">0</div>
              </div>
              <div class="bg-green-100 text-green-600 p-3 rounded-full"><i class="fa-solid fa-check-circle fa-lg"></i></div>
            </div>
          </div>
        </section>

        <section id="student-list" class="mt-8">
          <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row items-center justify-between gap-4">
              <h3 id="student-list-title" class="text-lg font-semibold text-slate-800">Student List (0)</h3>
              <div class="flex items-center gap-4 w-full sm:w-auto">
                <div class="relative w-full sm:w-64">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><i class="fa fa-search"></i></span>
                  <input id="search-input" type="search" placeholder="Search by name or LRN..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 focus:border-blue-600 focus:ring-1 focus:ring-blue-600 outline-none transition" />
                </div>

                <select id="filter-risk" class="rounded-lg border border-slate-300 bg-white py-2 px-3 text-slate-700 shadow-sm focus:border-blue-600 focus:ring focus:ring-blue-100 transition cursor-pointer">
                  <option value="all">All Risk Levels</option>
                  <option value="Critical">Critical</option>
                  <option value="At Risk">At Risk</option>
                  <option value="On Track">On Track</option>
                </select>

                <select id="filter-intervention" class="rounded-lg border border-slate-300 bg-white py-2 px-3 text-slate-700 shadow-sm focus:border-blue-600 focus:ring focus:ring-blue-100 transition cursor-pointer">
                  <option value="all">All Interventions</option>
                  <option value="Tier 3">Tier 3: Intensive</option>
                  <option value="Tier 2">Tier 2: Targeted</option>
                  <option value="Tier 1">Tier 1: Prevention</option>
                  <option value="None">No Intervention</option>
                </select>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="px-5 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">LRN</th>
                    <th class="px-5 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student Name</th>
                    <th class="px-5 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Sex</th>
                    <th class="px-5 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Current Grade</th>
                    <th class="px-5 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Absences</th>
                    <th class="px-5 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Missing Work</th>
                    <th class="px-5 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Risk Level</th>
                    <th class="px-5 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Intervention</th>
                    <th class="px-5 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Action</th>
                  </tr>
                </thead>
                <tbody id="student-table-body" class="divide-y divide-slate-200">
                  <tr>
                    <td colspan="9" class="px-5 py-10 text-center text-slate-500">Loading students...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Modal continues... -->
  <div id="details-modal-backdrop" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none modal-backdrop">
    <div id="details-modal" class="bg-slate-50 w-full max-w-4xl rounded-lg shadow-2xl max-h-[90vh] flex flex-col overflow-hidden transform scale-95 transition-all">
      <div class="flex items-start justify-between p-5 border-b border-slate-200 bg-white">
        <div>
          <h2 class="text-xl font-bold text-slate-900">Student Intervention Plan</h2>
          <p class="text-sm text-slate-600">Detailed intervention strategy and progress monitoring</p>
          <div class="mt-4">
            <h3 id="modal-student-name" class="text-lg font-semibold text-slate-800">Student Name</h3>
            <p id="modal-student-meta" class="text-sm text-slate-500">LRN: - • Sex: - • Age: -</p>
          </div>
        </div>
        <button id="btn-close-modal" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark fa-2x"></i></button>
      </div>

      <div class="p-6 overflow-y-auto">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="text-sm font-medium text-slate-500">Current Grade</div>
            <div id="modal-grade" class="text-4xl font-bold text-slate-800">-</div>
          </div>
          <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="text-sm font-medium text-slate-500">Absences</div>
            <div id="modal-absences" class="text-4xl font-bold text-slate-800">-</div>
          </div>
          <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="text-sm font-medium text-slate-500">Missing Work</div>
            <div id="modal-missing-work" class="text-4xl font-bold text-slate-800">-</div>
          </div>
        </div>

        <div class="mt-6 border-b border-slate-300">
          <nav id="modal-tab-nav" class="flex -mb-px">
            <button class="tab-button active" data-tab="risk">Risk Assessment</button>
            <button class="tab-button" data-tab="strategies">Intervention Strategies</button>
            <button class="tab-button" data-tab="active">Active Interventions</button>
            <button class="tab-button" data-tab="action">Action Plan</button>
          </nav>
        </div>

        <div id="modal-tab-content" class="bg-white border border-t-0 border-slate-200 rounded-b-lg p-6">
          <!-- Tab contents will be populated dynamically -->
          <div id="tab-content-risk" class="tab-content active"></div>
          <div id="tab-content-strategies" class="tab-content"></div>
          <div id="tab-content-active" class="tab-content">
            <div id="active-interventions-list" class="space-y-4"></div>
            
            <div class="mt-6 border-t border-slate-200 pt-6">
              <h4 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-plus-circle mr-2 text-blue-600"></i>Add New Intervention</h4>
              <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="input-inter-tier" class="block text-sm font-medium text-slate-700 mb-1">Intervention Tier *</label>
                    <select id="input-inter-tier" class="w-full rounded-lg border border-slate-300 bg-white py-2 px-3 text-slate-700 shadow-sm focus:border-blue-600 focus:ring-1">
                      <option value="Tier 1">Tier 1: Prevention</option>
                      <option value="Tier 2">Tier 2: Targeted Support</option>
                      <option value="Tier 3">Tier 3: Intensive Intervention</option>
                    </select>
                  </div>
                  <div>
                    <label for="input-inter-type" class="block text-sm font-medium text-slate-700 mb-1">Action Type *</label>
                    <select id="input-inter-type" class="w-full rounded-lg border border-slate-300 bg-white py-2 px-3 text-slate-700 shadow-sm focus:border-blue-600 focus:ring-1">
                      <option value="Student Conference">Student Conference</option>
                      <option value="Parent Contact">Parent Contact</option>
                      <option value="Tutoring Session">Tutoring Session</option>
                      <option value="Makeup Work">Makeup Work Opportunity</option>
                      <option value="Behavior Plan">Behavior Plan</option>
                      <option value="Counseling Referral">Counseling Referral</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                </div>
                
                <div>
                  <label for="input-inter-name" class="block text-sm font-medium text-slate-700 mb-1">Strategy Name *</label>
                  <input id="input-inter-name" type="text" placeholder="e.g., One-on-one tutoring sessions" class="w-full rounded-lg border border-slate-300 p-2 focus:border-blue-600 focus:ring-1" />
                </div>

                <div>
                  <label for="input-inter-desc" class="block text-sm font-medium text-slate-700 mb-1">Description *</label>
                  <textarea id="input-inter-desc" rows="3" class="w-full rounded-lg border border-slate-300 p-2 focus:border-blue-600 focus:ring-1" placeholder="Describe the intervention strategy in detail"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label for="input-inter-start" class="block text-sm font-medium text-slate-700 mb-1">Start Date *</label>
                    <input id="input-inter-start" type="date" class="w-full rounded-lg border border-slate-300 p-2 text-slate-700 focus:border-blue-600 focus:ring-1" />
                  </div>
                  <div>
                    <label for="input-inter-target" class="block text-sm font-medium text-slate-700 mb-1">Target Date</label>
                    <input id="input-inter-target" type="date" class="w-full rounded-lg border border-slate-300 p-2 text-slate-700 focus:border-blue-600 focus:ring-1" />
                  </div>
                  <div>
                    <label for="input-inter-status" class="block text-sm font-medium text-slate-700 mb-1">Status *</label>
                    <select id="input-inter-status" class="w-full rounded-lg border border-slate-300 bg-white py-2 px-3 text-slate-700 shadow-sm focus:border-blue-600 focus:ring-1">
                      <option value="Planned">Planned</option>
                      <option value="In Progress">In Progress</option>
                      <option value="Completed">Completed</option>
                      <option value="Not Completed">Not Completed</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label for="input-inter-progress" class="block text-sm font-medium text-slate-700 mb-1">Progress Update</label>
                  <textarea id="input-inter-progress" rows="3" class="w-full rounded-lg border border-slate-300 p-2 focus:border-blue-600 focus:ring-1" placeholder="Document student progress and observations"></textarea>
                </div>
                
                <div>
                  <label for="input-inter-notes" class="block text-sm font-medium text-slate-700 mb-1">Teacher Notes</label>
                  <textarea id="input-inter-notes" rows="3" class="w-full rounded-lg border border-slate-300 p-2 focus:border-blue-600 focus:ring-1" placeholder="Additional notes, observations, or recommendations"></textarea>
                </div>

                <div>
                  <button id="btn-save-new-intervention" class="w-full md:w-auto inline-flex items-center justify-center gap-2 px-6 py-2 bg-blue-700 text-white font-semibold rounded-lg hover:bg-blue-800 transition shadow-sm">
                    <i class="fa-solid fa-save"></i> Save Intervention
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div id="tab-content-action" class="tab-content"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CSRF_TOKEN = '{{ csrf_token }}';
    let currentStudentData = [];
    let activeModalStudent = null;
    let activeInterventionId = null;

    // Utility functions
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function getGradeClass(grade) {
      if (grade < 75) return "text-red-600 font-bold";
      if (grade >= 75 && grade <= 79) return "text-yellow-600 font-bold";
      return "text-slate-800";
    }

    function getRiskBadge(level) {
      if (level === "Critical") {
        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><i class="fa-solid fa-triangle-exclamation mr-1.5"></i> Critical</span>`;
      }
      if (level === "At Risk") {
        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fa-solid fa-exclamation-circle mr-1.5"></i> At Risk</span>`;
      }
      return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fa-solid fa-check-circle mr-1.5"></i> On Track</span>`;
    }

    function getInterventionBadge(tier) {
      if (tier === "Tier 3") {
        return `<span class="inline-flex px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Tier 3: Intensive</span>`;
      }
      if (tier === "Tier 2") {
        return `<span class="inline-flex px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Tier 2: Targeted</span>`;
      }
      if (tier === "Tier 1") {
        return `<span class="inline-flex px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Tier 1: Prevention</span>`;
      }
      return `<span class="inline-flex px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600">No Intervention</span>`;
    }

    // Load students for selected section/quarter
    async function loadStudents() {
      const sectionId = document.getElementById('section-select').value;
      const quarter = document.getElementById('quarter-select').value;
      const subjectId = document.getElementById('subject-select').value;

      if (!sectionId) return;

      const tbody = document.getElementById('student-table-body');
      tbody.innerHTML = '<tr><td colspan="9" class="px-5 py-10 text-center text-slate-500">Loading students...</td></tr>';

      try {
        const url = new URL('{% url "teacher:api-intervention-students" %}', window.location.origin);
        url.searchParams.append('section_id', sectionId);
        url.searchParams.append('quarter', quarter);
        if (subjectId) url.searchParams.append('subject_id', subjectId);

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
          currentStudentData = data.students;
          
          // Update stats
          document.getElementById('stat-total').textContent = data.stats.total;
          document.getElementById('stat-critical').textContent = data.stats.critical;
          document.getElementById('stat-at-risk').textContent = data.stats.at_risk;
          document.getElementById('stat-on-track').textContent = data.stats.on_track;
          document.getElementById('student-list-title').textContent = `Student List (${data.stats.total})`;

          renderTable();
        } else {
          tbody.innerHTML = `<tr><td colspan="9" class="px-5 py-10 text-center text-red-500">${data.error}</td></tr>`;
        }
      } catch (error) {
        console.error('Error loading students:', error);
        tbody.innerHTML = '<tr><td colspan="9" class="px-5 py-10 text-center text-red-500">Error loading students</td></tr>';
      }
    }

    // Render table with current filters
    function renderTable() {
  const tbody = document.getElementById('student-table-body');
  const search = document.getElementById('search-input').value.toLowerCase();
  const riskFilter = document.getElementById('filter-risk').value;
  const interventionFilter = document.getElementById('filter-intervention').value;

  const filtered = currentStudentData.filter((s) => {
    const matchesSearch = s.name.toLowerCase().includes(search) || s.lrn.includes(search);
    const matchesRisk = riskFilter === 'all' || s.risk_level === riskFilter;
    const matchesIntervention = interventionFilter === 'all' || 
      (interventionFilter === 'None' && !s.has_intervention) ||
      (s.intervention_tier && s.intervention_tier.includes(interventionFilter));
    return matchesSearch && matchesRisk && matchesIntervention;
  });

  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="9" class="px-5 py-10 text-center text-slate-500">No students match the current filters.</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(s => {
    // Calculate missing work with context
    const totalAssigned = (s.active_ww_count || 0) + (s.active_pt_count || 0);
    const missingWork = s.missing_work;
    const missingPercentage = totalAssigned > 0 ? Math.round((missingWork / totalAssigned) * 100) : 0;
    
    // Determine badge style
    let badgeClass = 'normal';
    if (missingPercentage >= 40) badgeClass = 'critical';
    else if (missingPercentage >= 20) badgeClass = 'warning';
    
    // Create detailed tooltip
    const tooltip = `WW: ${s.missing_ww}/${s.active_ww_count || 0} | PT: ${s.missing_pt}/${s.active_pt_count || 0}`;
    
    // Format missing work display
    const missingWorkHTML = missingWork > 0 
      ? `<span class="missing-work-badge ${badgeClass} work-detail-tooltip" data-tooltip="${tooltip}">
           ${missingWork} / ${totalAssigned}
           <i class="fa-solid fa-circle-info" style="font-size: 10px; opacity: 0.7;"></i>
         </span>`
      : `<span style="color: #10b981; font-weight: 500;">
           <i class="fa-solid fa-check-circle mr-1"></i>Complete
         </span>`;
    
    return `
      <tr class="hover:bg-slate-50 transition ${s.risk_level === 'Critical' ? 'bg-red-50' : s.risk_level === 'At Risk' ? 'bg-yellow-50' : ''}">
        <td class="px-5 py-4 whitespace-nowrap text-sm text-slate-600">${s.lrn}</td>
        <td class="px-5 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${s.name}</td>
        <td class="px-5 py-4 whitespace-nowrap text-sm text-slate-600">${s.sex}</td>
        <td class="px-5 py-4 whitespace-nowrap text-sm ${getGradeClass(s.current_grade)}">${s.current_grade || '-'}</td>
        <td class="px-5 py-4 whitespace-nowrap text-sm ${s.absences > 5 ? 'text-red-600 font-medium' : 'text-slate-600'}">${s.absences}</td>
        <td class="px-5 py-4 whitespace-nowrap text-sm">${missingWorkHTML}</td>
        <td class="px-5 py-4 whitespace-nowrap">${getRiskBadge(s.risk_level)}</td>
        <td class="px-5 py-4 whitespace-nowrap">${getInterventionBadge(s.intervention_tier)}</td>
        <td class="px-5 py-4 whitespace-nowrap text-sm">
          <button class="btn-details text-blue-700 hover:text-blue-900 font-medium" data-student-id="${s.id}">
            <i class="fa-solid fa-file-lines mr-1.5"></i> Details
          </button>
        </td>
      </tr>
    `;
  }).join('');
}
    // Show modal with student details
    async function showModal(studentId) {
      const student = currentStudentData.find(s => s.id === studentId);
      if (!student) return;

      activeModalStudent = student;
      activeInterventionId = student.intervention_id;

      // Set header info
      document.getElementById('modal-student-name').textContent = student.name;
      document.getElementById('modal-student-meta').textContent = `LRN: ${student.lrn} • ${student.sex === 'M' ? 'Male' : 'Female'} • Age: ${student.age}`;

      // Set vitals
      const gradeEl = document.getElementById('modal-grade');
      gradeEl.textContent = student.current_grade || '-';
      gradeEl.className = `text-4xl font-bold ${getGradeClass(student.current_grade)}`;

      const absenceEl = document.getElementById('modal-absences');
      absenceEl.textContent = student.absences;
      absenceEl.className = `text-4xl font-bold ${student.absences > 5 ? 'text-red-600' : 'text-slate-800'}`;

      const missingEl = document.getElementById('modal-missing-work');
      missingEl.textContent = student.missing_work;
      missingEl.className = `text-4xl font-bold ${student.missing_work > 5 ? 'text-red-600' : 'text-slate-800'}`;

      // Load detailed intervention data if exists
      if (student.intervention_id) {
        await loadInterventionDetails(student.id);
      } else {
        renderNoInterventionTabs(student);
      }

      // Show modal
      const modalBackdrop = document.getElementById('details-modal-backdrop');
      const modal = document.getElementById('details-modal');
      modalBackdrop.classList.remove('opacity-0', 'pointer-events-none');
      modal.classList.remove('scale-95');
    }

    // Load detailed intervention data
    async function loadInterventionDetails(studentId) {
      const quarter = document.getElementById('quarter-select').value;
      const subjectId = document.getElementById('subject-select').value;

      try {
        const url = new URL(`/teacher/api/intervention/student/${studentId}/details/`, window.location.origin);
        url.searchParams.append('quarter', quarter);
        if (subjectId) url.searchParams.append('subject_id', subjectId);

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
          renderRiskAssessment(data.intervention);
          renderStrategies(data.intervention.current_tier);
          renderActiveInterventions(data.actions);
          renderActionPlan(data.intervention);
        }
      } catch (error) {
        console.error('Error loading intervention details:', error);
      }
    }

    // Render Risk Assessment tab
    function renderRiskAssessment(intervention) {
    const container = document.getElementById('tab-content-risk');
    
    let factorsHtml = '';
    intervention.risk_factors.forEach(factor => {
      const isHighRisk = factor.includes('Excessive') || factor.includes('Missed quarterly') || factor.includes('Failing');
      factorsHtml += `<li class="text-slate-700"><span class="font-semibold ${isHighRisk ? 'text-red-700' : 'text-yellow-700'}">${factor}</span></li>`;
    });

    if (!factorsHtml) {
      factorsHtml = '<li class="text-slate-700">No significant risk factors identified. Student is on track.</li>';
    }

    // Add summary card with enhanced context
    const summaryCard = `
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
        <h5 class="font-semibold text-blue-900 mb-2"><i class="fa-solid fa-chart-simple mr-2"></i>Assessment Overview</h5>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <span class="text-blue-700 font-medium">Written Works:</span>
            <span class="text-slate-700">${intervention.missing_ww} missing out of ${intervention.active_ww_count} assigned</span>
          </div>
          <div>
            <span class="text-blue-700 font-medium">Performance Tasks:</span>
            <span class="text-slate-700">${intervention.missing_pt} missing out of ${intervention.active_pt_count} assigned</span>
          </div>
          ${intervention.missing_ww_detail && intervention.missing_ww_detail.length > 0 ? `
            <div class="col-span-2">
              <span class="text-blue-700 font-medium">Missing WW Numbers:</span>
              <span class="text-slate-700">#${intervention.missing_ww_detail.join(', #')}</span>
            </div>
          ` : ''}
          ${intervention.missing_pt_detail && intervention.missing_pt_detail.length > 0 ? `
            <div class="col-span-2">
              <span class="text-blue-700 font-medium">Missing PT Numbers:</span>
              <span class="text-slate-700">#${intervention.missing_pt_detail.join(', #')}</span>
            </div>
          ` : ''}
        </div>
      </div>
    `;

    let tierText = '';
    let tierDesc = '';
    if (intervention.current_tier === 'Tier 3') {
      tierText = 'Tier 3: Intensive Intervention';
      tierDesc = 'Requires intensive support with adviser and parent involvement. Student has not responded to lower-tier interventions.';
    } else if (intervention.current_tier === 'Tier 2') {
      tierText = 'Tier 2: Targeted Support';
      tierDesc = 'Targeted intervention for students showing significant academic or behavioral concerns.';
    } else {
      tierText = 'Tier 1: Prevention';
      tierDesc = 'Preventive measures to address early warning signs before they become serious.';
    }

    container.innerHTML = summaryCard + `
      <div class="bg-slate-50 border border-slate-200 rounded-lg p-5">
        <h4 class="text-lg font-semibold text-slate-800 mb-3"><i class="fa-solid fa-circle-exclamation text-red-600 mr-2"></i>Risk Factors Identified</h4>
        <ul class="list-disc list-inside space-y-2">${factorsHtml}</ul>
      </div>
      <div class="bg-slate-50 border border-slate-200 rounded-lg p-5 mt-4">
        <h4 class="text-lg font-semibold text-slate-800 mb-2">${tierText}</h4>
        <p class="text-slate-600">${tierDesc}</p>
      </div>
    `;
  }

    // Render Strategies tab
    function renderStrategies(tier) {
      const container = document.getElementById('tab-content-strategies');
      
      let strategies = [];
      if (tier === 'Tier 3') {
        strategies = [
          'Parent-teacher conference with adviser',
          'Individualized learning plan with specific goals',
          'Daily progress monitoring and check-ins',
          'One-on-one tutoring sessions',
          'Home visit if necessary',
          'Counseling referral for personal/family issues',
          'Special projects to make up missing work',
          'Extended time for assignments and assessments'
        ];
      } else if (tier === 'Tier 2') {
        strategies = [
          'Small-group instruction or tutoring',
          'Makeup opportunities for missing work',
          'Weekly progress check-ins with teacher',
          'Parent notification and collaboration',
          'Goal-setting conference with student',
          'After-school academic support',
          'Modified assignments with accommodations',
          'Peer tutoring or study groups'
        ];
      } else {
        strategies = [
          'Direct conversation with student about concerns',
          'Clear expectations and deadlines communicated',
          'Regular monitoring of attendance and work completion',
          'Encourage help-seeking behaviors',
          'Provide study tips and time management guidance',
          'Offer extra help during office hours'
        ];
      }

      container.innerHTML = `
        <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-lightbulb mr-2 text-yellow-500"></i>Recommended Strategies (Based on ${tier})</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
          ${strategies.map(s => `
            <div class="flex items-start">
              <i class="fa-solid fa-check text-blue-600 mr-3 mt-1"></i>
              <span class="text-slate-700">${s}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Render Active Interventions tab
    function renderActiveInterventions(actions) {
      const container = document.getElementById('active-interventions-list');
      
      if (!actions || actions.length === 0) {
        container.innerHTML = '<p class="text-slate-500 italic text-center p-4 bg-slate-50 rounded-lg">No active interventions have been recorded yet. Use the form below to add one.</p>';
        return;
      }

      container.innerHTML = actions.map(action => `
        <div class="bg-white border border-slate-200 rounded-lg overflow-hidden">
          <div class="p-4 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
            <div>
              <h5 class="font-semibold text-slate-800">${escapeHtml(action.action_name)}</h5>
              <p class="text-sm text-slate-600">${action.tier} • ${action.action_type} • Status: <span class="font-medium">${action.status}</span></p>
            </div>
            <div class="flex items-center gap-2">
              <div class="text-sm text-slate-500 mr-4">
                <div><strong>Start:</strong> ${action.start_date}</div>
                ${action.target_date ? `<div><strong>Target:</strong> ${action.target_date}</div>` : ''}
                ${action.completion_date ? `<div><strong>Completed:</strong> ${action.completion_date}</div>` : ''}
              </div>
              <button class="btn-edit-action px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition" data-action-id="${action.id}">
                <i class="fa-solid fa-edit mr-1"></i> Edit
              </button>
              <button class="btn-delete-action px-3 py-1.5 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition" data-action-id="${action.id}">
                <i class="fa-solid fa-trash mr-1"></i> Delete
              </button>
            </div>
          </div>
          <div class="p-4 space-y-3">
            <div>
              <label class="text-xs font-semibold text-slate-500 uppercase">Description</label>
              <p class="text-sm text-slate-700 whitespace-pre-wrap">${escapeHtml(action.description)}</p>
            </div>
            ${action.progress_notes ? `
            <div>
              <label class="text-xs font-semibold text-slate-500 uppercase">Progress Update</label>
              <p class="text-sm text-slate-700 whitespace-pre-wrap">${escapeHtml(action.progress_notes)}</p>
            </div>` : ''}
            ${action.teacher_notes ? `
            <div>
              <label class="text-xs font-semibold text-slate-500 uppercase">Teacher Notes</label>
              <p class="text-sm text-slate-700 whitespace-pre-wrap">${escapeHtml(action.teacher_notes)}</p>
            </div>` : ''}
            ${action.outcome_notes ? `
            <div>
              <label class="text-xs font-semibold text-slate-500 uppercase">Outcome</label>
              <p class="text-sm text-slate-700 whitespace-pre-wrap">${escapeHtml(action.outcome_notes)}</p>
            </div>` : ''}
            <div class="text-xs text-slate-500">Handled by: ${action.handled_by}</div>
          </div>
        </div>
      `).join('');

      // Add event listeners for edit and delete buttons
      container.querySelectorAll('.btn-edit-action').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const actionId = parseInt(e.currentTarget.dataset.actionId);
          openEditActionModal(actionId);
        });
      });

      container.querySelectorAll('.btn-delete-action').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const actionId = parseInt(e.currentTarget.dataset.actionId);
          deleteInterventionAction(actionId);
        });
      });
    }

    // Render Action Plan tab
    function renderActionPlan(intervention) {
      const container = document.getElementById('tab-content-action');
      const tier = intervention.current_tier;
      
      let immediate = [], shortTerm = [], longTerm = [];

      if (tier === 'Tier 3') {
        immediate = [
          'Schedule parent-teacher-adviser conference immediately',
          'Document all concerns and evidence in writing',
          'Develop individualized intervention plan with specific goals',
          'Establish daily check-in system'
        ];
        shortTerm = [
          'Improve grade to at least 75 (passing)',
          'Reduce absences to maximum 2 per month',
          'Complete all missing assignments within 2 weeks',
          'Show consistent effort and engagement in class'
        ];
        longTerm = [
          'Achieve grade of 80 or higher',
          'Maintain excellent attendance (95%+)',
          'Demonstrate mastery of key learning competencies',
          'Transition to lower intervention tier'
        ];
      } else if (tier === 'Tier 2') {
        immediate = [
          'Meet with student to discuss concerns',
          'Contact parents/guardians via phone or letter',
          'Provide makeup work opportunities with clear deadlines',
          'Set up weekly progress monitoring'
        ];
        shortTerm = [
          'Improve grade to 80 or above',
          'Reduce absences to 2-3 per month',
          'Submit at least 90% of assignments on time',
          'Participate actively in class'
        ];
        longTerm = [
          'Achieve grade of 85 or higher',
          'Maintain good attendance',
          'Develop independent study habits',
          'Transition to Tier 1 or no intervention'
        ];
      } else {
        immediate = [
          'Have informal conversation with student',
          'Clarify expectations and consequences',
          'Monitor attendance and work completion closely'
        ];
        shortTerm = [
          'Maintain grade above 80',
          'Improve attendance if needed',
          'Submit all assignments on time'
        ];
        longTerm = [
          'Maintain grade above 85',
          'Demonstrate consistent responsibility',
          'No intervention needed'
        ];
      }

      container.innerHTML = `
        <h3 class="text-lg font-semibold text-slate-800 mb-4"><i class="fa-solid fa-list-check mr-2 text-green-600"></i>Intervention Action Plan</h3>
        <div class="space-y-6">
          <div>
            <h4 class="font-semibold text-slate-700 mb-2">Immediate Actions (Week 1-2)</h4>
            <ul class="list-disc list-inside space-y-1 text-slate-600">
              ${immediate.map(s => `<li>${s}</li>`).join('')}
            </ul>
          </div>
          <div>
            <h4 class="font-semibold text-slate-700 mb-2">Short-term Goals (Weeks 3-6)</h4>
            <ul class="list-disc list-inside space-y-1 text-slate-600">
              ${shortTerm.map(s => `<li>${s}</li>`).join('')}
            </ul>
          </div>
          <div>
            <h4 class="font-semibold text-slate-700 mb-2">Long-term Goals (Quarter End)</h4>
            <ul class="list-disc list-inside space-y-1 text-slate-600">
              ${longTerm.map(s => `<li>${s}</li>`).join('')}
            </ul>
          </div>
          <div class="bg-slate-50 p-4 rounded-lg border">
            <h4 class="font-semibold text-slate-700 mb-2">Progress Monitoring</h4>
            <p class="text-slate-600">Regular check-ins and assessments will be used to monitor progress against these goals. Intervention tier may be adjusted based on student response.</p>
          </div>
        </div>
      `;
    }

    // Render tabs for students without interventions
    function renderNoInterventionTabs(student) {
      document.getElementById('tab-content-risk').innerHTML = '<p class="text-slate-500 italic">No intervention plan exists for this student yet. Student is currently on track.</p>';
      document.getElementById('tab-content-strategies').innerHTML = '<p class="text-slate-500 italic">No strategies needed at this time.</p>';
      document.getElementById('active-interventions-list').innerHTML = '<p class="text-slate-500 italic text-center p-4 bg-slate-50 rounded-lg">No interventions recorded.</p>';
      document.getElementById('tab-content-action').innerHTML = '<p class="text-slate-500 italic">No action plan needed at this time.</p>';
    }

    // Save new intervention action
    async function saveNewIntervention() {
      if (!activeInterventionId) {
        alert('No intervention plan found for this student.');
        return;
      }

      const tier = document.getElementById('input-inter-tier').value;
      const actionType = document.getElementById('input-inter-type').value;
      const name = document.getElementById('input-inter-name').value.trim();
      const description = document.getElementById('input-inter-desc').value.trim();
      const startDate = document.getElementById('input-inter-start').value;
      const targetDate = document.getElementById('input-inter-target').value;
      const status = document.getElementById('input-inter-status').value;
      const progress = document.getElementById('input-inter-progress').value.trim();
      const notes = document.getElementById('input-inter-notes').value.trim();

      if (!name || !description || !startDate) {
        alert('Please fill in all required fields: Strategy Name, Description, and Start Date.');
        return;
      }

      try {
        const response = await fetch('{% url "teacher:api-create-intervention-action" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            intervention_id: activeInterventionId,
            tier: tier,
            action_type: actionType,
            action_name: name,
            description: description,
            start_date: startDate,
            target_date: targetDate,
            status: status,
            progress_notes: progress,
            teacher_notes: notes
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('Intervention action saved successfully!');
          
          // Clear form
          document.getElementById('input-inter-name').value = '';
          document.getElementById('input-inter-desc').value = '';
          document.getElementById('input-inter-start').value = '';
          document.getElementById('input-inter-target').value = '';
          document.getElementById('input-inter-progress').value = '';
          document.getElementById('input-inter-notes').value = '';
          document.getElementById('input-inter-status').value = 'Planned';
          
          // Reload intervention details
          await loadInterventionDetails(activeModalStudent.id);
        } else {
          alert('Error saving intervention: ' + data.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error saving intervention action');
      }
    }

    // Open edit action modal
    async function openEditActionModal(actionId) {
      try {
        const response = await fetch(`/teacher/api/intervention/action/${actionId}/`);
        const data = await response.json();

        if (data.success) {
          const action = data.action;
          
          // Fill the form with existing data
          document.getElementById('input-inter-tier').value = action.tier;
          document.getElementById('input-inter-type').value = action.action_type;
          document.getElementById('input-inter-name').value = action.action_name;
          document.getElementById('input-inter-desc').value = action.description;
          document.getElementById('input-inter-start').value = action.start_date;
          document.getElementById('input-inter-target').value = action.target_date;
          document.getElementById('input-inter-status').value = action.status;
          document.getElementById('input-inter-progress').value = action.progress_notes;
          document.getElementById('input-inter-notes').value = action.teacher_notes;

          // Change button to update mode
          const saveBtn = document.getElementById('btn-save-new-intervention');
          saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> Update Intervention';
          saveBtn.dataset.editMode = 'true';
          saveBtn.dataset.actionId = actionId;

          // Scroll to form
          document.getElementById('input-inter-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          alert('Error loading action: ' + data.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error loading action for editing');
      }
    }

    // Update existing intervention action
    async function updateInterventionAction(actionId) {
      const tier = document.getElementById('input-inter-tier').value;
      const actionType = document.getElementById('input-inter-type').value;
      const name = document.getElementById('input-inter-name').value.trim();
      const description = document.getElementById('input-inter-desc').value.trim();
      const startDate = document.getElementById('input-inter-start').value;
      const targetDate = document.getElementById('input-inter-target').value;
      const status = document.getElementById('input-inter-status').value;
      const progress = document.getElementById('input-inter-progress').value.trim();
      const notes = document.getElementById('input-inter-notes').value.trim();

      if (!name || !description || !startDate) {
        alert('Please fill in all required fields: Strategy Name, Description, and Start Date.');
        return;
      }

      try {
        const response = await fetch(`/teacher/api/intervention/action/${actionId}/update/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            tier: tier,
            action_type: actionType,
            action_name: name,
            description: description,
            start_date: startDate,
            target_date: targetDate,
            status: status,
            progress_notes: progress,
            teacher_notes: notes
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('Intervention action updated successfully!');
          
          // Reset form to create mode
          resetInterventionForm();
          
          // Reload intervention details
          await loadInterventionDetails(activeModalStudent.id);
        } else {
          alert('Error updating intervention: ' + data.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error updating intervention action');
      }
    }

    // Delete intervention action
    async function deleteInterventionAction(actionId) {
      if (!confirm('Are you sure you want to delete this intervention action? This cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/teacher/api/intervention/action/${actionId}/delete/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          }
        });

        const data = await response.json();

        if (data.success) {
          alert('Intervention action deleted successfully!');
          
          // Reload intervention details
          await loadInterventionDetails(activeModalStudent.id);
        } else {
          alert('Error deleting intervention: ' + data.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error deleting intervention action');
      }
    }

    // Reset intervention form to create mode
    function resetInterventionForm() {
      document.getElementById('input-inter-name').value = '';
      document.getElementById('input-inter-desc').value = '';
      document.getElementById('input-inter-start').value = new Date().toISOString().split('T')[0];
      document.getElementById('input-inter-target').value = '';
      document.getElementById('input-inter-progress').value = '';
      document.getElementById('input-inter-notes').value = '';
      document.getElementById('input-inter-status').value = 'Planned';
      
      const saveBtn = document.getElementById('btn-save-new-intervention');
      saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> Save Intervention';
      saveBtn.dataset.editMode = 'false';
      delete saveBtn.dataset.actionId;
    }

    // Close modal
    function closeModal() {
      activeModalStudent = null;
      activeInterventionId = null;
      const modalBackdrop = document.getElementById('details-modal-backdrop');
      const modal = document.getElementById('details-modal');
      modalBackdrop.classList.add('opacity-0', 'pointer-events-none');
      modal.classList.add('scale-95');
    }

    // Switch tabs
    function switchTab(tabName) {
      document.querySelectorAll('#modal-tab-nav .tab-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      document.querySelectorAll('#modal-tab-content .tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-content-${tabName}`);
      });
    }

    // Escape HTML for safety
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Initial load
      loadStudents();

      // Filters
      document.getElementById('section-select').addEventListener('change', loadStudents);
      document.getElementById('quarter-select').addEventListener('change', loadStudents);
      document.getElementById('subject-select').addEventListener('change', loadStudents);
      document.getElementById('search-input').addEventListener('input', renderTable);
      document.getElementById('filter-risk').addEventListener('change', renderTable);
      document.getElementById('filter-intervention').addEventListener('change', renderTable);

      // Modal triggers
      document.getElementById('student-table-body').addEventListener('click', (e) => {
        const detailsButton = e.target.closest('.btn-details');
        if (detailsButton) {
          const studentId = parseInt(detailsButton.dataset.studentId);
          showModal(studentId);
        }
      });

      // Modal close
      document.getElementById('btn-close-modal').addEventListener('click', closeModal);
      document.getElementById('details-modal-backdrop').addEventListener('click', (e) => {
        if (e.target.id === 'details-modal-backdrop') closeModal();
      });

      // Tab switching
      document.getElementById('modal-tab-nav').addEventListener('click', (e) => {
        const tabButton = e.target.closest('.tab-button');
        if (tabButton && !tabButton.classList.contains('active')) {
          switchTab(tabButton.dataset.tab);
        }
      });

      // Save intervention
      document.getElementById('btn-save-new-intervention').addEventListener('click', function() {
        const editMode = this.dataset.editMode === 'true';
        const actionId = this.dataset.actionId;
        
        if (editMode && actionId) {
          updateInterventionAction(parseInt(actionId));
        } else {
          saveNewIntervention();
        }
      });

      // Set today's date as default for start date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('input-inter-start').value = today;
    });
  </script>
</body>
</html>