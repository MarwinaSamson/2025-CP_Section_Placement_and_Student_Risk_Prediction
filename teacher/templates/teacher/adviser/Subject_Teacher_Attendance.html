<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SF2 — Daily Attendance (Improved)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
{% load static %}
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* minimal custom css: loader + print tweaks */
    .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid #3b82f6; width: 40px; height: 40px; animation: spin 1s linear infinite; display:none; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    /* keep focus ring consistent */
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 4px rgba(59,130,246,0.12); border-color: #60a5fa; }

    /* print rules for nicer print / exported view (Excel export unaffected) */
    @media print {
      .no-print { display: none !important; }
      body { background: #fff; }
    }

    /* small adjustments to label width for consistent alignment */
    .hdr-label { width: 150px; min-width:150px; }
    input[type="text"], input[type="month"], select { height: 40px; }
  </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased">
  <div id="sidebar-root">
    {% include 'teacher/adviser/sidebar.html' %}
  </div>
  <div class="max-w-screen-2xl mx-auto p-6"> <div class="flex items-center justify-between mb-4 gap-4">
      <div class="flex items-center gap-4">
        <button onclick="history.back()" class="no-print inline-flex items-center gap-2 text-red-700 hover:text-red-900 rounded px-3 py-2 bg-white border shadow-sm">
          <i class="fa-solid fa-arrow-left"></i>
          Back
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

      <div class="lg:col-span-9 space-y-6">

        <div class="bg-white rounded-xl shadow-sm p-6 space-y-6">
            
            <div class="flex justify-center pl-2">
                <div class="text-center">
                    <h1 class="text-lg sm:text-xl font-semibold leading-tight">
                    SF2 — Daily Attendance
                    </h1>
                    <p class="text-xs sm:text-sm text-slate-500">
                    School Form 2 - Daily Attendance Report of Learners
                    </p>
                </div>
            </div>


          <div class="border rounded-lg p-4 bg-white">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              
              <div class="space-y-3">
                <div class="flex items-center">
                  <label class="hdr-label font-semibold text-sm text-slate-700">School Name</label>
                  <input id="schoolName" class="flex-1 border border-slate-300 rounded px-3 py-2 text-sm focus-ring" value="Cagayan de Oro National High School">
                </div>
                
                <div class="flex items-center">
                  <label class="hdr-label font-semibold text-sm text-slate-700">School ID</label>
                  <input id="schoolId" class="flex-1 border border-slate-300 rounded px-3 py-2 text-sm focus-ring" value="304144">
                </div>

                <div class="flex items-center">
                  <label class="hdr-label font-semibold text-sm text-slate-700">School Year</label>
                  <input id="schoolYear" class="flex-1 border border-slate-300 rounded px-3 py-2 text-sm focus-ring" value="2025-2026">
                </div>
              </div>

              <div class="space-y-3">
                <div class="flex items-center">
                  <label class="hdr-label font-semibold text-sm text-slate-700">Section</label>
                  <input id="section" class="flex-1 border border-slate-300 rounded px-3 py-2 text-sm focus-ring" value="STE-A">
                </div>

                <div class="flex items-center">
                  <label class="hdr-label font-semibold text-sm text-slate-700">Grade Level</label>
                  <input id="gradeLevel" class="flex-1 border border-slate-300 rounded px-3 py-2 text-sm focus-ring" value="Grade 10">
                </div>
                
                <div class="flex items-center">
                  <label class="hdr-label font-semibold text-sm text-slate-700">Quarter</label>
                  <select id="reportQuarter" class="flex-1 border border-slate-300 rounded px-3 py-2 text-sm focus-ring bg-white">
                    <option value="1">Quarter 1</option>
                    <option value="2">Quarter 2</option>
                    <option value="3">Quarter 3</option>
                    <option value="4">Quarter 4</option>
                  </select>
                </div>
                <div class="flex items-center">
                  <label class="hdr-label font-semibold text-sm text-slate-700">Month</label>
                  <input id="reportMonth" type="month" class="flex-1 border border-slate-300 rounded px-3 py-2 text-sm focus-ring" value="2025-09">
                </div>
              </div>
            </div>
          </div>

          <div class="flex justify-end items-center gap-2 no-print">
              <button id="printBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow-sm text-sm">
                  <i class="fa-solid fa-print"></i> Print
              </button>
              <button id="saveBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow-sm text-sm">
                  <i class="fa-solid fa-save"></i> Save
              </button>
              <button id="exportExcelBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded shadow-sm text-sm">
                  <i class="fa-solid fa-file-excel"></i> Download SF2
              </button>
          </div>

          <div class="overflow-auto rounded-lg border bg-white shadow-sm">
            <table id="attendanceTable" class="min-w-full table-auto text-xs"></table>
          </div>

          <div class="flex items-center justify-center">
            <div id="loader" class="loader"></div>
          </div>

        </div> <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">

      <div class="lg:col-span-4 bg-blue-50 border-l-4 border-blue-400 p-4 rounded-md h-full">
        <div class="flex items-center gap-2 mb-2">
          <i class="fa-solid fa-circle-info text-blue-600"></i>
          <h3 class="font-semibold text-blue-800">Guidelines</h3>
        </div>
        <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1 leading-snug">
          <li>Mark attendance daily using allowed codes:</li>
          <li><strong>Blank</strong> = Present, <strong>X</strong> or <strong>E</strong> = Absent, <strong>T</strong> = Tardy</li>
          <li>Invalid letters will trigger a warning and will be cleared.</li>
          <li>To compute percentage: <em>(Total Daily Attendance / (No. of days × Enrolment)) × 100</em></li>
          <li>For dropped/transferred indicate in Remarks (e.g. “dropped - a. domestic”, “transferred out: Other School”).</li>
        </ul>
      </div>

      <div class="lg:col-span-8 bg-white border rounded-md p-4 shadow-sm h-full">
        <div class="flex items-center gap-2 mb-3">
          <i class="fa-solid fa-chart-pie text-slate-600"></i>
          <h3 class="font-semibold">Monthly Summary</h3>
        </div>

        <div class="overflow-auto">
          <table class="w-full text-sm table-auto">
            <thead>
              <tr class="bg-slate-100">
                <th class="text-left px-2 py-2">Item</th>
                <th class="px-2 py-2 text-center">M</th>
                <th class="px-2 py-2 text-center">F</th>
                <th class="px-2 py-2 text-center">TOTAL</th>
              </tr>
            </thead>
            <tbody class="text-sm">
              <tr class="odd:bg-white even:bg-slate-50">
                <td class="py-2 px-2">Enrolment (end of month)</td>
                <td class="px-1 py-1">
                  <input id="sum-jun-m" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50">
                </td>
                <td class="px-1 py-1">
                  <input id="sum-jun-f" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50">
                </td>
                <td class="px-1 py-1">
                  <input id="sum-jun-total" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50">
                </td>
              </tr>

              <tr class="odd:bg-white even:bg-slate-50">
                <td class="py-2 px-2">Late enrollees during the month</td>
                <td class="px-1 py-1"><input id="sum-late-m" class="w-full border rounded px-1 py-0.5 text-center text-sm"></td>
                <td class="px-1 py-1"><input id="sum-late-f" class="w-full border rounded px-1 py-0.5 text-center text-sm"></td>
                <td class="px-1 py-1"><input id="sum-late-total" class="w-full border rounded px-1 py-0.5 text-center text-sm"></td>
              </tr>

              <tr class="odd:bg-white even:bg-slate-50">
                <td class="py-2 px-2">Registered learners as of end of month</td>
                <td class="px-1 py-1"><input id="sum-reg-m" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-reg-f" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-reg-total" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
              </tr>

              <tr class="odd:bg-white even:bg-slate-50">
                <td class="py-2 px-2">Percentage of Enrollment</td>
                <td class="px-1 py-1"><input id="sum-perc-m" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-perc-f" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-perc-total" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
              </tr>

              <tr class="odd:bg-white even:bg-slate-50">
                <td class="py-2 px-2">Average Daily Attendance</td>
                <td class="px-1 py-1"><input id="sum-avg-m" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-avg-f" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-avg-total" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
              </tr>

              <tr class="odd:bg-white even:bg-slate-50">
                <td class="py-2 px-2">Percentage of Attendance</td>
                <td class="px-1 py-1"><input id="sum-att-perc-m" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-att-perc-f" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-att-perc-total" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
              </tr>

              <tr class="odd:bg-white even:bg-slate-50">
                <td class="py-2 px-2">Number of Dropped out</td>
                <td class="px-1 py-1"><input id="sum-drop-m" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-drop-f" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-drop-total" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
              </tr>

              <tr class="odd:bg-white even:bg-slate-50">
                <td class="py-2 px-2">Number of Transferred out</td>
                <td class="px-1 py-1"><input id="sum-tout-m" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-tout-f" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-tout-total" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
              </tr>

              <tr class="odd:bg-white even:bg-slate-50">
                <td class="py-2 px-2">Number of Transferred in</td>
                <td class="px-1 py-1"><input id="sum-tin-m" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-tin-f" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
                <td class="px-1 py-1"><input id="sum-tin-total" readonly class="w-full border rounded px-1 py-0.5 text-center text-sm bg-white/50"></td>
              </tr>

            </tbody>
          </table>
        </div>
      </div>

    </div>

    <div class="mt-4 bg-white border rounded-md p-4 shadow-sm">
      <div class="max-w-4xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
          <div class="text-center">
            <div class="border-b border-slate-400 w-full h-10 mb-2"></div>
            <input id="adviserName" class="text-center font-semibold w-full" value=" Name of Teacher">
            <div class="text-xs text-slate-500 mt-1">(Signature of Adviser over Printed Name)</div>
          </div>

          <div class="text-center">
            <div class="border-b border-slate-400 w-full h-10 mb-2"></div>
            <input id="principalName" class="text-center font-semibold w-full" value="Name of Principal">
            <div class="text-xs text-slate-500 mt-1">(Signature of School Head over Printed Name)</div>
          </div>
        </div>

        </div>
    </div>

  </div> <div class="lg:col-span-3 space-y-6 no-print">
      <div class="bg-white rounded-xl shadow-sm p-6 sticky top-6"> <div class="flex items-center gap-2 mb-4">
               <i class="fa-solid fa-clock-rotate-left text-slate-600"></i>
               <h2 class="text-lg font-semibold">Attendance History</h2>
          </div>
          <div id="historyContainer" class="space-y-3 max-h-[70vh] overflow-y-auto">
              <p id="historyPlaceholder" class="text-sm text-slate-500 text-center p-4">No attendance saved yet.</p>
              </div>
      </div>
  </div> </div> </div> <script>
    // --- Data source (kept as original) ---
    const fetchStudentData = async () => {
      return [
        { name: "Abejero, John Michael", gender: "M" }, { name: "Corpuz, Miguel", gender: "M" },
        { name: "Emano, Vince", gender: "M" }, { name: "Garcia, Gabriel", gender: "M" },
        { name: "Bacorro, Angel", gender: "F" }, { name: "Dela Cruz, Andrea", gender: "F" },
        { name: "Fernandez, Patricia", gender: "F" }, { name: "Hernandez, Sofia", gender: "F" },
      ];
    };

    const table = document.getElementById("attendanceTable");
    const monthSelector = document.getElementById("reportMonth");
    let students = [];
    let schoolDays = [];

    // Allowed attendance codes for validation (kept consistent with original counting logic)
    const VALID_CODES = ['', 'X', 'E', 'T']; // blank -> present, X/E -> absent, T -> tardy

    // helper: validate an input value (uppercase)
    function validateAttendanceInputValue(val) {
      if (val === undefined || val === null) return false;
      const v = val.toString().trim().toUpperCase();
      return VALID_CODES.includes(v);
    }

    // handler for each attendance input: validate and update calculations
    function handleAttendInput(e) {
      const raw = e.target.value || '';
      const up = raw.toString().trim().toUpperCase();

      if (up === '') {
        e.target.value = '';
        updateAllCalculations();
        return;
      }

      // accept if valid
      if (VALID_CODES.includes(up)) {
        e.target.value = up;
        updateAllCalculations();
        return;
      }

      // invalid -> clear and show warning popup (SweetAlert2)
      e.target.value = '';
      Swal.fire({
        icon: 'warning',
        title: 'Invalid attendance code',
        text: 'Please use only these codes: blank (present), X or E (absent), T (tardy).',
        confirmButtonColor: '#ef4444'
      }).then(() => {
        e.target.focus();
      });
    }

    const buildTable = async () => {
      document.getElementById('loader').style.display = 'block';
      table.innerHTML = '';

      students = await fetchStudentData();
      const monthVal = monthSelector.value;
      if (!monthVal) {
          document.getElementById('loader').style.display = 'none';
          return;
      }

      const [year, month] = monthVal.split("-").map(Number);
      schoolDays = [];
      const date = new Date(year, month - 1, 1);
      while (date.getMonth() === month - 1) {
        // Monday (1) to Friday (5)
        if (date.getDay() >= 1 && date.getDay() <= 5) schoolDays.push(new Date(date));
        date.setDate(date.getDate() + 1);
      }

      const dayNames = ["M", "T", "W", "TH", "F"];

      // build header
      let headerHTML = `<thead><tr class="bg-slate-100"><th rowspan="2" class="p-2">#</th><th rowspan="2" style="width:300px;" class="p-2 text-left">LEARNER'S NAME<br><span class="text-xs">(Last Name, First Name)</span></th>`;
      schoolDays.forEach(d => headerHTML += `<th class="p-2 border">${d.getDate()}</th>`);
      headerHTML += `<th colspan="2" class="p-2 border">Total for the Month</th><th rowspan="2" style="width:300px;" class="p-2">REMARKS (If DROPPED OUT, state reason, please refer to legend number 2. If TRANSFERRED IN/OUT, write the name of School.)</th></tr><tr class="bg-slate-50">`;
      schoolDays.forEach(d => headerHTML += `<th class="p-2 border">${dayNames[d.getDay()-1]}</th>`);
      headerHTML += `<th class="p-2 border">ABSENT</th><th class="p-2 border">TARDY</th></tr></thead>`;

      // build body
      let bodyHTML = '<tbody>';
      const maleStudents = students.filter(s => s.gender === 'M');
      const femaleStudents = students.filter(s => s.gender === 'F');

      let counter = 1;
      maleStudents.forEach(s => {
        bodyHTML += `<tr data-gender="M" class="odd:bg-white even:bg-slate-50"><td class="p-2 text-center">${counter++}</td><td class="student-name p-2 text-sm">${s.name}</td>`;
        schoolDays.forEach((day, i) => bodyHTML += `<td class="p-1 border"><input class="attend-input focus-ring text-center text-sm w-full bg-transparent" data-day="${i}"></td>`);
        bodyHTML += `<td class="absent-total p-2 text-center">0</td><td class="tardy-total p-2 text-center">0</td><td class="p-2"><input class="remarks-input focus-ring text-sm w-full bg-transparent" placeholder=""></td></tr>`;
      });

      bodyHTML += `<tr class="totals-row bg-slate-100 font-semibold male-total"><td colspan="2">MALE | Total per Day »</td>${schoolDays.map(() => `<td class="day-total p-2 text-center">0</td>`).join('')}<td class="p-2 text-center">0</td><td class="p-2 text-center">0</td><td class="p-2"></td></tr>`;

      femaleStudents.forEach(s => {
        bodyHTML += `<tr data-gender="F" class="odd:bg-white even:bg-slate-50"><td class="p-2 text-center">${counter++}</td><td class="student-name p-2 text-sm">${s.name}</td>`;
        schoolDays.forEach((day, i) => bodyHTML += `<td class="p-1 border"><input class="attend-input focus-ring text-center text-sm w-full bg-transparent" data-day="${i}"></td>`);
        bodyHTML += `<td class="absent-total p-2 text-center">0</td><td class="tardy-total p-2 text-center">0</td><td class="p-2"><input class="remarks-input focus-ring text-sm w-full bg-transparent" placeholder=""></td></tr>`;
      });

      bodyHTML += `<tr class="totals-row bg-slate-100 font-semibold female-total"><td colspan="2">FEMALE | Total per Day »</td>${schoolDays.map(() => `<td class="day-total p-2 text-center">0</td>`).join('')}<td class="p-2 text-center">0</td><td class="p-2 text-center">0</td><td class="p-2"></td></tr>`;
      bodyHTML += `<tr class="totals-row bg-slate-200 font-semibold combined-total"><td colspan="2">COMBINED | Total per Day »</td>${schoolDays.map(() => `<td class="day-total p-2 text-center">0</td>`).join('')}<td class="p-2 text-center">0</td><td class="p-2 text-center">0</td><td class="p-2"></td></tr>`;
      bodyHTML += '</tbody>';

      table.innerHTML = headerHTML + bodyHTML;

      // --- NEW: Load saved data if it exists ---
      const key = `sf2_${document.getElementById('section').value}_${monthVal}`;
      const savedDataJSON = localStorage.getItem(key);
      
      if (savedDataJSON) {
          try {
              const savedRecord = JSON.parse(savedDataJSON);
              
              // Load attendance data
              if (savedRecord.attendanceData) {
                   document.querySelectorAll('#attendanceTable tr[data-gender]').forEach((row, rIdx) => {
                      const studentName = row.querySelector('.student-name').textContent;
                      const rowKey = `${rIdx}_${studentName}`;
                      const rowData = savedRecord.attendanceData[rowKey];
                      
                      if (rowData) {
                          row.querySelectorAll('.attend-input').forEach((input, cIdx) => {
                              if (rowData.inputs && rowData.inputs[cIdx] !== undefined) {
                                  input.value = rowData.inputs[cIdx];
                              }
                          });
                          row.querySelector('.remarks-input').value = rowData.remarks || '';
                      }
                  });
              }

              // Load summary data (only the editable fields)
              if (savedRecord.summaryData) {
                  if (savedRecord.summaryData['sum-late-m']) document.getElementById('sum-late-m').value = savedRecord.summaryData['sum-late-m'];
                  if (savedRecord.summaryData['sum-late-f']) document.getElementById('sum-late-f').value = savedRecord.summaryData['sum-late-f'];
                  if (savedRecord.summaryData['sum-late-total']) document.getElementById('sum-late-total').value = savedRecord.summaryData['sum-late-total'];
              }

              // Load header/footer data
              if (savedRecord.headerData) {
                   document.getElementById('schoolId').value = savedRecord.headerData.schoolId || '304144';
                   document.getElementById('schoolYear').value = savedRecord.headerData.schoolYear || '2025-2026';
                   document.getElementById('schoolName').value = savedRecord.headerData.schoolName || 'Cagayan de Oro National High School';
                   document.getElementById('adviserName').value = savedRecord.headerData.adviserName || ' Name of Teacher';
                   document.getElementById('principalName').value = savedRecord.headerData.principalName || 'Name of Principal';
                   document.getElementById('reportQuarter').value = savedRecord.headerData.quarter || '1'; // Load Quarter
                   // We don't load section, grade, or month, as they were used to find the record
              }

          } catch (e) {
              console.error("Failed to load saved attendance data:", e);
              localStorage.removeItem(key); // Clear bad data
          }
      }
      // --- End of new load logic ---


      // attach validated input listeners for attendance inputs
      table.querySelectorAll(".attend-input").forEach(input => {
        // remove previous listeners safely by cloning (ensures duplicates won't stack in some hot-reload scenarios)
        const clone = input.cloneNode(true);
        input.parentNode.replaceChild(clone, input);
        clone.addEventListener("input", handleAttendInput);
      });

      // remarks inputs should trigger recalc as well for drop/transfer detection
      table.querySelectorAll(".remarks-input").forEach(input => {
        input.addEventListener("input", updateAllCalculations);
      });

      document.getElementById('loader').style.display = 'none';
      updateAllCalculations();
    };

    const updateAllCalculations = () => {
      // find rows
      const maleRows = Array.from(table.querySelectorAll('tr[data-gender="M"]'));
      const femaleRows = Array.from(table.querySelectorAll('tr[data-gender="F"]'));
      const dayTotals = { male: Array(schoolDays.length).fill(0), female: Array(schoolDays.length).fill(0), combined: Array(schoolDays.length).fill(0) };
      let grandTotals = { male: { absent: 0, tardy: 0, present: 0 }, female: { absent: 0, tardy: 0, present: 0 }};

      const processRows = (rows, genderKey) => {
        rows.forEach(row => {
          let absentCount = 0, tardyCount = 0;
          row.querySelectorAll('.attend-input').forEach((input, dayIndex) => {
            const value = (input.value || '').toString().trim().toUpperCase();
            if (value === 'X' || value === 'E') {
              absentCount++; grandTotals[genderKey].absent++;
            } else {
              // treat blank or other as present for counting daily totals (but we validate inputs elsewhere).
              if (value !== '') {
                // value might be 'T' or other accepted code
              }
              dayTotals[genderKey][dayIndex]++; dayTotals.combined[dayIndex]++; grandTotals[genderKey].present++;
              if (value === 'T') { tardyCount++; grandTotals[genderKey].tardy++; }
            }
          });
          const absentEl = row.querySelector('.absent-total');
          const tardyEl = row.querySelector('.tardy-total');
          if (absentEl) absentEl.textContent = absentCount;
          if (tardyEl) tardyEl.textContent = tardyCount;
        });
      };

      processRows(maleRows, 'male');
      processRows(femaleRows, 'female');

      const maleTotalRow = table.querySelector('.male-total'), femaleTotalRow = table.querySelector('.female-total'), combinedTotalRow = table.querySelector('.combined-total');
      if (maleTotalRow) dayTotals.male.forEach((total, i) => maleTotalRow.querySelectorAll('.day-total')[i].textContent = total);
      if (femaleTotalRow) dayTotals.female.forEach((total, i) => femaleTotalRow.querySelectorAll('.day-total')[i].textContent = total);
      if (combinedTotalRow) dayTotals.combined.forEach((total, i) => combinedTotalRow.querySelectorAll('.day-total')[i].textContent = total);

      if (maleTotalRow) {
        maleTotalRow.children[maleTotalRow.children.length - 3].textContent = grandTotals.male.absent;
        maleTotalRow.children[maleTotalRow.children.length - 2].textContent = grandTotals.male.tardy;
      }
      if (femaleTotalRow) {
        femaleTotalRow.children[femaleTotalRow.children.length - 3].textContent = grandTotals.female.absent;
        femaleTotalRow.children[femaleTotalRow.children.length - 2].textContent = grandTotals.female.tardy;
      }

      const combinedAbsent = grandTotals.male.absent + grandTotals.female.absent;
      const combinedTardy = grandTotals.male.tardy + grandTotals.female.tardy;
      if (combinedTotalRow) {
        combinedTotalRow.children[combinedTotalRow.children.length - 3].textContent = combinedAbsent;
        combinedTotalRow.children[combinedTotalRow.children.length - 2].textContent = combinedTardy;
      }

      const numMale = maleRows.length;
      const numFemale = femaleRows.length;
      document.getElementById('sum-reg-m').value = numMale;
      document.getElementById('sum-reg-f').value = numFemale;
      document.getElementById('sum-reg-total').value = numMale + numFemale;

      // average daily attendance (present counts / days)
      const avgMale = (grandTotals.male.present / (schoolDays.length || 1)) || 0;
      const avgFemale = (grandTotals.female.present / (schoolDays.length || 1)) || 0;
      document.getElementById('sum-avg-m').value = avgMale.toFixed(2);
      document.getElementById('sum-avg-f').value = avgFemale.toFixed(2);
      document.getElementById('sum-avg-total').value = (avgMale + avgFemale).toFixed(2);

      // percentage of attendance - guard divide by zero
      document.getElementById('sum-att-perc-m').value = (( (avgMale / (numMale || 1)) * 100) || 0).toFixed(2) + '%';
      document.getElementById('sum-att-perc-f').value = (( (avgFemale / (numFemale || 1)) * 100) || 0).toFixed(2) + '%';
      document.getElementById('sum-att-perc-total').value = (((avgMale + avgFemale) / ((numMale + numFemale) || 1)) * 100 || 0).toFixed(2) + '%';

      // enrolment fields mirror registered learners
      document.getElementById('sum-jun-m').value = numMale;
      document.getElementById('sum-jun-f').value = numFemale;
      document.getElementById('sum-jun-total').value = numMale + numFemale;

      // Count dropped / transferred using simple keyword parsing of remarks
      let dropM = 0, dropF = 0, toutM = 0, toutF = 0, tinM = 0, tinF = 0;
      table.querySelectorAll('tr[data-gender]').forEach(row => {
        const gender = row.getAttribute('data-gender');
        const rInput = row.querySelector('.remarks-input');
        if (!rInput) return;
        const remark = (rInput.value || '').toString().trim().toLowerCase();
        if (!remark) return;
        if (remark.includes('drop') || remark.includes('dropped')) {
          if (gender === 'M') dropM++; else dropF++;
        }
        if (remark.includes('transfer out') || remark.includes('transferred out') || remark.includes('transfered out')) {
          if (gender === 'M') toutM++; else toutF++;
        }
        if (remark.includes('transfer in') || remark.includes('transferred in') || remark.includes('transfered in')) {
          if (gender === 'M') tinM++; else tinF++;
        }
      });

      document.getElementById('sum-drop-m').value = dropM;
      document.getElementById('sum-drop-f').value = dropF;
      document.getElementById('sum-drop-total').value = dropM + dropF;

      document.getElementById('sum-tout-m').value = toutM;
      document.getElementById('sum-tout-f').value = toutF;
      document.getElementById('sum-tout-total').value = toutM + toutF;

      document.getElementById('sum-tin-m').value = tinM;
      document.getElementById('sum-tin-f').value = tinF;
      document.getElementById('sum-tin-total').value = tinM + tinF;
    };


    // --- NEW: Save and History Functions ---

    /**
     * Saves the current attendance data to localStorage.
     */
    function saveAttendance() {
        const month = monthSelector.value;
        if (!month) {
            Swal.fire('No Month', 'Please select a month before saving.', 'warning');
            return;
        }

        const section = document.getElementById('section').value;
        const key = `sf2_${section}_${month}`;
        
        let attendanceData = {};
        document.querySelectorAll('#attendanceTable tr[data-gender]').forEach((row, rIdx) => {
            const studentName = row.querySelector('.student-name').textContent;
            const rowKey = `${rIdx}_${studentName}`; // Use index + name for a more stable key
            attendanceData[rowKey] = {
                inputs: [],
                remarks: row.querySelector('.remarks-input').value
            };
            row.querySelectorAll('.attend-input').forEach(input => {
                attendanceData[rowKey].inputs.push(input.value);
            });
        });

        const summaryData = {};
        // Only save the user-editable ones
        summaryData['sum-late-m'] = document.getElementById('sum-late-m').value;
        summaryData['sum-late-f'] = document.getElementById('sum-late-f').value;
        summaryData['sum-late-total'] = document.getElementById('sum-late-total').value;


        const headerData = {
            schoolId: document.getElementById('schoolId').value,
            schoolYear: document.getElementById('schoolYear').value,
            gradeLevel: document.getElementById('gradeLevel').value,
            section: document.getElementById('section').value,
            quarter: document.getElementById('reportQuarter').value, // Save Quarter
            schoolName: document.getElementById('schoolName').value,
            adviserName: document.getElementById('adviserName').value,
            principalName: document.getElementById('principalName').value
        };

        const savedRecord = {
            month: month,
            section: section,
            grade: document.getElementById('gradeLevel').value,
            quarter: document.getElementById('reportQuarter').value, // Save Quarter
            timestamp: new Date().toISOString(),
            attendanceData,
            summaryData,
            headerData
        };

        localStorage.setItem(key, JSON.stringify(savedRecord));
        
        updateHistoryList(); // Refresh the history panel

        Swal.fire({
          icon: 'success',
          title: 'Saved!',
          text: `Attendance for ${section} (${month}) has been saved locally.`,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 3000
        });
    }

    /**
     * Scans localStorage for saved records and populates the history panel.
     */
    function updateHistoryList() {
        const container = document.getElementById('historyContainer');
        const placeholder = document.getElementById('historyPlaceholder');
        container.innerHTML = ''; // Clear existing
        
        let records = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('sf2_')) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data && data.month && data.section) {
                        records.push(data);
                    }
                } catch (e) { /* ignore bad data */ }
            }
        }

        // Sort by month, descending
        records.sort((a, b) => (b.month || '').localeCompare(a.month || ''));

        if (records.length === 0) {
            container.appendChild(placeholder); // Show placeholder if empty
            return;
        }

        records.forEach(record => {
            const el = document.createElement('div');
            el.className = 'p-3 border rounded-lg bg-slate-50 hover:bg-slate-100 group';
            
            const monthName = new Date(record.month + '-02').toLocaleString('default', { month: 'long', year: 'numeric' });

            el.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-semibold text-sm text-blue-700">${monthName}</div>
                        <div class="text-xs text-slate-600">Q${record.quarter || '1'} | ${record.section} (${record.grade})</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button title="Load this record" class="load-history-btn text-blue-600 hover:text-blue-800" data-key="sf2_${record.section}_${record.month}">
                            <i class="fa-solid fa-upload"></i>
                        </button>
                        <button title="Delete this record" class="delete-history-btn text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity" data-key="sf2_${record.section}_${record.month}">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(el);
        });

        // Add event listeners for new buttons
        container.querySelectorAll('.load-history-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const key = e.currentTarget.getAttribute('data-key');
                const record = JSON.parse(localStorage.getItem(key));
                if (record) {
                    // Set the selectors to trigger the load
                    document.getElementById('section').value = record.section;
                    document.getElementById('gradeLevel').value = record.grade;
                    document.getElementById('reportQuarter').value = record.quarter || '1'; // Load Quarter
                    document.getElementById('reportMonth').value = record.month;
                    // Manually trigger the table build (which will now load the data)
                    buildTable();
                    Swal.fire({
                      icon: 'info',
                      title: 'Loaded',
                      text: `Loaded saved data for ${record.section} (${record.month}).`,
                      toast: true,
                      position: 'top-end',
                      showConfirmButton: false,
                      timer: 3000
                    });
                }
            });
        });

        container.querySelectorAll('.delete-history-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const key = e.currentTarget.getAttribute('data-key');
                Swal.fire({
                    title: 'Are you sure?',
                    text: "This saved record will be permanently deleted.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.removeItem(key);
                        updateHistoryList(); // Refresh the list
                        Swal.fire('Deleted!', 'The record has been deleted.', 'success');
                    }
                })
            });
        });
    }

    // --- End of new functions ---


    // Rebuild when month changes
    monthSelector.addEventListener("change", buildTable);

    // Export button kept as original flow, with loader visibility
    document.getElementById("exportExcelBtn").addEventListener("click", async () => {
      document.getElementById('loader').style.display = 'block';
      const wb = new ExcelJS.Workbook();
      const ws = wb.addWorksheet('SF2', { pageSetup: { paperSize: 9, orientation: 'landscape' } });

      const border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
      const centerAlign = { vertical: 'middle', horizontal: 'center', wrapText: true };
      const leftAlign = { vertical: 'middle', horizontal: 'left', wrapText: true };
      const rightAlign = { vertical: 'middle', horizontal: 'right' };

      const totalDays = schoolDays.length;
      const dateColsStart = 3;
      const dateColsEnd = dateColsStart + totalDays - 1;
      const totalsEndCol = dateColsEnd + 2;
      const remarksCol = totalsEndCol + 1;

      // top title
      ws.mergeCells(1, 1, 1, remarksCol); ws.getCell(1,1).value = "School Form 2 (SF2) Daily Attendance Report of Learners";
      ws.getCell(1,1).font = { bold: true, size: 12 }; ws.getCell(1,1).alignment = centerAlign; ws.getRow(1).height = 20;

      ws.mergeCells(3, 1, 3, remarksCol); ws.getCell(3,1).value = `(This replaces Form 1, Form 2 & STS Form 4 - Absenteeism and Dropout Profile)`;
      ws.getCell(3,1).font = { italic: true, size: 8 }; ws.getCell(3,1).alignment = centerAlign;

      const monthName = new Date(monthSelector.value + '-02').toLocaleString('default', { month: 'long' });
      
      // --- MODIFIED Header values to match new layout ---
      const infoRow = ws.getRow(5);
      infoRow.getCell(2).value = 'School Name'; ws.mergeCells('C5:E5'); infoRow.getCell(3).value = document.getElementById('schoolName').value;
      infoRow.getCell(6).value = 'School ID'; infoRow.getCell(7).value = document.getElementById('schoolId').value;
      infoRow.getCell(11).value = 'School Year'; infoRow.getCell(12).value = document.getElementById('schoolYear').value;

      const infoRow2 = ws.getRow(6);
      infoRow2.getCell(2).value = 'Section'; infoRow2.getCell(3).value = document.getElementById('section').value;
      infoRow2.getCell(6).value = 'Grade Level'; infoRow2.getCell(7).value = document.getElementById('gradeLevel').value;
      
      // Also add Quarter to Excel export
      const quarterVal = document.getElementById('reportQuarter').value;
      infoRow2.getCell(9).value = 'Quarter'; infoRow2.getCell(10).value = `Quarter ${quarterVal}`;
      
      infoRow2.getCell(12).value = 'For the Month of'; ws.mergeCells('M6:O6'); infoRow2.getCell(13).value = monthName;
      // --- End of header mods ---


      // date headers
      const dateHeaderRow1 = ws.getRow(8); const dateHeaderRow2 = ws.getRow(9);
      ws.mergeCells('A8:A9'); ws.getCell('A8').value = '#';
      ws.mergeCells('B8:B9'); ws.getCell('B8').value = "LEARNER'S NAME\n(Last Name, First Name)";
      schoolDays.forEach((day, i) => { dateHeaderRow1.getCell(dateColsStart + i).value = day.getDate(); });
      const dayNames = ["M", "T", "W", "TH", "F"];
      schoolDays.forEach((d, i) => { dateHeaderRow2.getCell(dateColsStart + i).value = dayNames[d.getDay()-1] });
      ws.mergeCells(8, totalsEndCol-1, 8, totalsEndCol); ws.getCell(8, totalsEndCol-1).value = 'Total for the Month';
      ws.getCell(9, totalsEndCol-1).value = 'ABSENT'; ws.getCell(9, totalsEndCol).value = 'TARDY';
      ws.mergeCells(8, remarksCol, 9, remarksCol); ws.getCell(8, remarksCol).value = "REMARKS (If DROPPED OUT, state reason, please refer to legend number 2. If TRANSFERRED IN/OUT, write the name of School.)";
      [dateHeaderRow1, dateHeaderRow2].forEach(row => row.eachCell({ includeEmpty: true }, c => { c.font = {bold: true, size: 8}; c.alignment = centerAlign; c.border = border; }));

      let currentRowNum = 10;
      const populateExcelRows = (htmlRows, isTotalRow = false) => {
        htmlRows.forEach(row => {
          const excelRow = ws.getRow(currentRowNum);
          const cells = Array.from(row.children);
          if (isTotalRow) {
              ws.mergeCells(currentRowNum, 1, currentRowNum, 2);
              excelRow.getCell(1).value = cells[0].textContent;
              excelRow.getCell(1).font = {bold: true}; excelRow.getCell(1).alignment = rightAlign;
              cells.slice(1).forEach((cell, i) => {
                const excelCell = excelRow.getCell(dateColsStart + i);
                excelCell.value = isNaN(cell.textContent) ? cell.textContent : Number(cell.textContent);
                excelCell.alignment = centerAlign;
              });
          } else {
              excelRow.getCell(1).value = parseInt(cells[0].textContent);
              excelRow.getCell(2).value = cells[1].textContent;
              excelRow.getCell(2).alignment = leftAlign;
              cells.slice(2).forEach((cell, i) => {
                const cellValue = cell.querySelector('input')?.value ?? cell.textContent;
                const excelCell = excelRow.getCell(dateColsStart + i);
                excelCell.value = isNaN(cellValue) ? cellValue : Number(cellValue);
                excelCell.alignment = (i >= totalDays) ? centerAlign : (cell.querySelector('input') ? centerAlign : leftAlign);
              });
          }
          excelRow.eachCell({ includeEmpty: true }, c => { c.border = border; c.font = { size: 9 } });
          excelRow.height = 20;
          currentRowNum++;
        });
      };
      
      populateExcelRows(Array.from(table.querySelectorAll('tr[data-gender="M"]')));
      populateExcelRows(Array.from(table.querySelectorAll('.male-total')), true);
      populateExcelRows(Array.from(table.querySelectorAll('tr[data-gender="F"]')));
      populateExcelRows(Array.from(table.querySelectorAll('.female-total')), true);
      populateExcelRows(Array.from(table.querySelectorAll('.combined-total')), true);
      
      // (Original summary/signature logic unchanged...)
      currentRowNum += 1;
      const guideRow = ws.getRow(currentRowNum);
      ws.mergeCells(currentRowNum, 1, currentRowNum+4, 2);
      guideRow.getCell(1).value = "GUIDELINES:\n1. The attendance shall be checked daily.\n2. Dates shall be written in the columns.\n3. To compute the total number of present days, all blank cells shall be counted.\n4. To compute the total number of absent days, count the cells with (X) or (E).\n5. To compute the total number of tardy days, count the cells with (T).";
      guideRow.getCell(1).alignment = { vertical: 'top', horizontal: 'left', wrapText: true };
      guideRow.getCell(1).font = { size: 8 };

      const summaryHeader = ws.getRow(currentRowNum);
      ws.mergeCells(currentRowNum, 3, currentRowNum, 6); summaryHeader.getCell(3).value = "Month: " + monthName;
      ws.mergeCells(currentRowNum, 7, currentRowNum, 10); summaryHeader.getCell(7).value = "No. of Days of Classes: " + totalDays;
      summaryHeader.getCell(3).font = { bold: true }; summaryHeader.getCell(7).font = { bold: true };
      
      currentRowNum++;
      const summaryTblHeader = ws.getRow(currentRowNum);
      ws.mergeCells(currentRowNum, 3, currentRowNum, 6); summaryTblHeader.getCell(3).value = "SUMMARY";
      summaryTblHeader.getCell(7).value = "M"; summaryTblHeader.getCell(8).value = "F"; summaryTblHeader.getCell(9).value = "TOTAL";
      [summaryTblHeader.getCell(3), summaryTblHeader.getCell(7), summaryTblHeader.getCell(8), summaryTblHeader.getCell(9)].forEach(c => {
        c.font = { bold: true }; c.alignment = centerAlign; c.border = border;
      });

      const summaryRows = [
        { label: "Enrolment (end of month)", ids: ['sum-jun-m', 'sum-jun-f', 'sum-jun-total'] },
        { label: "Late enrollees during the month", ids: ['sum-late-m', 'sum-late-f', 'sum-late-total'] },
        { label: "Registered learners as of end of month", ids: ['sum-reg-m', 'sum-reg-f', 'sum-reg-total'] },
        { label: "Percentage of Enrollment", ids: ['sum-perc-m', 'sum-perc-f', 'sum-perc-total'] },
        { label: "Average Daily Attendance", ids: ['sum-avg-m', 'sum-avg-f', 'sum-avg-total'] },
        { label: "Percentage of Attendance", ids: ['sum-att-perc-m', 'sum-att-perc-f', 'sum-att-perc-total'] },
        { label: "Number of Dropped out", ids: ['sum-drop-m', 'sum-drop-f', 'sum-drop-total'] },
        { label: "Number of Transferred out", ids: ['sum-tout-m', 'sum-tout-f', 'sum-tout-total'] },
        { label: "Number of Transferred in", ids: ['sum-tin-m', 'sum-tin-f', 'sum-tin-total'] },
      ];

      summaryRows.forEach(item => {
        currentRowNum++;
        const row = ws.getRow(currentRowNum);
        ws.mergeCells(currentRowNum, 3, currentRowNum, 6);
        row.getCell(3).value = item.label; row.getCell(3).alignment = leftAlign;
        row.getCell(7).value = document.getElementById(item.ids[0]).value;
        row.getCell(8).value = document.getElementById(item.ids[1]).value;
        row.getCell(9).value = document.getElementById(item.ids[2]).value;
        [row.getCell(3), row.getCell(7), row.getCell(8), row.getCell(9)].forEach(c => { c.border = border; });
      });

      currentRowNum += 2;
      ws.mergeCells(currentRowNum, 1, currentRowNum, remarksCol);
      ws.getCell(currentRowNum, 1).value = "I hereby certify that the foregoing data are true and correct.";
      ws.getCell(currentRowNum, 1).alignment = { vertical: 'middle', horizontal: 'center' };

      currentRowNum += 2;
      ws.mergeCells(currentRowNum, 3, currentRowNum, 7);
      ws.getCell(currentRowNum, 3).value = document.getElementById('adviserName').value;
      ws.getCell(currentRowNum, 3).alignment = centerAlign; ws.getCell(currentRowNum, 3).font = { bold: true };
      
      ws.mergeCells(currentRowNum, 10, currentRowNum, 14);
      ws.getCell(currentRowNum, 10).value = document.getElementById('principalName').value;
      ws.getCell(currentRowNum, 10).alignment = centerAlign; ws.getCell(currentRowNum, 10).font = { bold: true };

      currentRowNum++;
      ws.mergeCells(currentRowNum, 3, currentRowNum, 7);
      ws.getCell(currentRowNum, 3).value = "(Signature of Adviser over Printed Name)";
      ws.getCell(currentRowNum, 3).alignment = centerAlign; ws.getCell(currentRowNum, 3).font = { size: 8 };

      ws.mergeCells(currentRowNum, 10, currentRowNum, 14);
      ws.getCell(currentRowNum, 10).value = "(Signature of School Head over Printed Name)";
      ws.getCell(currentRowNum, 10).alignment = centerAlign; ws.getCell(currentRowNum, 10).font = { size: 8 };

      // Set column widths
      ws.getColumn(1).width = 5; ws.getColumn(2).width = 35;
      for (let i = dateColsStart; i <= remarksCol; i++) { ws.getColumn(i).width = (i === remarksCol) ? 35 : 6; }

      // --- Download file ---
      const buffer = await wb.xlsx.writeBuffer();
      const section = document.getElementById("section").value;
      const fileName = `SF2_Attendance_${section}_${monthName}.xlsx`;
      saveAs(new Blob([buffer]), fileName);
      document.getElementById('loader').style.display = 'none';
    });

    // --- NEW: Event Listeners for new buttons ---
    
    // Save Button (links to new function)
    document.getElementById("saveBtn").addEventListener("click", saveAttendance);
    
    // Print Button
    document.getElementById("printBtn").addEventListener("click", () => {
        window.print();
    });

    // Initial build & history load on page ready
    document.addEventListener('DOMContentLoaded', () => {
         buildTable();
         updateHistoryList();
    });

  </script>
</body>
</html>