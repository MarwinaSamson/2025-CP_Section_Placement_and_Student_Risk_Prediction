<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adviser Dashboard — ZNHS WEST</title>
  {% load static %}

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f4f6f8; color:#111827; }
    main { margin-left: 240px; padding: 28px; transition: margin-left 180ms ease; }
    @media (max-width:860px) { main { margin-left: 72px; padding:18px } }

    .container { max-width: 1100px; margin: 0 auto; }
    .alert-close { cursor: pointer; }

    .badge-probation { background:#b91c1c; color:white; padding:4px 8px; border-radius:9999px; font-size:12px; font-weight:600; }
    .badge-atrisk { background:#f97316; color:white; padding:4px 8px; border-radius:9999px; font-size:12px; font-weight:600; }
    .badge-ok { background:#10b981; color:white; padding:4px 8px; border-radius:9999px; font-size:12px; font-weight:600; }

    .interv-card { border: 1px solid #e6e9ee; border-radius: 8px; background: #fff; padding: 12px; }
    .update-improved { border-left: 4px solid #10b981; background: #ecfdf5; }
    .update-nochange { border-left: 4px solid #f97316; background: #fff7ed; }
    .update-worsened { border-left: 4px solid #b91c1c; background: #fff1f2; }

    .status-badge-improved { background:#ecfdf5; border:1px solid #10b981; color:#065f46; padding:6px 8px; border-radius:6px; font-weight:600; font-size:12px; }
    .status-badge-nochange { background:#fff7ed; border:1px solid #f97316; color:#7c2d12; padding:6px 8px; border-radius:6px; font-weight:600; font-size:12px; }
    .status-badge-worsened { background:#fff1f2; border:1px solid #b91c1c; color:#721c24; padding:6px 8px; border-radius:6px; font-weight:600; font-size:12px; }

    .card-improved { border: 2px solid #10b981 !important; box-shadow: 0 1px 0 rgba(16,185,129,0.08); }
    .modal-inner { max-height: calc(100vh - 120px); overflow-y: auto; padding-right: 6px; }
    .inline-create { border:1px dashed #e6e9ee; padding:12px; border-radius:8px; background:#fff; margin-top:12px; }
  </style>
</head>
<body>
  <div id="sidebar-root">
    {% include 'teacher/adviser/sidebar.html' %}
  </div>

  <main>
    <div class="container">
      {% if not has_advisory_class %}
        <!-- No Advisory Class Message -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
          <i class="fa-solid fa-triangle-exclamation text-yellow-600 text-4xl mb-3"></i>
          <h2 class="text-xl font-bold text-gray-800 mb-2">No Advisory Class Assigned</h2>
          <p class="text-gray-600">{{ error_message|default:"You do not have an assigned advisory class. Please contact the administrator." }}</p>
        </div>
      {% else %}
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Adviser Dashboard</h1>
            <p id="greeting-date" class="text-gray-600 mt-1">Good afternoon, {{ teacher.last_name }}</p>
          </div>

          <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
              <label for="quarter" class="text-sm font-bold text-gray-700 whitespace-nowrap">Quarter</label>
              <select id="quarter" class="w-36 rounded-lg border border-gray-300 bg-white py-2 px-3 text-gray-700 shadow-sm
                                          focus:border-rose-600 focus:ring focus:ring-rose-100 transition-all cursor-pointer font-medium">
                {% for q in quarters %}
                  <option value="{{ q }}" {% if q == current_quarter %}selected{% endif %}>Quarter {{ q|slice:"1:" }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="flex items-center gap-3">
              <div class="text-right leading-tight">
                <p class="text-sm font-semibold text-gray-800">{{ teacher_full_name }}</p>
                <p class="text-xs text-gray-500">{{ teacher_position }}</p>
              </div>
              <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-rose-600 shadow-sm">
                {% if teacher_photo %}
                  <img src="{{ teacher_photo }}" alt="Profile"
                    onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'bg-rose-600 text-white w-full h-full flex items-center justify-center font-semibold\'>{{ teacher_initials }}</div>'">
                {% else %}
                  <div class="bg-rose-600 text-white w-full h-full flex items-center justify-center font-semibold">{{ teacher_initials }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Program / Section -->
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 flex items-center justify-between">
          <div class="text-sm text-gray-700 space-y-1">
            <div><span class="text-gray-600">Program:</span> <span class="text-rose-600 font-semibold">{{ program }}</span></div>
            <div><span class="text-gray-600">Section:</span> <span class="text-rose-600 font-semibold">{{ section_name }}</span></div>
          </div>
          <div class="text-right text-sm text-gray-500">
            <div>Today</div>
            <div id="today-compact" class="mt-1 text-xs text-gray-400"></div>
          </div>
        </div>

        <!-- Warning -->
        {% if probation_count > 0 %}
        <div id="warning" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 flex items-center justify-between">
          <div class="flex items-center gap-3 text-sm text-yellow-800">
            <span class="w-8 h-8 rounded-full bg-yellow-100 grid place-items-center text-yellow-700"><i class="fa-solid fa-triangle-exclamation"></i></span>
            <div>
              <div class="font-semibold">Warning: <span class="font-normal">The following requires immediate attention.</span></div>
              <div class="text-sm text-yellow-800/80">• {{ probation_count }} student{{ probation_count|pluralize:" is,s are" }} under probation</div>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <button id="dismiss-warning" class="text-yellow-800/80 hover:text-yellow-900 alert-close" title="Dismiss">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
        </div>
        {% endif %}

        <!-- Stats -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-blue-100 border border-blue-200 rounded-xl p-5 text-center">
            <div class="text-blue-700 font-semibold mb-2">Total Learners</div>
            <h3 class="text-3xl font-bold text-gray-800">{{ total_students }}</h3>
            <p class="mt-2 text-sm text-gray-700">
              <span class="text-blue-600 font-semibold">{{ male_count }} Male</span> 
              <span class="text-pink-600 font-semibold ml-3">{{ female_count }} Female</span>
            </p>
          </div>

          <div class="bg-rose-100 border border-rose-200 rounded-xl p-5 text-center">
            <div class="text-rose-700 font-semibold mb-2">Students at Risk</div>
            <h3 class="text-3xl font-bold text-gray-800">{{ probation_count }}</h3>
            <p class="mt-2 text-sm text-gray-700">On Probation</p>
          </div>

          <div class="bg-green-100 border border-green-200 rounded-xl p-5 text-center">
            <div class="text-green-700 font-semibold mb-2">Transfer-in</div>
            <h3 class="text-3xl font-bold text-gray-800">{{ transfer_in_count }}</h3>
            <p class="mt-2 text-sm text-gray-700">Students</p>
          </div>

          <div class="bg-yellow-100 border border-yellow-200 rounded-xl p-5 text-center">
            <div class="text-yellow-700 font-semibold mb-2">Repeaters</div>
            <h3 class="text-3xl font-bold text-gray-800">{{ repeaters_count }}</h3>
            <p class="mt-2 text-sm text-gray-700">Students</p>
          </div>
        </div>

        <!-- Student Categories -->
        <div class="mb-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">Student Categories</h2>

          <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                  <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Male</th>
                  <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Female</th>
                  <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                  <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100" id="category-rows">
                <!-- Probation row -->
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap flex items-center gap-3">
                    <span class="w-3 h-3 rounded-full bg-red-500 inline-block"></span>
                    <div class="text-sm text-gray-700">On Probation</div>
                  </td>
                  <td class="px-6 py-4 text-center text-sm text-gray-600">{{ probation_male }}</td>
                  <td class="px-6 py-4 text-center text-sm text-gray-600">{{ probation_female }}</td>
                  <td class="px-6 py-4 text-center">
                    <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium bg-rose-600 text-white rounded-full">{{ probation_count }}</span>
                  </td>
                  <td class="px-6 py-4 text-center">
                    <button id="view-probation" class="inline-flex items-center gap-2 px-3 py-1 text-sm bg-white border border-gray-200 rounded-lg hover:shadow-sm view-btn" data-category="On Probation">
                      <i class="fa-solid fa-eye text-xs text-rose-600"></i> View
                    </button>
                  </td>
                </tr>

                <!-- Improved row (JavaScript managed) -->
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap flex items-center gap-3">
                    <span class="w-3 h-3 rounded-full bg-green-500 inline-block"></span>
                    <div class="text-sm text-gray-700">Improved</div>
                  </td>
                  <td class="px-6 py-4 text-center text-sm text-gray-600" id="improved-male-count">0</td>
                  <td class="px-6 py-4 text-center text-sm text-gray-600" id="improved-female-count">0</td>
                  <td class="px-6 py-4 text-center" id="improved-total-count">
                    <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium bg-green-600 text-white rounded-full">0</span>
                  </td>
                  <td class="px-6 py-4 text-center">
                    <button id="view-improved" class="inline-flex items-center gap-2 px-3 py-1 text-sm bg-white border border-gray-200 rounded-lg hover:shadow-sm" data-category="Improved">
                      <i class="fa-solid fa-leaf text-xs text-green-600"></i> View
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Details panel -->
          <div id="student-details" class="mt-4 rounded-lg border border-gray-200 bg-white/80 p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Student Details</h3>
            <div id="student-details-body" class="rounded-md bg-gray-50 p-6 text-left text-sm text-gray-500">
              Select a category above to view students. (Click "Create Intervention" in a student's row to open the inline create form here.)
            </div>
          </div>

          <!-- Interventions list -->
          <div id="interventions-list-section" class="mt-6">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Interventions (Saved)</h3>
            <div id="interventionsList" class="space-y-3"></div>
          </div>
        </div>
      {% endif %}
    </div>
  </main>

  <!-- Delete Confirmation Modal -->
  <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-60">
    <div class="bg-white rounded-lg p-5 w-full max-w-md mx-4">
      <div class="flex items-start justify-between gap-4">
        <div class="flex items-start gap-3">
          <span class="w-10 h-10 rounded-full bg-rose-100 grid place-items-center text-rose-600"><i class="fa-solid fa-trash"></i></span>
          <div>
            <h4 id="deleteModalTitle" class="text-lg font-semibold text-gray-800">Delete Intervention</h4>
            <p id="deleteModalSubtitle" class="text-sm text-gray-600 mt-1">Are you sure to delete this Intervention? This action cannot be undone.</p>
          </div>
        </div>
        <button id="closeDeleteModalBtn" class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mt-4 text-sm text-gray-700">
        <div id="deleteModalBody" class="mb-3">Confirm deletion</div>
        <div class="text-xs text-gray-500">Intervention for: <span id="deleteStudentName" class="font-medium"></span></div>
      </div>

      <div class="mt-5 flex justify-end gap-2">
        <button id="cancelDeleteBtn" class="px-3 py-2 rounded border">Cancel</button>
        <button id="confirmDeleteBtn" class="px-3 py-2 rounded bg-rose-600 text-white flex items-center gap-2">
          <span id="confirmDeleteLabel">Delete</span>
          <svg id="deleteSpinner" class="w-4 h-4 animate-spin hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2v4M12 18v4M4.9 4.9l2.8 2.8M16.3 16.3l2.8 2.8M2 12h4M18 12h4M4.9 19.1l2.8-2.8M16.3 7.7l2.8-2.8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed right-4 bottom-6 hidden z-50"></div>

  <script>
    // Pass Django data to JavaScript
    const PROBATION_STUDENTS = {{ probation_students|safe|default:"[]" }};
    
    /********** Dates & helpers **********/
    (function showDates(){
      const dateEl = document.getElementById('greeting-date');
      const compact = document.getElementById('today-compact');
      const now = new Date();
      const greetingOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      if (dateEl) {
        const hour = now.getHours();
        let greeting = 'Good morning';
        if (hour >= 12 && hour < 18) greeting = 'Good afternoon';
        else if (hour >= 18) greeting = 'Good evening';
        dateEl.textContent = greeting + ', {{ teacher.last_name }}';
      }
      if (compact) compact.textContent = now.toLocaleDateString('en-US');
    })();

    document.addEventListener('click', function(e){
      if (e.target.closest('#dismiss-warning')) {
        const el = document.getElementById('warning'); if (el) el.style.display = 'none';
      }
    });

    function escapeHtml(str){ if (!str && str !== 0) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    /********** Storage helpers **********/
    const STORAGE_KEY = 'adviser_interventions_v2';

    function loadInterventions() {
      try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; }
      catch(e){ return []; }
    }
    function saveInterventions(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

    /********** CRUD helpers **********/
    function pushIntervention(plan) {
      const list = loadInterventions();
      list.unshift(plan);
      saveInterventions(list);
      renderInterventions();
      updateImprovedCountsDisplay();
      showToast('Intervention saved');
    }
    function deleteIntervention(id) {
      let list = loadInterventions();
      list = list.filter(x => x.id !== id);
      saveInterventions(list);
      renderInterventions();
      updateImprovedCountsDisplay();
      showToast('Intervention removed');
    }

    function addUpdateToPlan(planId, updateObj) {
      const list = loadInterventions();
      const plan = list.find(p => p.id === planId);
      if (!plan) return false;
      plan.updates = plan.updates || [];
      plan.updates.unshift(updateObj);
      plan.last_status = updateObj.status;
      saveInterventions(list);
      renderInterventions();
      updateImprovedCountsDisplay();
      return true;
    }

    /********** Render interventions **********/
    function renderInterventions() {
      const container = document.getElementById('interventionsList');
      container.innerHTML = '';
      const quarter = document.getElementById('quarter').value;
      const list = loadInterventions().filter(p => (p.quarter || 'Q1') === quarter);
      if (!list.length) { container.innerHTML = '<div class="text-sm text-gray-500">No saved interventions for this quarter.</div>'; updateImprovedCountsDisplay(); return; }

      list.forEach(plan => {
        const wrapper = document.createElement('div');
        const isImproved = plan.last_status === 'Improved';
        wrapper.className = 'interv-card flex flex-col gap-3';
        if (isImproved) wrapper.classList.add('card-improved');

        let statusBadge = '';
        if (plan.last_status === 'Improved') statusBadge = `<div class="status-badge-improved">${escapeHtml(plan.last_status)}</div>`;
        else if (plan.last_status === 'No change') statusBadge = `<div class="status-badge-nochange">${escapeHtml(plan.last_status)}</div>`;
        else if (plan.last_status === 'Worsened') statusBadge = `<div class="status-badge-worsened">${escapeHtml(plan.last_status)}</div>`;

        wrapper.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1">
              <div class="flex items-center justify-between gap-3">
                <div class="text-sm font-semibold text-gray-800">${escapeHtml(plan.student)}</div>
                ${statusBadge}
              </div>
              <div class="text-xs text-gray-500 mt-1">Start: ${escapeHtml(plan.start_date || '—')} • Review: ${escapeHtml(plan.review_date || '—')} • Quarter: ${escapeHtml(plan.quarter || 'Q1')}</div>
              <div class="mt-2 text-sm text-gray-700"><strong>Reason:</strong> ${escapeHtml(plan.reason || '')}</div>
              <div class="mt-1 text-xs text-gray-600"><strong>Goal:</strong> ${escapeHtml(plan.smart_goal || '')}</div>
            </div>

            <div class="flex flex-col items-end gap-2">
              <div class="flex gap-2">
                <button class="btn-view inline-flex items-center gap-2 px-3 py-1 text-sm rounded border bg-white view-plan-btn" data-id="${plan.id}">
                  <i class="fa-solid fa-eye text-rose-600"></i> View
                </button>
                <button class="btn-update inline-flex items-center gap-2 px-3 py-1 text-sm rounded border bg-white update-plan-btn" data-id="${plan.id}">
                  <i class="fa-solid fa-arrow-up-right-dots text-rose-600"></i> Update
                </button>
                <button class="btn-delete inline-flex items-center gap-2 px-3 py-1 text-sm rounded border text-rose-600 bg-white delete-plan-btn" data-id="${plan.id}">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="mt-2 text-xs text-gray-700"><strong>Updates:</strong>
            <div id="updates-${plan.id}" class="mt-2">${renderUpdatesForCard(plan)}</div>
          </div>

          <div id="update-form-${plan.id}" class="mt-3 hidden border-t pt-3">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-end">
              <div>
                <label class="text-xs text-gray-600">Date</label>
                <input class="update-date border rounded px-2 py-1 w-full" type="date" />
              </div>
              <div>
                <label class="text-xs text-gray-600">Status</label>
                <select class="update-status border rounded px-2 py-1 w-full">
                  <option value="Improved">Improved</option>
                  <option value="No change">No change</option>
                  <option value="Worsened">Worsened</option>
                </select>
              </div>
              <div class="text-right">
                <label class="text-xs text-gray-600">&nbsp;</label>
                <div class="flex justify-end gap-2">
                  <button class="cancel-update inline-flex px-3 py-1 rounded border text-xs">Cancel</button>
                  <button class="save-update inline-flex px-3 py-1 rounded bg-rose-600 text-white text-xs">Save</button>
                </div>
              </div>
            </div>
            <div class="mt-2">
              <label class="text-xs text-gray-600">Notes</label>
              <textarea class="update-note w-full border rounded px-2 py-1 text-sm" rows="2" placeholder="Short note about progress or actions taken"></textarea>
            </div>
          </div>
        `;

        container.appendChild(wrapper);
      });

      attachInterventionCardHandlers();
      updateImprovedCountsDisplay();
    }

    function renderUpdatesForCard(plan) {
      if (!plan.updates || !plan.updates.length) return '<div class="text-xs text-gray-500">No updates yet.</div>';
      return plan.updates.map(u => {
        let cls = 'update-nochange';
        if (u.status === 'Improved') cls = 'update-improved';
        else if (u.status === 'Worsened') cls = 'update-worsened';
        return `<div class="${cls} border rounded p-2 mb-2 flex items-start justify-between gap-2">
                  <div>
                    <div class="text-xs text-gray-600">${escapeHtml(u.date)} • <span class="font-semibold">${escapeHtml(u.status)}</span></div>
                    <div class="text-sm text-gray-700 mt-1">${escapeHtml(u.note||'')}</div>
                  </div>
                  <div>
                    <button class="remove-update text-xs px-2 py-1 rounded border" data-plan="${escapeHtml(plan.id)}" data-update="${escapeHtml(u.id)}">Remove</button>
                  </div>
                </div>`;
      }).join('');
    }

    function attachInterventionCardHandlers() {
      const container = document.getElementById('interventionsList');
      
      container.querySelectorAll('.btn-view').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          const plan = loadInterventions().find(p => p.id === id);
          if (plan) showPlanInDetailsPanel(plan);
        };
      });

      container.querySelectorAll('.btn-update').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          const formEl = document.getElementById(`update-form-${id}`);
          if (!formEl) return;
          formEl.classList.toggle('hidden');
          const dateInput = formEl.querySelector('.update-date');
          const statusSel = formEl.querySelector('.update-status');
          const note = formEl.querySelector('.update-note');
          dateInput.value = new Date().toISOString().slice(0,10);
          statusSel.value = 'Improved';
          note.value = '';
        };
      });

      container.querySelectorAll('.cancel-update').forEach(btn => {
        btn.onclick = (e) => {
          const formEl = btn.closest('[id^="update-form-"]');
          if (formEl) formEl.classList.add('hidden');
        };
      });

      container.querySelectorAll('.save-update').forEach(btn => {
        btn.onclick = (e) => {
          const formEl = btn.closest('[id^="update-form-"]');
          if (!formEl) return;
          const id = formEl.id.replace('update-form-','');
          const date = formEl.querySelector('.update-date').value || new Date().toISOString().slice(0,10);
          const status = formEl.querySelector('.update-status').value || 'No change';
          const note = formEl.querySelector('.update-note').value.trim();
          const updateObj = { id: 'u_' + Date.now(), date, status, note };
          const ok = addUpdateToPlan(id, updateObj);
          if (ok) {
            showToast('Update saved');
            formEl.classList.add('hidden');
          } else {
            showToast('Failed to save update', true);
          }
        };
      });

      container.querySelectorAll('.btn-delete').forEach(btn => {
        btn.onclick = (e) => {
          const id = btn.dataset.id;
          const plan = loadInterventions().find(p => p.id === id);
          openDeleteModal(id, plan ? plan.student : '');
        };
      });

      container.querySelectorAll('.remove-update').forEach(btn => {
        btn.onclick = (e) => {
          const planId = btn.dataset.plan;
          const updateId = btn.dataset.update;
          if (!confirm('Remove this update?')) return;
          const list = loadInterventions();
          const plan = list.find(p => p.id === planId);
          if (!plan) return;
          plan.updates = (plan.updates || []).filter(u => u.id !== updateId);
          plan.last_status = (plan.updates && plan.updates[0]) ? plan.updates[0].status : '';
          saveInterventions(list);
          renderInterventions();
          showToast('Update removed');
        };
      });
    }

    /********** Student details panel **********/
    function showPlanInDetailsPanel(plan) {
      const body = document.getElementById('student-details-body');

      const updatesHtml = (plan.updates && plan.updates.length) ? plan.updates.map(u => {
        let cls = 'update-nochange';
        if (u.status === 'Improved') cls = 'update-improved';
        else if (u.status === 'Worsened') cls = 'update-worsened';
        return `<div class="${cls} border rounded p-2 mb-2">
                  <div class="text-xs text-gray-600">${escapeHtml(u.date)} • <strong>${escapeHtml(u.status)}</strong></div>
                  <div class="text-sm text-gray-700 mt-1">${escapeHtml(u.note||'')}</div>
                </div>`;
      }).join('') : '<div class="text-xs text-gray-500">No updates yet.</div>';

      body.innerHTML = `
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold text-gray-800">${escapeHtml(plan.student)}</div>
              <div class="text-xs text-gray-500 mt-1">Start: ${escapeHtml(plan.start_date||'—')} • Review: ${escapeHtml(plan.review_date||'—')} • Quarter: ${escapeHtml(plan.quarter||'Q1')}</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-gray-700">Last status: ${escapeHtml(plan.last_status || '—')}</div>
              <div class="mt-2 text-xs text-gray-600">Saved: ${new Date(plan.created_at).toLocaleString()}</div>
            </div>
          </div>

          <div class="border rounded p-3 bg-white">
            <div class="text-sm"><strong>Reason:</strong> ${escapeHtml(plan.reason || '')}</div>
            <div class="text-sm mt-2"><strong>SMART goal:</strong> ${escapeHtml(plan.smart_goal || '')}</div>
          </div>

          <div>
            <div class="text-sm font-medium mb-2">Updates</div>
            <div>${updatesHtml}</div>
          </div>
        </div>
      `;
      document.getElementById('student-details').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function openInlineCreate(prefill = {}) {
      const body = document.getElementById('student-details-body');
      body.innerHTML = `
        <div class="inline-create">
          <div class="flex items-between justify-between">
            <div class="text-sm font-semibold">Create Intervention for <span class="text-rose-600">${escapeHtml(prefill.student||'')}</span></div>
            <div>
              <button id="cancelInlineCreate" class="px-2 py-1 border rounded text-xs">Cancel</button>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2">
            <div>
              <label class="text-xs text-gray-600">Student</label>
              <input id="inline_studentName" class="w-full border rounded px-2 py-1" value="${escapeHtml(prefill.student||'')}" />
            </div>
            <div>
              <label class="text-xs text-gray-600">Start Date</label>
              <input id="inline_startDate" type="date" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="text-xs text-gray-600">Review Date</label>
              <input id="inline_reviewDate" type="date" class="w-full border rounded px-2 py-1" />
            </div>
          </div>

          <div class="mt-2">
            <label class="text-xs text-gray-600">Reason / Concern</label>
            <textarea id="inline_reason" class="w-full border rounded px-2 py-1" rows="2">${escapeHtml(prefill.reason||'')}</textarea>
          </div>

          <div class="mt-2">
            <label class="text-xs text-gray-600">SMART Goal</label>
            <textarea id="inline_smartGoal" class="w-full border rounded px-2 py-1" rows="2">${escapeHtml(prefill.smart_goal||'')}</textarea>
          </div>

          <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-gray-600">Quarter</label>
              <select id="inline_quarter" class="w-full border rounded px-2 py-1">
                <option value="Q1">Quarter 1</option>
                <option value="Q2">Quarter 2</option>
                <option value="Q3">Quarter 3</option>
                <option value="Q4">Quarter 4</option>
              </select>
            </div>
            <div class="text-right">
              <label class="text-xs text-gray-600">&nbsp;</label>
              <div>
                <button id="saveInlineCreate" class="px-3 py-1 rounded bg-rose-600 text-white text-sm">Save Intervention</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('cancelInlineCreate').onclick = () => {
        document.getElementById('student-details-body').innerHTML = 'Select a category above to view students.';
      };
      document.getElementById('saveInlineCreate').onclick = () => {
        const student = document.getElementById('inline_studentName').value.trim();
        if (!student) { showToast('Student name required', true); return; }
        const plan = {
          id: 'i_' + Date.now(),
          student,
          start_date: document.getElementById('inline_startDate').value || '',
          review_date: document.getElementById('inline_reviewDate').value || '',
          reason: document.getElementById('inline_reason').value || '',
          smart_goal: document.getElementById('inline_smartGoal').value || '',
          actions: [],
          updates: [],
          last_status: '',
          created_at: new Date().toISOString(),
          quarter: document.getElementById('inline_quarter').value || document.getElementById('quarter').value
        };
        pushIntervention(plan);
        document.getElementById('student-details-body').innerHTML = '<div class="text-sm text-gray-500">Intervention saved and listed below.</div>';
      };
      document.getElementById('student-details').scrollIntoView({ behavior: 'smooth' });
    }

    /********** Probation popup **********/
    const viewProbationBtn = document.getElementById('view-probation');
    if (viewProbationBtn) {
      viewProbationBtn.addEventListener('click', function(){
        const body = document.getElementById('student-details-body');
        
        // Use static sample data
        const student = {
          full_name: 'Uchiha, Itachi',
          photo: null,
          subjects: {
            'English': 68,
            'Mathematics': 72,
            'Science': 80,
            'Filipino': 69,
            'Araling Panlipunan': 75,
            'Edukasyon sa Pagpapakatao': 78,
            'MAPEH': 82
          }
        };
        
        function subjectStatus(grade) {
          if (grade == null || isNaN(grade)) return { label: 'No grade', cls: 'badge-atrisk', level: 'atrisk' };
          if (grade < 70) return { label: 'Probation', cls: 'badge-probation', level: 'probation' };
          if (grade < 75) return { label: 'At Risk', cls: 'badge-atrisk', level: 'atrisk' };
          return { label: 'OK', cls: 'badge-ok', level: 'ok' };
        }
        
        function subjectRowHtml(name, grade) {
          const st = subjectStatus(grade);
          if (!st || st.level === 'ok') return '';
          return `
            <div class="px-4 py-2 border-b bg-white grid grid-cols-[1fr_96px_120px] items-center">
              <div class="text-sm text-left text-gray-700">${escapeHtml(name)}</div>
              <div class="text-sm text-center text-gray-700">${grade!=null?escapeHtml(String(grade)):'—'}</div>
              <div class="text-sm text-center"><span class="${st.cls}">${st.label}</span></div>
            </div>
          `;
        }
        
        const subjectRowsArr = Object.entries(student.subjects).map(([name, grade]) => subjectRowHtml(name, grade)).filter(Boolean).join('');
        const subjectsHtml = subjectRowsArr.length ? subjectRowsArr : '<div class="p-4 text-sm text-gray-600">No subjects currently marked as At Risk or Probation.</div>';

        body.innerHTML = `
          <div class="text-left space-y-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full overflow-hidden border border-rose-600">
                  <div class="w-full h-full bg-rose-600 flex items-center justify-center text-white font-semibold">IU</div>
                </div>
                <div>
                  <div class="text-sm font-semibold text-gray-800">${escapeHtml(student.full_name)}</div>
                  <div class="text-xs text-gray-500">Grade 11 - Section {{ section_name }}</div>
                </div>
              </div>
              <div class="text-right">
                <div class="text-xs text-rose-600 font-semibold">On Probation</div>
                <div class="text-xs text-gray-500 mt-2">Reason: Low grades</div>
              </div>
            </div>

            <div class="text-sm text-gray-700">
              <strong>Notes:</strong> Student is on academic probation for the current grading period. See subjects below for per-subject status.
            </div>

            <div class="mt-3 border rounded-lg overflow-hidden bg-white">
              <div class="px-4 py-3 border-b bg-gray-50 grid grid-cols-[1fr_96px_120px] items-center">
                <div class="font-medium text-gray-700">Subject</div>
                <div class="text-sm text-gray-500 text-center">Grade</div>
                <div class="text-sm text-gray-500 text-center">Status</div>
              </div>
              ${subjectsHtml}
            </div>

            <div class="flex gap-2 mt-3">
              <button id="viewProfileBtn" class="inline-flex items-center gap-2 px-3 py-1 rounded-md bg-rose-600 text-white text-sm">
                <i class="fa-solid fa-user"></i> View Profile
              </button>
              <button id="createInterventionBtn" class="inline-flex items-center gap-2 px-3 py-1 rounded-md border border-gray-200 bg-white text-sm">
                <i class="fa-solid fa-plus"></i> Create Intervention
              </button>
            </div>
          </div>
        `;

        document.getElementById('createInterventionBtn').addEventListener('click', function() {
          openInlineCreate({
            student: student.full_name,
            reason: 'Low grades in English and Filipino',
            smart_goal: 'Improve grades to at least 75 within 8 weeks'
          });
        });

        document.getElementById('viewProfileBtn').addEventListener('click', function() {
          window.location.href = '{% url "teacher:adviser-masterlist" %}';
        });

        document.getElementById('student-details').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
    }

    /********** Category: Improved **********/
    const viewImprovedBtn = document.getElementById('view-improved');
    if (viewImprovedBtn) {
      viewImprovedBtn.addEventListener('click', function(){
        const body = document.getElementById('student-details-body');
        const quarter = document.getElementById('quarter').value;
        const list = loadInterventions().filter(p => (p.quarter || 'Q1') === quarter && p.last_status === 'Improved');
        if (!list.length) {
          body.innerHTML = `<div class="p-4 text-sm text-gray-600">No improved students yet for ${quarter}.</div>`;
          document.getElementById('student-details').scrollIntoView({ behavior: 'smooth' });
          return;
        }
        const rows = list.map(p => {
          return `<div class="p-3 border-b flex items-center justify-between">
                    <div>
                      <div class="text-sm font-semibold">${escapeHtml(p.student)}</div>
                      <div class="text-xs text-gray-500">Plan: ${escapeHtml(p.smart_goal||'—')}</div>
                    </div>
                    <div class="text-right">
                      <div class="status-badge-improved">${escapeHtml(p.last_status)}</div>
                      <div class="mt-2">
                        <button class="px-2 py-1 text-xs rounded border view-plan-btn" data-id="${escapeHtml(p.id)}">View</button>
                      </div>
                    </div>
                  </div>`;
        }).join('');
        body.innerHTML = `<div class="text-left space-y-2">${rows}</div>`;
        body.querySelectorAll('.view-plan-btn').forEach(b => {
          b.onclick = () => {
            const id = b.dataset.id;
            const plan = loadInterventions().find(x => x.id === id);
            if (plan) showPlanInDetailsPanel(plan);
          };
        });
        document.getElementById('student-details').scrollIntoView({ behavior: 'smooth' });
      });
    }

    /********** Delete modal **********/
    const deleteModal = document.getElementById('deleteConfirmModal');
    const closeDeleteModalBtn = document.getElementById('closeDeleteModalBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const deleteStudentNameEl = document.getElementById('deleteStudentName');
    const deleteSpinner = document.getElementById('deleteSpinner');
    const confirmDeleteLabel = document.getElementById('confirmDeleteLabel');
    let _pendingDeleteId = null;

    function openDeleteModal(id, studentName) {
      _pendingDeleteId = id;
      deleteStudentNameEl.textContent = studentName || '—';
      confirmDeleteLabel.textContent = 'Delete';
      deleteSpinner.classList.add('hidden');
      deleteModal.classList.remove('hidden');
      deleteModal.style.display = 'flex';
      cancelDeleteBtn.focus();
    }

    function closeDeleteModal() {
      _pendingDeleteId = null;
      deleteModal.classList.add('hidden');
      deleteModal.style.display = 'none';
    }

    closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
    cancelDeleteBtn.addEventListener('click', closeDeleteModal);
    deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) closeDeleteModal(); });

    confirmDeleteBtn.addEventListener('click', async function () {
      if (!_pendingDeleteId) return closeDeleteModal();
      confirmDeleteLabel.textContent = 'Deleting...';
      deleteSpinner.classList.remove('hidden');
      confirmDeleteBtn.setAttribute('disabled','disabled');
      cancelDeleteBtn.setAttribute('disabled','disabled');
      try {
        await new Promise(res => setTimeout(res, 300));
        deleteIntervention(_pendingDeleteId);
      } catch (err) {
        console.error(err);
        showToast('Failed to delete intervention', true);
      } finally {
        confirmDeleteBtn.removeAttribute('disabled');
        cancelDeleteBtn.removeAttribute('disabled');
        deleteSpinner.classList.add('hidden');
        closeDeleteModal();
      }
    });

    /********** Update improved counts **********/
    function updateImprovedCountsDisplay() {
      const quarter = document.getElementById('quarter').value;
      const list = loadInterventions().filter(p => (p.quarter || 'Q1') === quarter && p.last_status === 'Improved');
      const total = list.length;
      document.getElementById('improved-male-count').textContent = total;
      document.getElementById('improved-female-count').textContent = 0;
      document.getElementById('improved-total-count').innerHTML = `<span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium bg-green-600 text-white rounded-full">${total}</span>`;
    }

    /********** Toast **********/
    function showToast(msg, isError = false) {
      const t = document.getElementById('toast');
      t.innerHTML = `<div class="px-4 py-2 rounded-md ${isError ? 'bg-rose-600 text-white' : 'bg-gray-800 text-white'}">${escapeHtml(msg)}</div>`;
      t.classList.remove('hidden');
      setTimeout(()=> { t.classList.add('hidden'); t.innerHTML = ''; }, 2600);
    }

    /********** Quarter change **********/
    const quarterSelect = document.getElementById('quarter');
    if (quarterSelect) {
      quarterSelect.addEventListener('change', function(){
        renderInterventions();
      });
    }

    // Initial render
    renderInterventions();
    updateImprovedCountsDisplay();
  </script>
</body>
</html>
</body>
</html>